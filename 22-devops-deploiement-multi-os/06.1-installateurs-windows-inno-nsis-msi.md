üîù Retour au [Sommaire](/SOMMAIRE.md)

# 22.6.1 Installateurs Windows (Inno Setup, NSIS, MSI)

## Introduction aux installateurs Windows

Quand vous d√©veloppez une application FreePascal/Lazarus pour Windows, vous devez fournir √† vos utilisateurs un moyen simple et professionnel de l'installer. Un bon installateur ne se contente pas de copier des fichiers : il g√®re les d√©pendances, cr√©e des raccourcis, configure le syst√®me, et facilite la d√©sinstallation.

### Pourquoi cr√©er un installateur professionnel ?

**Sans installateur :**
- L'utilisateur doit extraire manuellement un fichier ZIP
- Pas de raccourcis sur le bureau ou dans le menu D√©marrer
- Pas d'inscription dans "Programmes et fonctionnalit√©s"
- Aucune gestion des d√©pendances
- D√©sinstallation manuelle et incompl√®te
- Image non professionnelle

**Avec un installateur :**
- Installation en quelques clics
- Configuration automatique du syst√®me
- Raccourcis cr√©√©s automatiquement
- D√©sinstallation propre et compl√®te
- Gestion des mises √† jour
- Confiance des utilisateurs renforc√©e

### Les trois principaux outils d'installation Windows

**1. Inno Setup**
- **Gratuit et open source**
- Simple √† utiliser avec un script texte
- Tr√®s populaire dans la communaut√© FreePascal
- Excellent pour les petites et moyennes applications
- Support Unicode et multi-langues

**2. NSIS (Nullsoft Scriptable Install System)**
- **Gratuit et open source**
- Plus complexe mais tr√®s puissant
- Personnalisation extr√™me possible
- Interface graphique personnalisable
- Populaire pour les logiciels complexes

**3. WiX (Windows Installer XML) / MSI**
- Format standard Microsoft
- Obligatoire pour certaines entreprises
- Int√©gration Windows optimale
- Plus complexe √† ma√Ætriser
- Support des mises √† jour sophistiqu√©es

Dans ce tutoriel, nous allons explorer les trois solutions avec des exemples concrets pour applications FreePascal/Lazarus.

## Inno Setup : La solution recommand√©e

### Pourquoi choisir Inno Setup ?

Inno Setup est le choix id√©al pour la plupart des d√©veloppeurs FreePascal/Lazarus car :

- **Simplicit√©** : Script texte facile √† comprendre et modifier
- **Puissance** : G√®re 99% des besoins d'installation
- **Gratuit** : Compl√®tement libre et open source
- **Documentation** : Excellente documentation en anglais
- **Communaut√©** : Large communaut√© FreePascal/Delphi
- **Taille** : Installateurs compacts
- **Support** : Unicode, 64-bit, Windows 11

### Installation d'Inno Setup

**√âtape 1 : T√©l√©chargement**

Rendez-vous sur : [https://jrsoftware.org/isdl.php](https://jrsoftware.org/isdl.php)

T√©l√©chargez **Inno Setup** (version avec QuickStart Pack recommand√©e).

**√âtape 2 : Installation**

1. Ex√©cutez l'installateur t√©l√©charg√©
2. Acceptez la licence
3. Choisissez le dossier d'installation
4. S√©lectionnez les composants (tout par d√©faut)
5. Cliquez sur "Installer"

**√âtape 3 : V√©rification**

Lancez **Inno Setup Compiler** depuis le menu D√©marrer.

### Structure d'un script Inno Setup

Un script Inno Setup (extension `.iss`) est organis√© en sections :

```ini
[Setup]           ; Configuration g√©n√©rale
[Languages]       ; Langues support√©es
[Tasks]           ; T√¢ches optionnelles
[Files]           ; Fichiers √† installer
[Icons]           ; Raccourcis √† cr√©er
[Registry]        ; Cl√©s de registre
[Run]             ; Programmes √† lancer apr√®s installation
[Code]            ; Code Pascal personnalis√© (optionnel)
```

### Premier installateur : Application simple

Supposons que vous avez d√©velopp√© une application appel√©e "MonAppli" avec FreePascal/Lazarus.

**Structure de votre projet :**
```
MonAppli/
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îî‚îÄ‚îÄ MonAppli.exe
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ licence.txt
‚îÇ   ‚îî‚îÄ‚îÄ lisez-moi.txt
‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îî‚îÄ‚îÄ icone.ico
‚îî‚îÄ‚îÄ setup/
    ‚îî‚îÄ‚îÄ MonAppli.iss
```

**Fichier : `setup/MonAppli.iss`**

```ini
; Script Inno Setup pour MonAppli
; Application FreePascal/Lazarus

[Setup]
; Informations de base
AppName=MonAppli  
AppVersion=1.0.0  
AppPublisher=Votre Nom ou Soci√©t√©  
AppPublisherURL=https://www.votresite.com  
AppSupportURL=https://www.votresite.com/support  
AppUpdatesURL=https://www.votresite.com/updates

; Identifiant unique (g√©n√©rez-en un nouveau pour chaque application)
AppId={{12345678-1234-1234-1234-123456789ABC}

; Dossier d'installation par d√©faut
DefaultDirName={autopf}\MonAppli  
DefaultGroupName=MonAppli

; Fichier de sortie
OutputDir=..\installer  
OutputBaseFilename=MonAppli-Setup-1.0.0

; Compression
Compression=lzma2/max  
SolidCompression=yes

; Ic√¥ne de l'installateur
SetupIconFile=..\images\icone.ico

; Privil√®ges (admin pour installation dans Program Files)
PrivilegesRequired=admin

; Architecture (64-bit recommand√©)
ArchitecturesInstallIn64BitMode=x64

; Style visuel moderne
WizardStyle=modern

[Languages]
Name: "french"; MessagesFile: "compiler:Languages\French.isl"  
Name: "english"; MessagesFile: "compiler:Default.isl"

[Tasks]
Name: "desktopicon"; Description: "Cr√©er un raccourci sur le bureau"; GroupDescription: "Raccourcis suppl√©mentaires:"

[Files]
; Ex√©cutable principal
Source: "..\bin\MonAppli.exe"; DestDir: "{app}"; Flags: ignoreversion

; Documentation
Source: "..\docs\licence.txt"; DestDir: "{app}\docs"; Flags: ignoreversion  
Source: "..\docs\lisez-moi.txt"; DestDir: "{app}\docs"; Flags: ignoreversion

; D√©pendances (DLLs si n√©cessaires)
; Source: "..\bin\library.dll"; DestDir: "{app}"; Flags: ignoreversion

[Icons]
; Raccourci dans le menu D√©marrer
Name: "{group}\MonAppli"; Filename: "{app}\MonAppli.exe"  
Name: "{group}\Documentation"; Filename: "{app}\docs\lisez-moi.txt"  
Name: "{group}\D√©sinstaller MonAppli"; Filename: "{uninstallexe}"

; Raccourci sur le bureau (optionnel)
Name: "{autodesktop}\MonAppli"; Filename: "{app}\MonAppli.exe"; Tasks: desktopicon

[Run]
; Lancer l'application apr√®s installation (optionnel)
Filename: "{app}\MonAppli.exe"; Description: "Lancer MonAppli"; Flags: nowait postinstall skipifsilent
```

**Explication des sections importantes :**

**Section [Setup] :**
- `AppName` : Nom de votre application
- `AppVersion` : Version (format X.Y.Z)
- `AppId` : GUID unique (g√©n√©rez-le avec Ctrl+Shift+G dans Inno Setup)
- `DefaultDirName` : Dossier d'installation (`{autopf}` = Program Files)
- `OutputBaseFilename` : Nom du fichier installateur g√©n√©r√©
- `ArchitecturesInstallIn64BitMode` : Force l'installation 64-bit

**Section [Files] :**
- `Source` : Chemin du fichier source (relatif au script)
- `DestDir` : Destination dans le dossier d'installation
- `{app}` : Variable qui pointe vers le dossier d'installation choisi

**Section [Icons] :**
- Cr√©e les raccourcis dans le menu D√©marrer et sur le bureau
- `{group}` : Dossier dans le menu D√©marrer
- `{autodesktop}` : Bureau de l'utilisateur

### Compilation de l'installateur

**M√©thode 1 : Via l'IDE Inno Setup**

1. Ouvrez `MonAppli.iss` dans Inno Setup Compiler
2. Menu **Build** ‚Üí **Compile**
3. L'installateur est cr√©√© dans le dossier `installer/`

**M√©thode 2 : En ligne de commande**

```cmd
"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" MonAppli.iss
```

**R√©sultat :**

Vous obtenez un fichier `MonAppli-Setup-1.0.0.exe` pr√™t √† √™tre distribu√© !

### Assistant de configuration (Wizard)

Inno Setup propose un assistant pour g√©n√©rer rapidement un script de base.

**Lancement :**

1. Ouvrez Inno Setup Compiler
2. Menu **File** ‚Üí **New**
3. S√©lectionnez **Create a new script file using the Script Wizard**
4. Suivez les √©tapes :

**√âtape 1 : Application Information**
- Nom de l'application
- Version
- √âditeur
- Site web

**√âtape 2 : Application Folder**
- Dossier d'installation par d√©faut
- Autoriser l'utilisateur √† changer le dossier

**√âtape 3 : Application Files**
- Ex√©cutable principal
- Fichiers suppl√©mentaires
- Autoriser l'utilisateur √† lancer l'application apr√®s installation

**√âtape 4 : Shortcuts**
- Menu D√©marrer
- Bureau
- Quick Launch (d√©pr√©ci√©, pas recommand√©)

**√âtape 5 : Documentation**
- Licence
- Fichier README
- Affichage avant ou apr√®s installation

**√âtape 6 : Install Mode**
- Installation pour tous les utilisateurs (n√©cessite admin)
- Installation pour l'utilisateur actuel uniquement

**√âtape 7 : Languages**
- S√©lectionner les langues support√©es

**√âtape 8 : Output**
- Nom de l'installateur
- Ic√¥ne personnalis√©e
- Mot de passe (optionnel)

L'assistant g√©n√®re un script `.iss` de base que vous pouvez personnaliser.

### Installation de d√©pendances (.NET, VC++ Redistributable)

Beaucoup d'applications n√©cessitent des d√©pendances syst√®me.

**Exemple : Installer .NET Framework si absent**

```ini
[Setup]
; ... autres param√®tres ...

[Files]
; L'installateur .NET
Source: "dependencies\dotnetfx.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Run]
; V√©rifier si .NET est install√©, sinon l'installer
Filename: "{tmp}\dotnetfx.exe"; Parameters: "/q /norestart"; StatusMsg: "Installation de .NET Framework..."; Check: NeedsDotNet

[Code]
function NeedsDotNet: Boolean;  
var
  Version: String;
begin
  // V√©rifier si .NET 4.8 est install√©
  Result := not RegQueryStringValue(HKLM, 'SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full', 'Version', Version);
end;
```

**Exemple : Visual C++ Redistributable**

```ini
[Files]
Source: "dependencies\VC_redist.x64.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Run]
Filename: "{tmp}\VC_redist.x64.exe"; Parameters: "/quiet /norestart"; StatusMsg: "Installation de Visual C++ Runtime..."; Check: NeedsVCRedist

[Code]
function NeedsVCRedist: Boolean;  
var
  Version: String;
begin
  // V√©rifier la pr√©sence du runtime
  Result := not RegQueryStringValue(HKLM, 'SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64', 'Version', Version);
end;
```

### Gestion des mises √† jour

**D√©tecter une version existante :**

```ini
[Setup]
; Cr√©er un d√©sinstalleur
Uninstallable=yes  
UninstallDisplayIcon={app}\MonAppli.exe

[Code]
function GetInstalledVersion: String;  
var
  Version: String;
begin
  if RegQueryStringValue(HKLM, 'Software\Microsoft\Windows\CurrentVersion\Uninstall\{AppId}_is1',
                         'DisplayVersion', Version) then
    Result := Version
  else
    Result := '';
end;

function InitializeSetup: Boolean;  
var
  OldVersion: String;
  ResultCode: Integer;
begin
  OldVersion := GetInstalledVersion;

  if OldVersion <> '' then
  begin
    if MsgBox('Une version ' + OldVersion + ' est d√©j√† install√©e. Voulez-vous la mettre √† jour ?',
              mbConfirmation, MB_YESNO) = IDYES then
    begin
      // D√©sinstaller l'ancienne version silencieusement
      Exec(ExpandConstant('{uninstallexe}'), '/SILENT', '', SW_HIDE, ewWaitUntilTerminated, ResultCode);
      Result := True;
    end
    else
      Result := False;
  end
  else
    Result := True;
end;
```

### Personnalisation avanc√©e : Pages personnalis√©es

**Ajouter une page de configuration :**

```ini
[Code]
var
  ConfigPage: TInputQueryWizardPage;
  ServerName: String;
  PortNumber: String;

procedure InitializeWizard;  
begin
  // Cr√©er une page personnalis√©e
  ConfigPage := CreateInputQueryPage(wpSelectDir,
    'Configuration du serveur',
    'Veuillez entrer les informations de connexion',
    'Ces param√®tres seront sauvegard√©s dans le fichier de configuration.');

  // Ajouter des champs de saisie
  ConfigPage.Add('Nom du serveur:', False);
  ConfigPage.Add('Port:', False);

  // Valeurs par d√©faut
  ConfigPage.Values[0] := 'localhost';
  ConfigPage.Values[1] := '5432';
end;

procedure CurStepChanged(CurStep: TSetupStep);  
var
  ConfigFile: String;
  Lines: TArrayOfString;
begin
  if CurStep = ssPostInstall then
  begin
    // R√©cup√©rer les valeurs
    ServerName := ConfigPage.Values[0];
    PortNumber := ConfigPage.Values[1];

    // Cr√©er le fichier de configuration
    ConfigFile := ExpandConstant('{app}\config.ini');
    SetArrayLength(Lines, 2);
    Lines[0] := 'Server=' + ServerName;
    Lines[1] := 'Port=' + PortNumber;
    SaveStringsToFile(ConfigFile, Lines, False);
  end;
end;
```

### Signature num√©rique de l'installateur

Pour que Windows fasse confiance √† votre installateur, signez-le avec un certificat.

**Configuration dans Inno Setup :**

```ini
[Setup]
; Signature num√©rique
SignTool=signtool  
SignedUninstaller=yes
```

**Fichier de configuration du signtool :**

Cr√©ez un fichier `SignTool` dans le dossier Inno Setup avec :

```
signtool=C:\Program Files (x86)\Windows Kits\10\bin\x64\signtool.exe sign /f "C:\chemin\vers\certificat.pfx" /p "motdepasse" /tr http://timestamp.digicert.com /td sha256 /fd sha256 $f
```

**Commande manuelle pour signer :**

```cmd
signtool sign /f certificat.pfx /p motdepasse /tr http://timestamp.digicert.com /td sha256 /fd sha256 MonAppli-Setup.exe
```

### Exemple complet : Application avec base de donn√©es

**Application FreePascal avec SQLite int√©gr√©e**

```ini
[Setup]
AppName=GestionStock  
AppVersion=2.0.1  
AppPublisher=Ma Soci√©t√© SARL  
DefaultDirName={autopf}\GestionStock  
DefaultGroupName=Gestion de Stock  
OutputBaseFilename=GestionStock-Setup-2.0.1  
Compression=lzma2/ultra64  
SolidCompression=yes  
PrivilegesRequired=admin  
ArchitecturesInstallIn64BitMode=x64  
WizardStyle=modern  
SetupIconFile=..\images\app.ico  
LicenseFile=..\docs\licence.rtf  
InfoBeforeFile=..\docs\bienvenue.rtf  
InfoAfterFile=..\docs\instructions.rtf

[Languages]
Name: "french"; MessagesFile: "compiler:Languages\French.isl"

[Tasks]
Name: "desktopicon"; Description: "Cr√©er un raccourci sur le bureau"  
Name: "quicklaunchicon"; Description: "Cr√©er un raccourci dans la barre de lancement rapide"; Flags: unchecked

[Files]
; Ex√©cutable principal
Source: "..\bin\GestionStock.exe"; DestDir: "{app}"; Flags: ignoreversion

; Biblioth√®ques SQLite
Source: "..\bin\sqlite3.dll"; DestDir: "{app}"; Flags: ignoreversion

; Fichiers de configuration
Source: "..\config\default.ini"; DestDir: "{app}\config"; Flags: onlyifdoesntexist

; Base de donn√©es vide
Source: "..\database\template.db"; DestDir: "{app}\database"; DestName: "stock.db"; Flags: onlyifdoesntexist

; Documentation
Source: "..\docs\manuel.pdf"; DestDir: "{app}\docs"; Flags: ignoreversion  
Source: "..\docs\licence.txt"; DestDir: "{app}\docs"; Flags: ignoreversion

; Ressources
Source: "..\resources\*"; DestDir: "{app}\resources"; Flags: ignoreversion recursesubdirs

[Dirs]
; Cr√©er des dossiers avec permissions
Name: "{app}\backups"; Permissions: users-modify  
Name: "{app}\logs"; Permissions: users-modify  
Name: "{app}\exports"; Permissions: users-modify

[Icons]
Name: "{group}\Gestion de Stock"; Filename: "{app}\GestionStock.exe"  
Name: "{group}\Manuel utilisateur"; Filename: "{app}\docs\manuel.pdf"  
Name: "{group}\D√©sinstaller"; Filename: "{uninstallexe}"  
Name: "{autodesktop}\Gestion de Stock"; Filename: "{app}\GestionStock.exe"; Tasks: desktopicon  
Name: "{userappdata}\Microsoft\Internet Explorer\Quick Launch\Gestion de Stock"; Filename: "{app}\GestionStock.exe"; Tasks: quicklaunchicon

[Registry]
; Association de fichiers .gst
Root: HKCR; Subkey: ".gst"; ValueType: string; ValueName: ""; ValueData: "GestionStockFile"; Flags: uninsdeletevalue  
Root: HKCR; Subkey: "GestionStockFile"; ValueType: string; ValueName: ""; ValueData: "Fichier Gestion Stock"; Flags: uninsdeletekey  
Root: HKCR; Subkey: "GestionStockFile\DefaultIcon"; ValueType: string; ValueName: ""; ValueData: "{app}\GestionStock.exe,0"  
Root: HKCR; Subkey: "GestionStockFile\shell\open\command"; ValueType: string; ValueName: ""; ValueData: """{app}\GestionStock.exe"" ""%1"""

; Param√®tres de l'application
Root: HKCU; Subkey: "Software\MaSociete\GestionStock"; ValueType: string; ValueName: "InstallPath"; ValueData: "{app}"; Flags: uninsdeletekey

[Run]
; Lancer l'application apr√®s installation
Filename: "{app}\GestionStock.exe"; Description: "Lancer Gestion de Stock"; Flags: nowait postinstall skipifsilent

[UninstallDelete]
; Supprimer les fichiers cr√©√©s par l'application
Type: filesandordirs; Name: "{app}\logs"  
Type: filesandordirs; Name: "{app}\backups"  
Type: files; Name: "{app}\config\user.ini"

[Code]
// Code Pascal personnalis√©

var
  DataDirPage: TInputDirWizardPage;

procedure InitializeWizard;  
begin
  // Page pour choisir le dossier des donn√©es
  DataDirPage := CreateInputDirPage(wpSelectDir,
    'Dossier des donn√©es',
    'O√π souhaitez-vous stocker les donn√©es de l''application ?',
    'S√©lectionnez le dossier, puis cliquez sur Suivant.',
    False, '');
  DataDirPage.Add('');
  DataDirPage.Values[0] := ExpandConstant('{userdocs}\GestionStock\Data');
end;

function GetDataDir(Param: String): String;  
begin
  Result := DataDirPage.Values[0];
end;

procedure CurStepChanged(CurStep: TSetupStep);  
var
  DataDir: String;
begin
  if CurStep = ssPostInstall then
  begin
    // Cr√©er le dossier des donn√©es
    DataDir := DataDirPage.Values[0];
    ForceDirectories(DataDir);

    // Sauvegarder le chemin dans la configuration
    SaveStringToFile(ExpandConstant('{app}\config\paths.ini'),
                     'DataPath=' + DataDir + #13#10, False);
  end;
end;

// V√©rifier les pr√©requis
function InitializeSetup(): Boolean;  
var
  Version: String;
begin
  // V√©rifier Windows 10 ou sup√©rieur
  if GetWindowsVersion < $0A00 then
  begin
    MsgBox('Cette application n√©cessite Windows 10 ou sup√©rieur.', mbError, MB_OK);
    Result := False;
  end
  else
    Result := True;
end;
```

## NSIS : Installation avanc√©e

### Pr√©sentation de NSIS

NSIS (Nullsoft Scriptable Install System) est une alternative gratuite et puissante √† Inno Setup, offrant encore plus de flexibilit√©.

**Avantages de NSIS :**
- Personnalisation interface graphique compl√®te
- Plugins tr√®s nombreux
- Compression excellente
- Script tr√®s flexible
- Support de fonctionnalit√©s avanc√©es

**Inconv√©nients :**
- Courbe d'apprentissage plus raide
- Syntaxe moins intuitive
- Moins adapt√© aux d√©butants

### Installation de NSIS

**T√©l√©chargement :**

Rendez-vous sur : [https://nsis.sourceforge.io/Download](https://nsis.sourceforge.io/Download)

T√©l√©chargez la derni√®re version stable.

**Installation :**

1. Ex√©cutez l'installateur
2. Acceptez la licence
3. S√©lectionnez les composants (tout par d√©faut)
4. Installation

**Outils utiles :**
- **HM NIS Edit** : √âditeur de script NSIS avec coloration syntaxique
- **NSIS Menu** : Interface graphique pour NSIS

### Structure d'un script NSIS

Un script NSIS (extension `.nsi`) utilise une syntaxe diff√©rente d'Inno Setup :

```nsis
; Directives du compilateur
!include "MUI2.nsh"

; Configuration g√©n√©rale
Name "MonAppli"  
OutFile "MonAppli-Setup.exe"  
InstallDir "$PROGRAMFILES\MonAppli"

; Interface Modern UI
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

; Langues
!insertmacro MUI_LANGUAGE "French"

; Section d'installation
Section "Principal" SecMain
  SetOutPath "$INSTDIR"
  File "MonAppli.exe"
SectionEnd
```

### Exemple complet NSIS pour FreePascal

**Fichier : `MonAppli.nsi`**

```nsis
; ==============================================
; Script NSIS pour application FreePascal
; ==============================================

; Inclure Modern UI
!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"

; ==============================================
; Configuration g√©n√©rale
; ==============================================

; Nom de l'application
!define APPNAME "MonAppli"
!define COMPANYNAME "Ma Soci√©t√©"
!define DESCRIPTION "Application de gestion d√©velopp√©e avec FreePascal"
!define VERSIONMAJOR 1
!define VERSIONMINOR 0
!define VERSIONBUILD 0

; Informations installateur
Name "${APPNAME}"  
Icon "images\app.ico"  
OutFile "installer\${APPNAME}-Setup-${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}.exe"  
InstallDir "$PROGRAMFILES64\${COMPANYNAME}\${APPNAME}"  
InstallDirRegKey HKLM "Software\${COMPANYNAME}\${APPNAME}" "InstallDir"

; Droits administrateur requis
RequestExecutionLevel admin

; Compression
SetCompressor /SOLID lzma  
SetCompressorDictSize 32

; ==============================================
; Interface Modern UI
; ==============================================

; Ic√¥ne
!define MUI_ICON "images\app.ico"
!define MUI_UNICON "images\uninstall.ico"

; Images
!define MUI_HEADERIMAGE
!define MUI_HEADERIMAGE_BITMAP "images\header.bmp"
!define MUI_WELCOMEFINISHPAGE_BITMAP "images\wizard.bmp"

; Pages d'installation
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "docs\licence.txt"
!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES

; Page de fin avec option de lancement
!define MUI_FINISHPAGE_RUN "$INSTDIR\${APPNAME}.exe"
!define MUI_FINISHPAGE_RUN_TEXT "Lancer ${APPNAME}"
!insertmacro MUI_PAGE_FINISH

; Pages de d√©sinstallation
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; Langues
!insertmacro MUI_LANGUAGE "French"

; ==============================================
; Sections d'installation
; ==============================================

Section "!Application principale" SecMain
  SectionIn RO  ; Obligatoire

  SetOutPath "$INSTDIR"

  ; Fichiers principaux
  File "bin\${APPNAME}.exe"
  File "bin\sqlite3.dll"

  ; Configuration
  SetOutPath "$INSTDIR\config"
  File "config\default.ini"

  ; Documentation
  SetOutPath "$INSTDIR\docs"
  File "docs\manuel.pdf"
  File "docs\licence.txt"

  ; Cr√©er le d√©sinstalleur
  WriteUninstaller "$INSTDIR\Uninstall.exe"

  ; Cl√©s de registre
  WriteRegStr HKLM "Software\${COMPANYNAME}\${APPNAME}" "InstallDir" "$INSTDIR"
  WriteRegStr HKLM "Software\${COMPANYNAME}\${APPNAME}" "Version" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"

  ; Ajout dans "Programmes et fonctionnalit√©s"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "$\"$INSTDIR\Uninstall.exe$\""
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "QuietUninstallString" "$\"$INSTDIR\Uninstall.exe$\" /S"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "InstallLocation" "$INSTDIR"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayIcon" "$INSTDIR\${APPNAME}.exe"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "Publisher" "${COMPANYNAME}"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "VersionMajor" ${VERSIONMAJOR}
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "VersionMinor" ${VERSIONMINOR}
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoModify" 1
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoRepair" 1

  ; Calculer la taille
  ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
  IntFmt $0 "0x%08X" $0
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "EstimatedSize" "$0"

SectionEnd

Section "Raccourci Bureau" SecDesktop
  CreateShortcut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\${APPNAME}.exe"
SectionEnd

Section "Menu D√©marrer" SecStartMenu
  CreateDirectory "$SMPROGRAMS\${APPNAME}"
  CreateShortcut "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk" "$INSTDIR\${APPNAME}.exe"
  CreateShortcut "$SMPROGRAMS\${APPNAME}\Manuel.lnk" "$INSTDIR\docs\manuel.pdf"
  CreateShortcut "$SMPROGRAMS\${APPNAME}\D√©sinstaller.lnk" "$INSTDIR\Uninstall.exe"
SectionEnd

; Descriptions des sections
!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
  !insertmacro MUI_DESCRIPTION_TEXT ${SecMain} "Fichiers principaux de ${APPNAME} (requis)"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecDesktop} "Cr√©er un raccourci sur le bureau"
  !insertmacro MUI_DESCRIPTION_TEXT ${SecStartMenu} "Cr√©er un dossier dans le menu D√©marrer"
!insertmacro MUI_FUNCTION_DESCRIPTION_END

; ==============================================
; Section de d√©sinstallation
; ==============================================

Section "Uninstall"
  ; Supprimer les fichiers
  Delete "$INSTDIR\${APPNAME}.exe"
  Delete "$INSTDIR\sqlite3.dll"
  Delete "$INSTDIR\Uninstall.exe"

  ; Supprimer les dossiers
  RMDir /r "$INSTDIR\config"
  RMDir /r "$INSTDIR\docs"
  RMDir "$INSTDIR"

  ; Supprimer les raccourcis
  Delete "$DESKTOP\${APPNAME}.lnk"
  RMDir /r "$SMPROGRAMS\${APPNAME}"

  ; Supprimer les cl√©s de registre
  DeleteRegKey HKLM "Software\${COMPANYNAME}\${APPNAME}"
  DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"

  ; Supprimer le dossier de la soci√©t√© si vide
  RMDir "$PROGRAMFILES64\${COMPANYNAME}"
SectionEnd

; ==============================================
; Fonctions personnalis√©es
; ==============================================

Function .onInit
  ; V√©rifier si d√©j√† install√©
  ReadRegStr $R0 HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString"
  StrCmp $R0 "" done

  MessageBox MB_OKCANCEL|MB_ICONEXCLAMATION \
    "${APPNAME} est d√©j√† install√©. $\n$\nCliquez sur OK pour d√©sinstaller la version pr√©c√©dente ou sur Annuler pour annuler." \
    IDOK uninst
  Abort

uninst:
  ClearErrors
  ExecWait '$R0 _?=$INSTDIR'

  IfErrors no_remove_uninstaller done
  no_remove_uninstaller:

done:  
FunctionEnd
```

### Compilation du script NSIS

**M√©thode 1 : Via l'interface graphique**

1. Faites un clic droit sur le fichier `.nsi`
2. S√©lectionnez "Compile NSIS Script"
3. L'installateur est cr√©√©

**M√©thode 2 : En ligne de commande**

```cmd
"C:\Program Files (x86)\NSIS\makensis.exe" MonAppli.nsi
```

### Plugins NSIS utiles

NSIS dispose d'un √©cosyst√®me de plugins pour √©tendre ses fonctionnalit√©s.

**1. nsProcess** - D√©tecter des processus en cours

```nsis
!include "nsProcess.nsh"

Function .onInit
  ${nsProcess::FindProcess} "MonAppli.exe" $R0
  ${If} $R0 == 0
    MessageBox MB_OK|MB_ICONEXCLAMATION "${APPNAME} est en cours d'ex√©cution. Veuillez le fermer avant de continuer."
    Abort
  ${EndIf}
FunctionEnd
```

**2. nsisFirewall** - Configurer le pare-feu Windows

```nsis
!include "nsisFirewall.nsh"

Section "Principal"
  ; ... installation des fichiers ...

  ; Ajouter une exception au pare-feu
  nsisFirewall::AddAuthorizedApplication "$INSTDIR\${APPNAME}.exe" "${APPNAME}"
SectionEnd
```

**3. INetC** - T√©l√©charger des fichiers depuis Internet

```nsis
!include "INetC.nsh"

Section "T√©l√©charger mise √† jour"
  inetc::get "https://www.example.com/update.zip" "$TEMP\update.zip"
  Pop $0
  ${If} $0 == "OK"
    DetailPrint "T√©l√©chargement r√©ussi"
  ${Else}
    DetailPrint "Erreur: $0"
  ${EndIf}
SectionEnd
```

**4. UAC** - √âl√©vation de privil√®ges

```nsis
!include "UAC.nsh"

Function .onInit
  UAC::RunElevated
  ${Switch} $0
  ${Case} 0
    ${IfThen} $1 = 1 ${|} Quit ${|} ; Si d√©j√† √©lev√©
    ${IfThen} $3 <> 0 ${|} Quit ${|} ; Si erreur
  ${Case} 1223
    MessageBox MB_OK "L'installation n√©cessite les droits administrateur."
    Quit
  ${Default}
    MessageBox MB_OK "Erreur lors de l'√©l√©vation: $0"
    Quit
  ${EndSwitch}
FunctionEnd
```

## Windows Installer (MSI) avec WiX Toolset

### Introduction √† WiX

WiX (Windows Installer XML) est un outil gratuit et open source de Microsoft qui g√©n√®re des fichiers MSI √† partir de XML.

**Avantages du format MSI :**
- Standard Microsoft officiel
- Gestion avanc√©e des mises √† jour
- Support des politiques de groupe (GPO)
- Installation silencieuse native
- Obligatoire dans certains environnements d'entreprise

**Inconv√©nients :**
- Complexit√© √©lev√©e
- Courbe d'apprentissage difficile
- Documentation technique
- Moins flexible qu'Inno Setup ou NSIS

### Installation de WiX Toolset

**Pr√©requis :**
- .NET Framework 3.5 ou sup√©rieur
- Visual Studio (optionnel, mais recommand√©)

**T√©l√©chargement :**

Rendez-vous sur : [https://wixtoolset.org/](https://wixtoolset.org/)

T√©l√©chargez **WiX Toolset** (version 3.x ou 4.x).

**Installation :**

1. Ex√©cutez l'installateur
2. Suivez les instructions
3. Installez l'extension Visual Studio si vous l'utilisez

### Structure d'un projet WiX

Un projet WiX est compos√© de fichiers XML (extension `.wxs`).

**Fichier principal : `Product.wxs`**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <!-- D√©finition du produit -->
  <Product Id="*"
           Name="MonAppli"
           Language="1036"
           Version="1.0.0.0"
           Manufacturer="Ma Soci√©t√©"
           UpgradeCode="12345678-1234-1234-1234-123456789ABC">

    <!-- Package MSI -->
    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="Application FreePascal"
             Comments="D√©velopp√©e avec Lazarus" />

    <!-- Media (fichiers CAB) -->
    <Media Id="1" Cabinet="MonAppli.cab" EmbedCab="yes" />

    <!-- Structure des r√©pertoires -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="MonAppli" />
      </Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="MonAppli"/>
      </Directory>
    </Directory>

    <!-- Composants -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="ABCD1234-5678-90AB-CDEF-123456789ABC">
        <File Id="MonAppliEXE"
              Source="bin\MonAppli.exe"
              KeyPath="yes"
              Checksum="yes">
          <Shortcut Id="ApplicationStartMenuShortcut"
                    Directory="ApplicationProgramsFolder"
                    Name="MonAppli"
                    Description="Application de gestion"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="MonAppli.exe"
                    IconIndex="0"
                    Advertise="yes" />
        </File>
      </Component>
    </DirectoryRef>

    <!-- Raccourci de d√©sinstallation -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="12340000-0000-0000-0000-000000000001">
        <Shortcut Id="UninstallProduct"
                  Name="D√©sinstaller MonAppli"
                  Description="D√©sinstaller MonAppli"
                  Target="[System64Folder]msiexec.exe"
                  Arguments="/x [ProductCode]"/>
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\MaSociete\MonAppli"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Feature (fonctionnalit√©) -->
    <Feature Id="ProductFeature" Title="MonAppli" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>

    <!-- Ic√¥ne dans le panneau de configuration -->
    <Icon Id="MonAppli.exe" SourceFile="bin\MonAppli.exe"/>
    <Property Id="ARPPRODUCTICON" Value="MonAppli.exe" />

  </Product>
</Wix>
```

### Exemple complet WiX pour FreePascal

**Fichier : `MonAppli.wxs`**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="*"
           Name="Gestion de Stock"
           Language="1036"
           Version="2.0.1.0"
           Manufacturer="Ma Soci√©t√© SARL"
           UpgradeCode="87654321-4321-4321-4321-BA9876543210">

    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"
             Description="Logiciel de gestion de stock"
             Manufacturer="Ma Soci√©t√© SARL" />

    <!-- √âviter la r√©installation si m√™me version -->
    <MajorUpgrade DowngradeErrorMessage="Une version plus r√©cente de [ProductName] est d√©j√† install√©e." />

    <!-- Media -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Propri√©t√©s -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPHELPLINK" Value="https://www.masociete.com/support" />
    <Property Id="ARPURLINFOABOUT" Value="https://www.masociete.com" />

    <!-- V√©rifier .NET Framework si n√©cessaire -->
    <PropertyRef Id="NETFRAMEWORK45"/>
    <Condition Message="Cette application n√©cessite .NET Framework 4.5 ou sup√©rieur.">
      <![CDATA[Installed OR NETFRAMEWORK45]]>
    </Condition>

    <!-- Structure des r√©pertoires -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files -->
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="CompanyFolder" Name="Ma Soci√©t√©">
          <Directory Id="INSTALLFOLDER" Name="Gestion de Stock">
            <Directory Id="ConfigFolder" Name="config" />
            <Directory Id="DocsFolder" Name="docs" />
            <Directory Id="DatabaseFolder" Name="database" />
          </Directory>
        </Directory>
      </Directory>

      <!-- Menu D√©marrer -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Gestion de Stock"/>
      </Directory>

      <!-- Bureau -->
      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <!-- Composants principaux -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="11111111-1111-1111-1111-111111111111" Win64="yes">
        <File Id="GestionStockEXE"
              Source="..\bin\GestionStock.exe"
              KeyPath="yes"
              Checksum="yes" />
      </Component>

      <Component Id="SQLiteLibrary" Guid="22222222-2222-2222-2222-222222222222" Win64="yes">
        <File Id="SQLite3DLL"
              Source="..\bin\sqlite3.dll"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Configuration -->
    <DirectoryRef Id="ConfigFolder">
      <Component Id="ConfigFiles" Guid="33333333-3333-3333-3333-333333333333" Win64="yes">
        <File Id="DefaultINI"
              Source="..\config\default.ini"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Documentation -->
    <DirectoryRef Id="DocsFolder">
      <Component Id="Documentation" Guid="44444444-4444-4444-4444-444444444444" Win64="yes">
        <File Id="ManuelPDF"
              Source="..\docs\manuel.pdf"
              KeyPath="yes" />
        <File Id="LicenceTXT"
              Source="..\docs\licence.txt" />
      </Component>
    </DirectoryRef>

    <!-- Base de donn√©es -->
    <DirectoryRef Id="DatabaseFolder">
      <Component Id="DatabaseTemplate" Guid="55555555-5555-5555-5555-555555555555" Win64="yes">
        <File Id="TemplatDB"
              Source="..\database\template.db"
              Name="stock.db"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Raccourcis Menu D√©marrer -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcuts" Guid="66666666-6666-6666-6666-666666666666">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Gestion de Stock"
                  Description="Logiciel de gestion de stock"
                  Target="[INSTALLFOLDER]GestionStock.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="ProductIcon"/>

        <Shortcut Id="ManualStartMenuShortcut"
                  Name="Manuel utilisateur"
                  Description="Documentation compl√®te"
                  Target="[DocsFolder]manuel.pdf"
                  Icon="PDFIcon"/>

        <Shortcut Id="UninstallShortcut"
                  Name="D√©sinstaller"
                  Description="D√©sinstaller Gestion de Stock"
                  Target="[System64Folder]msiexec.exe"
                  Arguments="/x [ProductCode]"/>

        <RemoveFolder Id="CleanApplicationProgramsFolder" On="uninstall"/>

        <RegistryValue Root="HKCU"
                       Key="Software\MaSociete\GestionStock"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Raccourci Bureau (optionnel) -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="77777777-7777-7777-7777-777777777777">
        <Shortcut Id="ApplicationDesktopShortcut"
                  Name="Gestion de Stock"
                  Description="Logiciel de gestion de stock"
                  Target="[INSTALLFOLDER]GestionStock.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="ProductIcon"/>

        <RegistryValue Root="HKCU"
                       Key="Software\MaSociete\GestionStock"
                       Name="desktopshortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Ic√¥nes -->
    <Icon Id="ProductIcon" SourceFile="..\images\app.ico"/>
    <Icon Id="PDFIcon" SourceFile="..\images\pdf.ico"/>

    <!-- Features -->
    <Feature Id="Complete"
             Title="Gestion de Stock"
             Description="Installation compl√®te"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER">

      <Feature Id="MainApplication"
               Title="Application principale"
               Description="Programme principal et fichiers requis"
               Level="1">
        <ComponentRef Id="MainExecutable" />
        <ComponentRef Id="SQLiteLibrary" />
        <ComponentRef Id="ConfigFiles" />
        <ComponentRef Id="DatabaseTemplate" />
        <ComponentRef Id="ApplicationShortcuts" />
      </Feature>

      <Feature Id="Documentation"
               Title="Documentation"
               Description="Manuel utilisateur et licence"
               Level="1">
        <ComponentRef Id="Documentation" />
      </Feature>

      <Feature Id="DesktopShortcuts"
               Title="Raccourci bureau"
               Description="Cr√©er un raccourci sur le bureau"
               Level="2">
        <ComponentRef Id="DesktopShortcut" />
      </Feature>
    </Feature>

    <!-- Interface utilisateur -->
    <UIRef Id="WixUI_FeatureTree" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- Licence (optionnel) -->
    <WixVariable Id="WixUILicenseRtf" Value="..\docs\licence.rtf" />

    <!-- Banni√®re (optionnel) -->
    <WixVariable Id="WixUIBannerBmp" Value="..\images\banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="..\images\dialog.bmp" />

  </Product>
</Wix>
```

### Compilation d'un projet WiX

**En ligne de commande :**

```cmd
# Compiler le fichier .wxs en .wixobj
candle.exe MonAppli.wxs

# Linker pour cr√©er le MSI
light.exe -ext WixUIExtension MonAppli.wixobj -out MonAppli.msi
```

**Avec Visual Studio :**

1. Cr√©ez un nouveau projet "WiX Setup Project"
2. Ajoutez vos fichiers `.wxs`
3. Configurez les r√©f√©rences
4. Build ‚Üí Build Solution
5. Le MSI est g√©n√©r√© dans le dossier de sortie

### WiX avec Visual Studio

**Cr√©er un projet WiX dans Visual Studio :**

1. **File** ‚Üí **New** ‚Üí **Project**
2. S√©lectionnez **WiX Toolset** ‚Üí **Setup Project**
3. Nommez votre projet
4. Visual Studio cr√©e un fichier `Product.wxs` de base

**Ajouter des fichiers automatiquement avec Heat.exe :**

Heat.exe est un outil WiX qui g√©n√®re automatiquement du XML √† partir de fichiers.

```cmd
# G√©n√©rer un fragment WiX depuis un dossier
heat.exe dir "..\bin" -cg BinComponents -gg -scom -sreg -sfrag -srd -dr INSTALLFOLDER -out BinFiles.wxs

# Compiler
candle.exe Product.wxs BinFiles.wxs  
light.exe -ext WixUIExtension Product.wixobj BinFiles.wixobj -out MonAppli.msi
```

### Actions personnalis√©es (Custom Actions)

Les Custom Actions permettent d'ex√©cuter du code durant l'installation.

**Exemple : Cr√©er une base de donn√©es apr√®s installation**

```xml
<!-- D√©finir une Custom Action -->
<CustomAction Id="CreateDatabase"
              FileKey="GestionStockEXE"
              ExeCommand="--create-database"
              Execute="deferred"
              Return="check"
              Impersonate="no" />

<!-- S√©quencer la Custom Action -->
<InstallExecuteSequence>
  <Custom Action="CreateDatabase" After="InstallFiles">
    NOT Installed
  </Custom>
</InstallExecuteSequence>
```

**Exemple : Ex√©cuter un script PowerShell**

```xml
<Binary Id="PowerShellScript" SourceFile="scripts\setup.ps1" />

<CustomAction Id="RunPowerShellScript"
              BinaryKey="PowerShellScript"
              Execute="deferred"
              Impersonate="no"
              Return="check" />
```

### Gestion des mises √† jour avec WiX

**Configuration MajorUpgrade :**

```xml
<Product>
  <!-- Mise √† jour majeure automatique -->
  <MajorUpgrade
    Schedule="afterInstallInitialize"
    DowngradeErrorMessage="Une version plus r√©cente est d√©j√† install√©e. D√©sinstallez-la avant de continuer."
    AllowSameVersionUpgrades="no" />
</Product>
```

**Conditions de mise √† jour :**

```xml
<!-- Ne permettre l'installation que si version >= 1.0 -->
<Upgrade Id="87654321-4321-4321-4321-BA9876543210">
  <UpgradeVersion
    Minimum="1.0.0.0"
    Maximum="2.0.0.0"
    IncludeMinimum="yes"
    IncludeMaximum="no"
    OnlyDetect="no"
    Property="PREVIOUSVERSIONSINSTALLED" />
</Upgrade>

<InstallExecuteSequence>
  <RemoveExistingProducts After="InstallInitialize" />
</InstallExecuteSequence>
```

## Comparaison des trois solutions

| Crit√®re | Inno Setup | NSIS | WiX/MSI |
|---------|------------|------|---------|
| **Facilit√© d'utilisation** | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê |
| **Courbe d'apprentissage** | Facile | Moyenne | Difficile |
| **Documentation** | Excellente | Bonne | Technique |
| **Communaut√© FreePascal** | Tr√®s active | Active | Faible |
| **Taille installateur** | Petite | Tr√®s petite | Moyenne |
| **Personnalisation UI** | Moyenne | Excellente | Limit√©e |
| **Standard Microsoft** | Non | Non | Oui |
| **Support entreprise** | Bon | Bon | Excellent |
| **Gestion mises √† jour** | Bonne | Bonne | Excellente |
| **Gratuit** | Oui | Oui | Oui |
| **Open Source** | Oui | Oui | Oui |

### Recommandations par cas d'usage

**Utilisez Inno Setup si :**
- Vous d√©butez avec les installateurs
- Vous voulez quelque chose de simple et efficace
- Votre application est petite/moyenne
- Vous d√©veloppez pour le grand public
- Vous voulez une solution rapide √† mettre en place

**Utilisez NSIS si :**
- Vous avez besoin de personnalisation pouss√©e de l'interface
- Vous voulez un installateur tr√®s l√©ger
- Vous avez des besoins sp√©cifiques complexes
- Vous √™tes √† l'aise avec un langage de script

**Utilisez WiX/MSI si :**
- Vous ciblez un environnement d'entreprise
- Le format MSI est obligatoire (GPO, SCCM)
- Vous avez besoin de fonctionnalit√©s Windows Installer avanc√©es
- Vous g√©rez des mises √† jour complexes
- Vous avez le temps d'apprendre un outil complexe

## Bonnes pratiques g√©n√©rales

### 1. Versioning s√©mantique

Adoptez un sch√©ma de version coh√©rent :

```
MAJEUR.MINEUR.CORRECTIF.BUILD

Exemples:
1.0.0.0   - Premi√®re version
1.1.0.0   - Nouvelles fonctionnalit√©s
1.1.1.0   - Corrections de bugs
2.0.0.0   - Changements majeurs
```

### 2. Signature num√©rique

Signez TOUJOURS vos installateurs avec un certificat code signing.

**Avantages :**
- Confiance des utilisateurs
- Pas d'avertissement Windows SmartScreen
- Authentification de l'√©diteur
- Protection contre la modification

**Obtention d'un certificat :**
- DigiCert, Sectigo, GlobalSign (payants ~200-400‚Ç¨/an)
- Certificats EV (Extended Validation) recommand√©s

**Signature :**
```cmd
signtool sign /f certificat.pfx /p motdepasse /tr http://timestamp.digicert.com /td sha256 /fd sha256 MonAppli-Setup.exe
```

### 3. Tests d'installation

Testez votre installateur dans diff√©rentes conditions :

**Environnements de test :**
- Windows 10 (build minimum support√©)
- Windows 11
- Machines virtuelles propres
- Comptes utilisateur standard (pas admin)
- Installation sur diff√©rents disques (C:, D:)

**Sc√©narios de test :**
- Installation nouvelle
- Mise √† jour depuis version pr√©c√©dente
- R√©installation sur version existante
- D√©sinstallation compl√®te
- Installation silencieuse
- Installation avec param√®tres personnalis√©s

### 4. Installation silencieuse

Supportez l'installation en ligne de commande pour les administrateurs.

**Inno Setup :**
```cmd
MonAppli-Setup.exe /SILENT /DIR="C:\MonDossier" /NOICONS
```

**NSIS :**
```cmd
MonAppli-Setup.exe /S /D=C:\MonDossier
```

**MSI :**
```cmd
msiexec /i MonAppli.msi /quiet INSTALLDIR="C:\MonDossier"
```

### 5. Logs d'installation

G√©n√©rez des logs pour diagnostiquer les probl√®mes.

**Inno Setup :**
```cmd
MonAppli-Setup.exe /LOG="C:\install.log"
```

**MSI :**
```cmd
msiexec /i MonAppli.msi /L*V "C:\install.log"
```

### 6. Gestion des d√©pendances

Incluez ou v√©rifiez les d√©pendances n√©cessaires :

- **Visual C++ Redistributable** (si utilisation de biblioth√®ques C++)
- **.NET Framework** (si interop√©rabilit√© .NET)
- **Biblioth√®ques FreePascal** sp√©cifiques
- **DLLs tierces** (SQLite, PostgreSQL client, etc.)

**Exemple Inno Setup pour VC++ Redist :**

```ini
[Files]
Source: "dependencies\VC_redist.x64.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

[Run]
Filename: "{tmp}\VC_redist.x64.exe"; Parameters: "/quiet /norestart"; StatusMsg: "Installation de Visual C++ Redistributable..."; Check: NeedsVCRedist
```

### 7. D√©sinstallation propre

Assurez-vous que la d√©sinstallation supprime :
- Tous les fichiers install√©s
- Les raccourcis
- Les cl√©s de registre
- Les donn√©es utilisateur (optionnel, avec confirmation)

**Ne PAS supprimer :**
- Les fichiers cr√©√©s par l'utilisateur
- Les configurations personnalis√©es (sauf demande explicite)

### 8. Multilinguisme

Supportez plusieurs langues d√®s le d√©but.

**Inno Setup :**
```ini
[Languages]
Name: "french"; MessagesFile: "compiler:Languages\French.isl"  
Name: "english"; MessagesFile: "compiler:Default.isl"  
Name: "german"; MessagesFile: "compiler:Languages\German.isl"  
Name: "spanish"; MessagesFile: "compiler:Languages\Spanish.isl"
```

### 9. Documentation de l'installateur

Documentez les options d'installation :

```
# README-INSTALLATION.md

## Installation

### Installation interactive
Double-cliquez sur `MonAppli-Setup.exe` et suivez les instructions.

### Installation silencieuse
```cmd
MonAppli-Setup.exe /SILENT /DIR="C:\MonAppli" /TASKS="desktopicon"
```

### Param√®tres en ligne de commande
- `/SILENT` : Installation sans interface
- `/DIR="chemin"` : Dossier d'installation
- `/TASKS="liste"` : T√¢ches √† ex√©cuter
- `/LOG="fichier"` : Fichier de log

### D√©sinstallation
Panneau de configuration ‚Üí Programmes ‚Üí D√©sinstaller un programme
```

### 10. Checklist avant publication

‚úÖ Version correctement d√©finie  
‚úÖ Toutes les d√©pendances incluses  
‚úÖ Signature num√©rique appliqu√©e  
‚úÖ Test√© sur Windows 10 et 11  
‚úÖ Installation silencieuse fonctionnelle  
‚úÖ D√©sinstallation compl√®te v√©rifi√©e  
‚úÖ Ic√¥nes et images de qualit√© professionnelle  
‚úÖ Licence et documentation incluses  
‚úÖ Taille de l'installateur optimis√©e  
‚úÖ Compatibilit√© 32-bit/64-bit v√©rifi√©e  
‚úÖ Logs d'installation fonctionnels  
‚úÖ Tests sur compte utilisateur standard (non-admin)  
‚úÖ V√©rification antivirus (0 faux positif)  
‚úÖ Mise √† jour depuis version pr√©c√©dente test√©e

## Automatisation de la cr√©ation d'installateurs

### Script de build automatis√©

Pour un workflow DevOps efficace, automatisez la cr√©ation de vos installateurs.

**Script PowerShell : `build-installer.ps1`**

```powershell
# Script de build automatique pour installateurs Windows
# Application FreePascal/Lazarus

param(
    [string]$Version = "1.0.0",
    [string]$BuildConfig = "Release",
    [switch]$SignInstaller = $false,
    [string]$CertPath = "",
    [string]$CertPassword = ""
)

$ErrorActionPreference = "Stop"

Write-Host "=== Build Installateur MonAppli v$Version ===" -ForegroundColor Green

# 1. Compilation de l'application FreePascal
Write-Host "`n[1/6] Compilation de l'application..." -ForegroundColor Yellow
$LazbuildPath = "C:\lazarus\lazbuild.exe"
$ProjectPath = "src\MonAppli.lpi"

& $LazbuildPath --build-mode=$BuildConfig $ProjectPath
if ($LASTEXITCODE -ne 0) {
    Write-Error "Erreur lors de la compilation"
    exit 1
}
Write-Host "‚úì Compilation r√©ussie" -ForegroundColor Green

# 2. Copie des fichiers dans le dossier de staging
Write-Host "`n[2/6] Pr√©paration des fichiers..." -ForegroundColor Yellow
$StagingDir = "installer\staging"
if (Test-Path $StagingDir) {
    Remove-Item $StagingDir -Recurse -Force
}
New-Item -ItemType Directory -Path $StagingDir | Out-Null

# Copier l'ex√©cutable
Copy-Item "bin\$BuildConfig\MonAppli.exe" -Destination "$StagingDir\"

# Copier les DLLs
Copy-Item "bin\$BuildConfig\*.dll" -Destination "$StagingDir\"

# Copier la documentation
Copy-Item "docs\*" -Destination "$StagingDir\docs\" -Recurse

Write-Host "‚úì Fichiers pr√©par√©s" -ForegroundColor Green

# 3. Mise √† jour du num√©ro de version dans le script Inno Setup
Write-Host "`n[3/6] Mise √† jour de la version..." -ForegroundColor Yellow
$IssFile = "installer\MonAppli.iss"
$IssContent = Get-Content $IssFile -Raw
$IssContent = $IssContent -replace 'AppVersion=.*', "AppVersion=$Version"
$IssContent = $IssContent -replace 'OutputBaseFilename=.*', "OutputBaseFilename=MonAppli-Setup-$Version"
Set-Content $IssFile -Value $IssContent  
Write-Host "‚úì Version mise √† jour: $Version" -ForegroundColor Green

# 4. Compilation de l'installateur Inno Setup
Write-Host "`n[4/6] Compilation de l'installateur..." -ForegroundColor Yellow
$InnoSetupPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
& $InnoSetupPath $IssFile
if ($LASTEXITCODE -ne 0) {
    Write-Error "Erreur lors de la compilation de l'installateur"
    exit 1
}
Write-Host "‚úì Installateur cr√©√©" -ForegroundColor Green

# 5. Signature num√©rique (optionnel)
if ($SignInstaller -and $CertPath) {
    Write-Host "`n[5/6] Signature de l'installateur..." -ForegroundColor Yellow
    $InstallerPath = "installer\output\MonAppli-Setup-$Version.exe"
    $SignToolPath = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

    $SignArgs = @(
        "sign",
        "/f", $CertPath,
        "/p", $CertPassword,
        "/tr", "http://timestamp.digicert.com",
        "/td", "sha256",
        "/fd", "sha256",
        $InstallerPath
    )

    & $SignToolPath $SignArgs
    if ($LASTEXITCODE -ne 0) {
        Write-Warning "Erreur lors de la signature (non bloquant)"
    } else {
        Write-Host "‚úì Installateur sign√©" -ForegroundColor Green
    }
} else {
    Write-Host "`n[5/6] Signature ignor√©e" -ForegroundColor Gray
}

# 6. Calcul du hash SHA256
Write-Host "`n[6/6] Calcul du hash SHA256..." -ForegroundColor Yellow
$InstallerPath = "installer\output\MonAppli-Setup-$Version.exe"
$Hash = Get-FileHash $InstallerPath -Algorithm SHA256
$HashFile = "$InstallerPath.sha256"
"$($Hash.Hash)  MonAppli-Setup-$Version.exe" | Out-File $HashFile -Encoding ASCII
Write-Host "‚úì Hash calcul√©: $($Hash.Hash)" -ForegroundColor Green

# R√©sum√©
Write-Host "`n=== Build termin√© avec succ√®s ===" -ForegroundColor Green  
Write-Host "Installateur: $InstallerPath"
$FileSize = (Get-Item $InstallerPath).Length / 1MB
Write-Host "Taille: $([math]::Round($FileSize, 2)) MB"  
Write-Host "SHA256: $($Hash.Hash)"
```

**Utilisation :**

```powershell
# Build simple
.\build-installer.ps1 -Version "1.2.3"

# Build avec signature
.\build-installer.ps1 -Version "1.2.3" -SignInstaller -CertPath "cert.pfx" -CertPassword "secret"
```

### Int√©gration dans un pipeline CI/CD

**GitHub Actions : `.github/workflows/build-installer.yml`**

```yaml
name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows-installer:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup FreePascal
      run: |
        choco install lazarus -y

    - name: Get version from tag
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Build application
      run: |
        lazbuild --build-mode=Release src/MonAppli.lpi

    - name: Download Inno Setup
      run: |
        choco install innosetup -y

    - name: Build installer
      run: |
        .\build-installer.ps1 -Version ${{ steps.get_version.outputs.VERSION }}
      shell: pwsh

    - name: Upload installer
      uses: actions/upload-artifact@v3
      with:
        name: MonAppli-Setup-${{ steps.get_version.outputs.VERSION }}
        path: installer/output/*.exe

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          installer/output/*.exe
          installer/output/*.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## Distribution et d√©ploiement

### 1. H√©bergement de l'installateur

**Options d'h√©bergement :**

**Site web personnel :**
```html
<!-- Page de t√©l√©chargement -->
<h2>T√©l√©charger MonAppli v1.2.3</h2>
<a href="downloads/MonAppli-Setup-1.2.3.exe" class="download-btn">
  T√©l√©charger (15 MB)
</a>
<p>SHA256: abc123def456...</p>
```

**GitHub Releases :**
- Gratuit pour projets open source
- CDN rapide
- Tracking des t√©l√©chargements
- Versionning automatique

**Serveurs d√©di√©s :**
- AWS S3 / CloudFront
- Azure Blob Storage / CDN
- Google Cloud Storage
- DigitalOcean Spaces

**Plateformes de distribution :**
- Microsoft Store (n√©cessite packaging MSIX)
- Ninite (pour logiciels populaires)
- Chocolatey (gestionnaire de paquets Windows)

### 2. Cr√©ation d'un package Chocolatey

Chocolatey permet aux utilisateurs d'installer votre application en ligne de commande.

**Structure du package :**
```
MonAppli.chocolatey/
‚îú‚îÄ‚îÄ monappli.nuspec
‚îî‚îÄ‚îÄ tools/
    ‚îú‚îÄ‚îÄ chocolateyinstall.ps1
    ‚îî‚îÄ‚îÄ chocolateyuninstall.ps1
```

**Fichier : `monappli.nuspec`**

```xml
<?xml version="1.0" encoding="utf-8"?>
<package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
  <metadata>
    <id>monappli</id>
    <version>1.2.3</version>
    <title>MonAppli</title>
    <authors>Votre Nom</authors>
    <owners>Votre Nom</owners>
    <projectUrl>https://www.example.com</projectUrl>
    <iconUrl>https://www.example.com/icon.png</iconUrl>
    <licenseUrl>https://www.example.com/licence</licenseUrl>
    <requireLicenseAcceptance>false</requireLicenseAcceptance>
    <description>Application de gestion d√©velopp√©e avec FreePascal/Lazarus</description>
    <summary>Logiciel de gestion complet</summary>
    <tags>freepascal lazarus gestion</tags>
  </metadata>
</package>
```

**Fichier : `tools/chocolateyinstall.ps1`**

```powershell
$ErrorActionPreference = 'Stop'

$packageName = 'monappli'
$installerType = 'exe'
$url = 'https://example.com/downloads/MonAppli-Setup-1.2.3.exe'
$checksum = 'ABC123DEF456...'
$checksumType = 'sha256'
$silentArgs = '/SILENT /NORESTART'

$packageArgs = @{
  packageName   = $packageName
  fileType      = $installerType
  url           = $url
  silentArgs    = $silentArgs
  validExitCodes= @(0)
  checksum      = $checksum
  checksumType  = $checksumType
}

Install-ChocolateyPackage @packageArgs
```

**Cr√©ation et publication :**

```powershell
# Empaqueter
choco pack

# Tester localement
choco install monappli -source .

# Publier sur chocolatey.org
choco push monappli.1.2.3.nupkg --source https://push.chocolatey.org/
```

**Installation par les utilisateurs :**

```powershell
choco install monappli
```

### 3. Syst√®me de mise √† jour automatique

Impl√©mentez un syst√®me de v√©rification des mises √† jour dans votre application FreePascal.

**Exemple de code FreePascal pour v√©rifier les mises √† jour :**

```pascal
unit UpdateChecker;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, fphttpclient, fpjson, jsonparser;

type
  TUpdateInfo = record
    Available: Boolean;
    LatestVersion: String;
    DownloadURL: String;
    ReleaseNotes: String;
  end;

function CheckForUpdates(const CurrentVersion: String): TUpdateInfo;

implementation

const
  UPDATE_URL = 'https://api.example.com/updates/check';

function CheckForUpdates(const CurrentVersion: String): TUpdateInfo;  
var
  HTTPClient: TFPHTTPClient;
  Response: String;
  JSONData: TJSONData;
  JSONObject: TJSONObject;
begin
  Result.Available := False;

  HTTPClient := TFPHTTPClient.Create(nil);
  try
    try
      // Requ√™te vers l'API de mise √† jour
      Response := HTTPClient.Get(UPDATE_URL + '?version=' + CurrentVersion);

      // Parser le JSON
      JSONData := GetJSON(Response);
      if JSONData is TJSONObject then
      begin
        JSONObject := TJSONObject(JSONData);

        Result.Available := JSONObject.Get('update_available', False);
        Result.LatestVersion := JSONObject.Get('latest_version', '');
        Result.DownloadURL := JSONObject.Get('download_url', '');
        Result.ReleaseNotes := JSONObject.Get('release_notes', '');
      end;

    except
      on E: Exception do
        WriteLn('Erreur lors de la v√©rification des mises √† jour: ', E.Message);
    end;
  finally
    HTTPClient.Free;
  end;
end;

end.
```

**Utilisation dans votre application :**

```pascal
procedure TMainForm.CheckUpdatesClick(Sender: TObject);  
var
  UpdateInfo: TUpdateInfo;
begin
  UpdateInfo := CheckForUpdates('1.2.3');

  if UpdateInfo.Available then
  begin
    if MessageDlg('Mise √† jour disponible',
                  Format('Une nouvelle version %s est disponible. Voulez-vous la t√©l√©charger ?',
                         [UpdateInfo.LatestVersion]),
                  mtConfirmation, [mbYes, mbNo], 0) = mrYes then
    begin
      // Ouvrir l'URL de t√©l√©chargement
      OpenURL(UpdateInfo.DownloadURL);
    end;
  end
  else
    ShowMessage('Vous utilisez d√©j√† la derni√®re version.');
end;
```

**API c√¥t√© serveur (exemple Node.js/Express) :**

```javascript
// api/updates.js
app.get('/updates/check', (req, res) => {
  const currentVersion = req.query.version;
  const latestVersion = '1.3.0';

  const needsUpdate = compareVersions(currentVersion, latestVersion) < 0;

  res.json({
    update_available: needsUpdate,
    latest_version: latestVersion,
    download_url: `https://example.com/downloads/MonAppli-Setup-${latestVersion}.exe`,
    release_notes: 'Corrections de bugs et am√©liorations de performance.'
  });
});
```

## Gestion des probl√®mes courants

### Probl√®me 1 : Antivirus bloque l'installateur

**Causes :**
- Installateur non sign√©
- Comportements suspects d√©tect√©s
- R√©putation faible (nouveau fichier)

**Solutions :**
1. **Signer l'installateur** avec un certificat EV
2. **Soumettre aux antivirus** :
   - Windows Defender: https://www.microsoft.com/en-us/wdsi/filesubmission
   - VirusTotal: https://www.virustotal.com
3. **Construire une r√©putation** : t√©l√©chargements r√©guliers sans incidents
4. **√âviter les comportements suspects** :
   - Ne pas t√©l√©charger d'ex√©cutables depuis Internet durant l'installation
   - Ne pas modifier des fichiers syst√®me
   - Ne pas injecter du code dans d'autres processus

### Probl√®me 2 : Windows SmartScreen bloque l'installateur

**Message :** "Windows a prot√©g√© votre PC"

**Causes :**
- Installateur sans signature
- Signature avec certificat standard (non-EV)
- Peu de t√©l√©chargements (pas de r√©putation)

**Solutions :**
1. **Certificat EV (Extended Validation)** : √âvite SmartScreen imm√©diatement
2. **Construire une r√©putation** : Apr√®s ~3000 t√©l√©chargements, SmartScreen dispara√Æt
3. **Soumettre √† Microsoft** : Processus de whitelist
4. **Documentation utilisateur** : Expliquer comment autoriser l'installation

**Instructions pour l'utilisateur :**
```
Si Windows SmartScreen appara√Æt :
1. Cliquez sur "Informations compl√©mentaires"
2. Cliquez sur "Ex√©cuter quand m√™me"
3. L'installation peut continuer normalement
```

### Probl√®me 3 : Erreur "Cette application n√©cessite les droits administrateur"

**Solutions :**

**Dans Inno Setup :**
```ini
[Setup]
PrivilegesRequired=admin  
PrivilegesRequiredOverridesAllowed=commandline
```

**Permettre installation sans admin (si possible) :**
```ini
[Setup]
PrivilegesRequired=lowest  
DefaultDirName={autopf}\MonAppli  ; Si admin  
DefaultDirName={localappdata}\MonAppli  ; Si utilisateur standard
```

### Probl√®me 4 : DLL manquante apr√®s installation

**Diagnostic :**

Utilisez **Dependency Walker** ou **Dependencies** pour identifier les DLLs manquantes.

**Solutions :**

1. **Inclure toutes les DLLs** dans l'installateur
2. **Installer les redistributables** (VC++, .NET)
3. **Compilation statique** avec FreePascal :

```pascal
// Dans les options du projet
{$LINKLIB libstatic.a}
```

**Dans Lazarus :**
- Project Options ‚Üí Compiler Options ‚Üí Linking
- Cocher "Link smart" et "Strip symbols"

### Probl√®me 5 : Probl√®mes de permissions sur les fichiers

**Probl√®me :** L'application ne peut pas √©crire dans son dossier d'installation.

**Solution :** Utiliser les dossiers appropri√©s :

```pascal
// Configuration utilisateur
ConfigPath := GetAppConfigDir(False);  // C:\Users\{user}\AppData\Roaming\MonAppli\

// Donn√©es utilisateur
DataPath := GetUserDir + 'Documents\MonAppli\';

// Fichiers temporaires
TempPath := GetTempDir;

// Logs
LogPath := GetAppConfigDir(False) + 'logs\';
```

**Dans l'installateur, cr√©er les dossiers avec bonnes permissions :**

```ini
[Dirs]
Name: "{localappdata}\MonAppli"; Permissions: users-full  
Name: "{userdocs}\MonAppli"; Permissions: users-full
```

## M√©triques et analytics

### Tracking des installations

Suivez les statistiques d'installation pour am√©liorer votre distribution.

**M√©triques importantes :**
- Nombre de t√©l√©chargements
- Nombre d'installations r√©ussies
- Taux d'abandon
- Versions de Windows
- Erreurs d'installation
- Temps d'installation moyen

**Impl√©mentation simple avec ping serveur :**

```pascal
// Dans votre application, au premier lancement
procedure ReportInstallation;  
var
  HTTPClient: TFPHTTPClient;
  PostData: String;
begin
  HTTPClient := TFPHTTPClient.Create(nil);
  try
    PostData := Format('version=%s&os=%s&arch=%s',
                       [GetAppVersion, GetOSVersion, GetArchitecture]);
    HTTPClient.RequestBody := TStringStream.Create(PostData);
    HTTPClient.Post('https://api.example.com/analytics/install');
  finally
    HTTPClient.Free;
  end;
end;
```

**Respectez la vie priv√©e :**
- Demandez le consentement de l'utilisateur
- N'envoyez pas de donn√©es personnelles
- Fournissez un opt-out
- Conformez-vous au RGPD

## Documentation pour les utilisateurs

### Guide d'installation

**Cr√©ez un fichier `INSTALLATION.md` :**

````markdown
# Guide d'installation - MonAppli

## Configuration requise

- **Syst√®me d'exploitation** : Windows 10 (build 1809) ou sup√©rieur
- **RAM** : 2 GB minimum, 4 GB recommand√©
- **Espace disque** : 500 MB
- **Autres** : .NET Framework 4.8 (install√© automatiquement si absent)

## Installation standard

1. T√©l√©chargez `MonAppli-Setup-x.x.x.exe`
2. Double-cliquez sur le fichier t√©l√©charg√©
3. Si Windows SmartScreen appara√Æt :
   - Cliquez sur "Informations compl√©mentaires"
   - Cliquez sur "Ex√©cuter quand m√™me"
4. Suivez les instructions de l'assistant d'installation
5. Cliquez sur "Terminer"

## Installation silencieuse (administrateurs)

Pour une installation automatis√©e :

```cmd
MonAppli-Setup.exe /SILENT /DIR="C:\Program Files\MonAppli" /TASKS="desktopicon"
```

### Param√®tres disponibles

- `/SILENT` - Installation sans interface utilisateur
- `/VERYSILENT` - Installation compl√®tement silencieuse
- `/DIR="chemin"` - Dossier d'installation personnalis√©
- `/TASKS="liste"` - T√¢ches √† ex√©cuter (s√©par√©es par des virgules)
- `/LOG="fichier"` - Cr√©er un fichier de log
- `/NORESTART` - Ne pas red√©marrer l'ordinateur

## D√©sinstallation

### M√©thode 1 : Panneau de configuration
1. Ouvrez "Param√®tres" ‚Üí "Applications"
2. Recherchez "MonAppli"
3. Cliquez sur "D√©sinstaller"

### M√©thode 2 : Menu D√©marrer
1. Menu D√©marrer ‚Üí MonAppli
2. Cliquez sur "D√©sinstaller MonAppli"

### D√©sinstallation silencieuse
```cmd
"C:\Program Files\MonAppli\unins000.exe" /SILENT
```

## R√©solution des probl√®mes

### Erreur "Impossible d'installer"
- V√©rifiez que vous avez les droits administrateur
- Fermez toutes les instances de l'application
- D√©sactivez temporairement l'antivirus

### L'application ne d√©marre pas
- V√©rifiez que .NET Framework 4.8 est install√©
- V√©rifiez les fichiers de log dans `%APPDATA%\MonAppli\logs\`
- R√©installez l'application

### Support
Pour toute aide : support@example.com
````

## R√©capitulatif et recommandations finales

### Pour d√©buter : Inno Setup

Si vous cr√©ez votre premier installateur, commencez avec **Inno Setup** :

**‚úÖ Avantages :**
- Apprentissage rapide (1-2 jours)
- Documentation excellente
- Assistant de cr√©ation int√©gr√©
- Communaut√© FreePascal active
- R√©sultat professionnel garanti

**üìù Template de d√©part :**

Utilisez le script d'exemple fourni au d√©but de ce tutoriel, modifiez :
- Les chemins des fichiers
- Les informations de l'application
- Le GUID (g√©n√©rez-en un nouveau)
- Les langues support√©es

### Pour aller plus loin : NSIS

Quand vous ma√Ætrisez Inno Setup et avez besoin de plus de contr√¥le, passez √† **NSIS** :

**‚úÖ Cas d'usage :**
- Interface graphique tr√®s personnalis√©e
- Installateurs multi-composants complexes
- Besoins de plugins sp√©cifiques
- Optimisation maximale de la taille

### Pour l'entreprise : WiX/MSI

Pour un environnement d'entreprise strict, utilisez **WiX** :

**‚úÖ Cas d'usage :**
- D√©ploiement via GPO/SCCM
- Conformit√© aux standards Microsoft
- Gestion avanc√©e des mises √† jour
- Support des transformations MST

### Workflow id√©al

```
1. D√©veloppement
   ‚Üì
2. Compilation Release
   ‚Üì
3. Tests application
   ‚Üì
4. Cr√©ation installateur
   ‚Üì
5. Signature num√©rique
   ‚Üì
6. Tests installation (VM)
   ‚Üì
7. Calcul hash SHA256
   ‚Üì
8. Upload sur serveur
   ‚Üì
9. Mise √† jour site web
   ‚Üì
10. Annonce aux utilisateurs
```

### Outils recommand√©s

**Pour le d√©veloppement d'installateurs :**
- **Inno Setup** + **ISTool** (IDE alternatif)
- **HM NIS Edit** (pour NSIS)
- **WiX Edit** (pour WiX)

**Pour les tests :**
- **VirtualBox** ou **Hyper-V** (machines virtuelles propres)
- **Windows Sandbox** (test rapide isolation)
- **Dependency Walker** (v√©rifier les DLLs)

**Pour la distribution :**
- **SignTool** (signature num√©rique)
- **Advanced Installer** (version gratuite, alternative)

## Conclusion

Cr√©er un installateur professionnel pour vos applications FreePascal/Lazarus est une √©tape cruciale pour offrir une excellente exp√©rience utilisateur. Les trois solutions pr√©sent√©es (Inno Setup, NSIS, WiX) sont toutes gratuites, puissantes et adapt√©es √† diff√©rents besoins.

**Points cl√©s √† retenir :**

‚úÖ **Inno Setup** est le meilleur choix pour 90% des applications FreePascal  
‚úÖ **Signez toujours** vos installateurs pour la confiance des utilisateurs  
‚úÖ **Testez exhaustivement** sur diff√©rentes versions de Windows  
‚úÖ **Documentez** le processus d'installation pour vos utilisateurs  
‚úÖ **Automatisez** la cr√©ation d'installateurs dans votre pipeline CI/CD  
‚úÖ **G√©rez les mises √† jour** de mani√®re transparente  
‚úÖ **Suivez les m√©triques** pour am√©liorer le processus

### Prochaines √©tapes

Maintenant que vous ma√Ætrisez la cr√©ation d'installateurs Windows, explorez :

- **Section 22.6.2** : Paquets Linux (DEB, RPM, AppImage, Snap)
- **Section 22.7** : Monitoring et m√©triques
- **Section 22.4** : Pipelines CI/CD complets

**Bonne cr√©ation d'installateurs Windows ! üì¶‚ú®**

‚è≠Ô∏è [Paquets Linux (DEB, RPM, AppImage, Snap)](/22-devops-deploiement-multi-os/06.2-paquets-linux-deb-rpm-appimage-snap.md)
