üîù Retour au [Sommaire](/SOMMAIRE.md)

# 8.3.2 Chemins de biblioth√®ques Linux (.so)

## Introduction aux biblioth√®ques partag√©es Linux

Sur Linux, les biblioth√®ques dynamiques sont appel√©es **biblioth√®ques partag√©es** (shared libraries) et utilisent l'extension `.so` (Shared Object). Ces biblioth√®ques sont l'√©quivalent des fichiers `.dll` de Windows, mais avec des conventions et une gestion diff√©rentes.

### Qu'est-ce qu'une biblioth√®que partag√©e ?

Une biblioth√®que partag√©e contient du code compil√© qui peut √™tre utilis√© par plusieurs programmes simultan√©ment. Au lieu d'incorporer ce code dans chaque programme, Linux le charge dynamiquement en m√©moire, ce qui permet :

- **√âconomie de m√©moire** : Une seule copie en m√©moire pour tous les programmes
- **Mises √† jour facilit√©es** : Corriger un bug dans la biblioth√®que corrige tous les programmes
- **Taille r√©duite des ex√©cutables** : Le code de la biblioth√®que n'est pas dupliqu√©

### Convention de nommage

Les biblioth√®ques Linux suivent une convention de nommage stricte :

```
lib<nom>.so[.version][.r√©vision][.age]
```

**Exemples :**
- `libfbclient.so` ‚Üí Lien symbolique vers la version actuelle
- `libfbclient.so.3` ‚Üí Version majeure 3
- `libfbclient.so.3.0.7` ‚Üí Version compl√®te 3.0.7
- `libmysqlclient.so.21` ‚Üí Version majeure 21 de MySQL
- `libpq.so.5` ‚Üí Version majeure 5 de PostgreSQL

**Pourquoi ce syst√®me de versionnement ?**

Le versionnement permet √† plusieurs versions d'une m√™me biblioth√®que de coexister sur le syst√®me, garantissant la compatibilit√© des anciennes applications tout en permettant l'utilisation des nouvelles versions.

## Emplacements standards des biblioth√®ques

### Hi√©rarchie des r√©pertoires syst√®me

Linux organise les biblioth√®ques selon une hi√©rarchie standard d√©finie par le **FHS** (Filesystem Hierarchy Standard) :

#### 1. `/lib/` et `/lib64/`

**Utilisation :** Biblioth√®ques essentielles au d√©marrage du syst√®me

```bash
/lib/
‚îú‚îÄ‚îÄ x86_64-linux-gnu/     # Architecture 64 bits (Debian/Ubuntu)
‚îú‚îÄ‚îÄ i386-linux-gnu/       # Architecture 32 bits (si install√©)
‚îî‚îÄ‚îÄ modules/              # Modules du noyau
```

**Exemples de biblioth√®ques :**
```bash
/lib/x86_64-linux-gnu/libc.so.6         # Biblioth√®que C standard
/lib/x86_64-linux-gnu/libpthread.so.0   # Threads POSIX
```

**Note :** Sur les syst√®mes 64 bits modernes, `/lib64/` peut √™tre un lien symbolique vers `/lib/`.

#### 2. `/usr/lib/` et `/usr/lib64/`

**Utilisation :** Biblioth√®ques des applications utilisateur (le plus courant)

```bash
/usr/lib/
‚îú‚îÄ‚îÄ x86_64-linux-gnu/     # Biblioth√®ques 64 bits
‚îÇ   ‚îú‚îÄ‚îÄ libfbclient.so.3
‚îÇ   ‚îú‚îÄ‚îÄ libmysqlclient.so.21
‚îÇ   ‚îú‚îÄ‚îÄ libpq.so.5
‚îÇ   ‚îî‚îÄ‚îÄ libsqlite3.so.0
‚îî‚îÄ‚îÄ i386-linux-gnu/       # Biblioth√®ques 32 bits (si multilib)
```

**C'est ici que se trouvent la plupart des biblioth√®ques de bases de donn√©es !**

#### 3. `/usr/local/lib/`

**Utilisation :** Biblioth√®ques install√©es manuellement par l'administrateur

```bash
/usr/local/lib/
‚îú‚îÄ‚îÄ libcustomdb.so        # Biblioth√®que compil√©e localement
‚îî‚îÄ‚îÄ libfirebird.so        # Version personnalis√©e de Firebird
```

**Quand l'utiliser ?**
- Compilation depuis les sources
- Versions personnalis√©es
- Biblioth√®ques non disponibles dans les d√©p√¥ts

#### 4. `/opt/`

**Utilisation :** Applications tierces compl√®tes avec leurs biblioth√®ques

```bash
/opt/
‚îú‚îÄ‚îÄ firebird/
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îî‚îÄ‚îÄ libfbclient.so
‚îî‚îÄ‚îÄ oracle/
    ‚îî‚îÄ‚îÄ lib/
        ‚îî‚îÄ‚îÄ libclntsh.so
```

#### 5. R√©pertoire de l'application

Certaines applications embarquent leurs propres biblioth√®ques :

```bash
/home/utilisateur/MonApp/
‚îú‚îÄ‚îÄ MonApp                # Ex√©cutable
‚îú‚îÄ‚îÄ libfbclient.so       # Biblioth√®que embarqu√©e
‚îî‚îÄ‚îÄ data/
```

### Architecture et multi-architecture

#### Debian/Ubuntu : syst√®me multi-arch

Debian et Ubuntu utilisent un syst√®me permettant d'installer plusieurs architectures :

```bash
# Architecture principale (64 bits)
/usr/lib/x86_64-linux-gnu/

# Architecture secondaire (32 bits, si install√©)
/usr/lib/i386-linux-gnu/

# ARM 64 bits
/usr/lib/aarch64-linux-gnu/

# ARM 32 bits
/usr/lib/arm-linux-gnueabihf/
```

**V√©rifier votre architecture :**
```bash
# Afficher l'architecture
dpkg --print-architecture
# Sortie typique : amd64

# Lister toutes les architectures install√©es
dpkg --print-foreign-architectures
# Sortie typique : i386 (si support 32 bits activ√©)

# M√©thode alternative
uname -m
# Sortie : x86_64 (64 bits) ou i686 (32 bits)
```

#### Red Hat/Fedora : syst√®me lib64

Sur les distributions Red Hat, Fedora, CentOS :

```bash
/usr/lib/       # Biblioth√®ques 32 bits (historique)
/usr/lib64/     # Biblioth√®ques 64 bits
```

## Chemins sp√©cifiques par base de donn√©es

### Firebird

**Paquets Ubuntu/Debian :**
```bash
sudo apt install firebird3.0-server        # Serveur  
sudo apt install firebird3.0-client        # Client uniquement  
sudo apt install firebird3.0-utils         # Outils
```

**Emplacements des biblioth√®ques :**

```bash
# Biblioth√®que cliente principale
/usr/lib/x86_64-linux-gnu/libfbclient.so.2

# Lien symbolique vers la version actuelle
/usr/lib/x86_64-linux-gnu/libfbclient.so -> libfbclient.so.2

# Biblioth√®que embedded (tout-en-un)
/usr/lib/x86_64-linux-gnu/libfbembed.so.2.5

# Plugin moderne (Firebird 3+)
/usr/lib/x86_64-linux-gnu/firebird/3.0/plugins/
```

**V√©rification de l'installation :**
```bash
# Trouver les fichiers Firebird
dpkg -L firebird3.0-client | grep libfbclient

# V√©rifier les liens symboliques
ls -l /usr/lib/x86_64-linux-gnu/libfbclient*
```

**Configuration dans FreePascal :**
```pascal
{$IFDEF LINUX}
IBConnection1.Params.Add('ClientLibrary=/usr/lib/x86_64-linux-gnu/libfbclient.so');
// ou simplement
IBConnection1.Params.Add('ClientLibrary=libfbclient.so');  // Si dans le path
{$ENDIF}
```

### MySQL/MariaDB

**Paquets Ubuntu/Debian :**
```bash
# MySQL
sudo apt install libmysqlclient-dev        # Biblioth√®que de d√©veloppement  
sudo apt install libmysqlclient21          # Biblioth√®que runtime

# MariaDB (alternative compatible)
sudo apt install libmariadb-dev  
sudo apt install libmariadb3
```

**Emplacements des biblioth√®ques :**

```bash
# MySQL
/usr/lib/x86_64-linux-gnu/libmysqlclient.so.21
/usr/lib/x86_64-linux-gnu/libmysqlclient.so -> libmysqlclient.so.21

# MariaDB
/usr/lib/x86_64-linux-gnu/libmariadb.so.3
/usr/lib/x86_64-linux-gnu/libmariadb.so -> libmariadb.so.3
```

**V√©rification :**
```bash
# MySQL
dpkg -L libmysqlclient21 | grep "\.so"

# V√©rifier la version
ls -l /usr/lib/x86_64-linux-gnu/libmysqlclient*
```

**Configuration dans FreePascal :**
```pascal
{$IFDEF LINUX}
MySQLConnection1.Params.Add('ClientLibrary=/usr/lib/x86_64-linux-gnu/libmysqlclient.so');
// ou pour MariaDB
MySQLConnection1.Params.Add('ClientLibrary=/usr/lib/x86_64-linux-gnu/libmariadb.so');
{$ENDIF}
```

### PostgreSQL

**Paquets Ubuntu/Debian :**
```bash
sudo apt install libpq-dev                 # Biblioth√®que de d√©veloppement  
sudo apt install libpq5                    # Biblioth√®que runtime (version 5)
```

**Emplacements des biblioth√®ques :**

```bash
# Biblioth√®que principale
/usr/lib/x86_64-linux-gnu/libpq.so.5
/usr/lib/x86_64-linux-gnu/libpq.so -> libpq.so.5

# Versions sp√©cifiques PostgreSQL
/usr/lib/postgresql/14/lib/
/usr/lib/postgresql/15/lib/
```

**V√©rification :**
```bash
dpkg -L libpq5 | grep "\.so"

# V√©rifier toutes les versions PostgreSQL install√©es
ls -l /usr/lib/postgresql/*/lib/
```

**Configuration dans FreePascal :**
```pascal
{$IFDEF LINUX}
PQConnection1.Params.Add('ClientLibrary=/usr/lib/x86_64-linux-gnu/libpq.so');
{$ENDIF}
```

### SQLite

**Paquets Ubuntu/Debian :**
```bash
sudo apt install libsqlite3-0              # Biblioth√®que runtime  
sudo apt install libsqlite3-dev            # Fichiers de d√©veloppement
```

**Emplacements des biblioth√®ques :**

```bash
# Biblioth√®que principale
/usr/lib/x86_64-linux-gnu/libsqlite3.so.0
/usr/lib/x86_64-linux-gnu/libsqlite3.so -> libsqlite3.so.0
```

**V√©rification :**
```bash
dpkg -L libsqlite3-0 | grep "\.so"
```

**Configuration dans FreePascal :**
```pascal
{$IFDEF LINUX}
SQLite3Connection1.Params.Add('ClientLibrary=/usr/lib/x86_64-linux-gnu/libsqlite3.so');
{$ENDIF}
```

## M√©canisme de recherche des biblioth√®ques

### Le linker dynamique (ld.so)

Linux utilise le **linker dynamique** (`ld.so` ou `ld-linux.so`) pour charger les biblioth√®ques au lancement d'un programme.

**Ordre de recherche par d√©faut :**

1. **R√©pertoires dans `RPATH`** (chemin compil√© dans l'ex√©cutable)
2. **Variable d'environnement `LD_LIBRARY_PATH`**
3. **R√©pertoires dans `RUNPATH`** (chemin compil√©, priorit√© basse)
4. **Cache du linker** (`/etc/ld.so.cache`)
5. **R√©pertoires par d√©faut** (`/lib`, `/usr/lib`)

### Variable d'environnement LD_LIBRARY_PATH

`LD_LIBRARY_PATH` permet de sp√©cifier des r√©pertoires suppl√©mentaires pour la recherche :

**Utilisation temporaire (session actuelle) :**
```bash
# Ajouter un r√©pertoire
export LD_LIBRARY_PATH=/opt/firebird/lib:$LD_LIBRARY_PATH

# V√©rifier
echo $LD_LIBRARY_PATH

# Lancer l'application
./MonApplication
```

**Utilisation permanente (utilisateur) :**
```bash
# √âditer ~/.bashrc
nano ~/.bashrc

# Ajouter √† la fin
export LD_LIBRARY_PATH=/opt/firebird/lib:$LD_LIBRARY_PATH

# Recharger la configuration
source ~/.bashrc
```

**Utilisation permanente (syst√®me) :**
```bash
# Cr√©er un fichier de configuration
sudo nano /etc/ld.so.conf.d/firebird.conf

# Ajouter le chemin
/opt/firebird/lib

# Mettre √† jour le cache
sudo ldconfig
```

**‚ö†Ô∏è Attention :** L'utilisation excessive de `LD_LIBRARY_PATH` peut causer des conflits. Pr√©f√©rez la configuration syst√®me via `ldconfig`.

### Configuration avec ldconfig

`ldconfig` est l'outil qui g√®re le cache des biblioth√®ques partag√©es.

**Ajouter un r√©pertoire de biblioth√®ques :**

```bash
# M√©thode 1 : Cr√©er un fichier de configuration
sudo nano /etc/ld.so.conf.d/custom.conf

# Ajouter le chemin
/usr/local/lib/firebird

# Mettre √† jour le cache
sudo ldconfig
```

**V√©rifier qu'une biblioth√®que est dans le cache :**
```bash
# Rechercher Firebird
ldconfig -p | grep firebird

# Sortie exemple :
# libfbclient.so.2 (libc6,x86-64) => /usr/lib/x86_64-linux-gnu/libfbclient.so.2
```

**Lister toutes les biblioth√®ques :**
```bash
ldconfig -p
```

**Afficher les biblioth√®ques utilis√©es par un programme :**
```bash
# Voir les d√©pendances
ldd /usr/bin/isql-fb

# Sortie exemple :
# libfbclient.so.2 => /usr/lib/x86_64-linux-gnu/libfbclient.so.2
# libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6
```

### Liens symboliques

Linux utilise massivement les liens symboliques pour g√©rer les versions :

**Exemple avec Firebird :**
```bash
ls -l /usr/lib/x86_64-linux-gnu/libfbclient*

# Sortie :
# lrwxrwxrwx libfbclient.so -> libfbclient.so.2
# lrwxrwxrwx libfbclient.so.2 -> libfbclient.so.2.5.9
# -rw-r--r-- libfbclient.so.2.5.9
```

**Hi√©rarchie des liens :**
1. `libfbclient.so` ‚Üí Lien pour le d√©veloppement
2. `libfbclient.so.2` ‚Üí Lien pour la version majeure
3. `libfbclient.so.2.5.9` ‚Üí Fichier r√©el

**Cr√©er un lien symbolique manuellement :**
```bash
# Cr√©er un lien
sudo ln -s /usr/lib/x86_64-linux-gnu/libfbclient.so.2 /usr/local/lib/libfbclient.so

# V√©rifier
ls -l /usr/local/lib/libfbclient.so

# Mettre √† jour le cache
sudo ldconfig
```

## D√©tection automatique dans FreePascal

### Fonction de recherche multi-emplacements

```pascal
function FindLinuxLibrary(const LibName: string): string;  
var
  SearchPaths: array of string;
  Path: string;
  I: Integer;
begin
  Result := '';

  {$IFDEF LINUX}
  // Construire la liste des chemins √† chercher
  SetLength(SearchPaths, 6);

  // R√©pertoire de l'application
  SearchPaths[0] := ExtractFilePath(ParamStr(0)) + LibName;

  // Chemins syst√®me standard pour architecture 64 bits
  SearchPaths[1] := '/usr/lib/x86_64-linux-gnu/' + LibName;
  SearchPaths[2] := '/usr/lib/' + LibName;
  SearchPaths[3] := '/usr/local/lib/' + LibName;

  // Chemin optionnel
  SearchPaths[4] := '/opt/firebird/lib/' + LibName;

  // Laisser le syst√®me chercher (nom seul)
  SearchPaths[5] := LibName;

  // Chercher dans tous les emplacements
  for I := 0 to High(SearchPaths) do
  begin
    Path := SearchPaths[I];

    // Pour le dernier cas (nom seul), on retourne directement
    if I = High(SearchPaths) then
    begin
      Result := Path;
      Exit;
    end;

    // V√©rifier si le fichier existe
    if FileExists(Path) then
    begin
      Result := Path;
      Exit;
    end;
  end;
  {$ENDIF}
end;
```

**Utilisation :**
```pascal
var
  FirebirdLib: string;
begin
  FirebirdLib := FindLinuxLibrary('libfbclient.so.2');

  if FirebirdLib <> '' then
  begin
    IBConnection1.Params.Add('ClientLibrary=' + FirebirdLib);
    WriteLn('Biblioth√®que trouv√©e : ', FirebirdLib);
  end
  else
    raise Exception.Create('Biblioth√®que Firebird introuvable');
end;
```

### D√©tection de l'architecture

```pascal
function GetLinuxArchitecture: string;  
var
  Process: TProcess;
  OutputList: TStringList;
begin
  Result := 'x86_64-linux-gnu';  // Valeur par d√©faut

  {$IFDEF LINUX}
  Process := TProcess.Create(nil);
  OutputList := TStringList.Create;
  try
    Process.Executable := 'dpkg';
    Process.Parameters.Add('--print-architecture');
    Process.Options := [poWaitOnExit, poUsePipes];
    Process.Execute;

    OutputList.LoadFromStream(Process.Output);

    if OutputList.Count > 0 then
    begin
      // Convertir l'architecture Debian en chemin de biblioth√®que
      case Trim(OutputList[0]) of
        'amd64': Result := 'x86_64-linux-gnu';
        'i386': Result := 'i386-linux-gnu';
        'arm64': Result := 'aarch64-linux-gnu';
        'armhf': Result := 'arm-linux-gnueabihf';
      end;
    end;
  finally
    OutputList.Free;
    Process.Free;
  end;
  {$ENDIF}
end;
```

**Utilisation :**
```pascal
var
  Arch, LibPath: string;
begin
  Arch := GetLinuxArchitecture;
  LibPath := '/usr/lib/' + Arch + '/libfbclient.so';

  WriteLn('Architecture : ', Arch);
  WriteLn('Chemin biblioth√®que : ', LibPath);
end;
```

### V√©rification des d√©pendances

```pascal
function CheckLibraryDependencies(const LibPath: string): TStringList;  
var
  Process: TProcess;
begin
  Result := TStringList.Create;

  {$IFDEF LINUX}
  Process := TProcess.Create(nil);
  try
    Process.Executable := 'ldd';
    Process.Parameters.Add(LibPath);
    Process.Options := [poWaitOnExit, poUsePipes];
    Process.Execute;

    Result.LoadFromStream(Process.Output);
  finally
    Process.Free;
  end;
  {$ENDIF}
end;
```

**Utilisation :**
```pascal
var
  Dependencies: TStringList;
begin
  Dependencies := CheckLibraryDependencies('/usr/lib/x86_64-linux-gnu/libfbclient.so');
  try
    WriteLn('D√©pendances de libfbclient.so :');
    WriteLn(Dependencies.Text);
  finally
    Dependencies.Free;
  end;
end;
```

## Gestion des permissions

### Permissions des biblioth√®ques

Les biblioth√®ques Linux ont des permissions sp√©cifiques :

```bash
# Afficher les permissions
ls -l /usr/lib/x86_64-linux-gnu/libfbclient.so.2

# Sortie typique :
# -rw-r--r-- 1 root root 584616 Jan 15 10:30 libfbclient.so.2
```

**Explication des permissions :**
- `rw-` : Le propri√©taire (root) peut lire et √©crire
- `r--` : Le groupe peut lire
- `r--` : Les autres peuvent lire

**Modifier les permissions (si n√©cessaire) :**
```bash
# Rendre ex√©cutable (rarement n√©cessaire pour .so)
sudo chmod 755 /usr/local/lib/custom.so

# Permissions standards pour une biblioth√®que
sudo chmod 644 /usr/local/lib/custom.so
```

### Propri√©taire et groupe

```bash
# V√©rifier le propri√©taire
ls -l /usr/lib/x86_64-linux-gnu/libfbclient.so.2

# Changer le propri√©taire (si n√©cessaire)
sudo chown root:root /usr/local/lib/custom.so
```

## D√©bogage des probl√®mes de biblioth√®ques

### Probl√®me : "Cannot load library"

**Erreur typique :**
```
Error: Cannot load library "libfbclient.so": libfbclient.so:  
cannot open shared object file: No such file or directory
```

**Solutions :**

1. **V√©rifier que la biblioth√®que est install√©e :**
```bash
dpkg -l | grep firebird  
sudo apt install firebird3.0-client
```

2. **V√©rifier le chemin :**
```bash
find /usr -name "libfbclient.so*" 2>/dev/null
```

3. **V√©rifier le cache ldconfig :**
```bash
ldconfig -p | grep fbclient
```

4. **Ajouter au cache si n√©cessaire :**
```bash
sudo nano /etc/ld.so.conf.d/firebird.conf
# Ajouter : /usr/lib/x86_64-linux-gnu
sudo ldconfig
```

### Probl√®me : Version incompatible

**Erreur typique :**
```
Error: /usr/lib/libfbclient.so.2: version 'FBCLIENT_2.5' not found
```

**Solutions :**

1. **V√©rifier les versions disponibles :**
```bash
ls -l /usr/lib/x86_64-linux-gnu/libfbclient*
```

2. **Installer la bonne version :**
```bash
sudo apt install firebird3.0-client
```

3. **Cr√©er un lien symbolique (temporaire) :**
```bash
sudo ln -s /usr/lib/x86_64-linux-gnu/libfbclient.so.3 /usr/lib/libfbclient.so.2
```

### Probl√®me : Architecture incorrecte

**Erreur typique :**
```
Error: wrong ELF class: ELFCLASS32
```

**Cause :** Tentative d'utiliser une biblioth√®que 32 bits avec un programme 64 bits (ou inverse).

**Solutions :**

1. **V√©rifier l'architecture de votre programme :**
```bash
file MonApplication
# Sortie : ELF 64-bit LSB executable
```

2. **V√©rifier l'architecture de la biblioth√®que :**
```bash
file /usr/lib/x86_64-linux-gnu/libfbclient.so.2
# Sortie : ELF 64-bit LSB shared object
```

3. **Installer la bonne architecture :**
```bash
# Pour 64 bits
sudo apt install firebird3.0-client:amd64

# Pour 32 bits
sudo dpkg --add-architecture i386  
sudo apt update  
sudo apt install firebird3.0-client:i386
```

### Outil de d√©bogage : strace

`strace` permet de voir tous les appels syst√®me, y compris la recherche de biblioth√®ques :

```bash
# Tracer les appels √† open() pour voir les tentatives de chargement
strace -e open,openat ./MonApplication 2>&1 | grep "\.so"

# Sortie exemple :
# openat(AT_FDCWD, "/usr/lib/x86_64-linux-gnu/libfbclient.so.2", O_RDONLY) = 3
```

## Configuration centralis√©e pour application multi-base

### Module de configuration r√©utilisable

```pascal
unit LinuxDatabaseLibs;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils;

type
  TDatabaseType = (dtFirebird, dtMySQL, dtPostgreSQL, dtSQLite);

  TLinuxLibConfig = record
    LibraryName: string;
    SearchPaths: array of string;
    PackageName: string;
  end;

function GetLinuxLibraryPath(DBType: TDatabaseType): string;  
function GetInstallCommand(DBType: TDatabaseType): string;

implementation

function GetLibConfig(DBType: TDatabaseType): TLinuxLibConfig;  
var
  Arch: string;
begin
  Arch := 'x86_64-linux-gnu';  // Simplification, √† adapter

  case DBType of
    dtFirebird:
    begin
      Result.LibraryName := 'libfbclient.so.2';
      SetLength(Result.SearchPaths, 3);
      Result.SearchPaths[0] := '/usr/lib/' + Arch + '/';
      Result.SearchPaths[1] := '/usr/local/lib/';
      Result.SearchPaths[2] := '/opt/firebird/lib/';
      Result.PackageName := 'firebird3.0-client';
    end;

    dtMySQL:
    begin
      Result.LibraryName := 'libmysqlclient.so.21';
      SetLength(Result.SearchPaths, 2);
      Result.SearchPaths[0] := '/usr/lib/' + Arch + '/';
      Result.SearchPaths[1] := '/usr/local/lib/';
      Result.PackageName := 'libmysqlclient21';
    end;

    dtPostgreSQL:
    begin
      Result.LibraryName := 'libpq.so.5';
      SetLength(Result.SearchPaths, 2);
      Result.SearchPaths[0] := '/usr/lib/' + Arch + '/';
      Result.SearchPaths[1] := '/usr/local/lib/';
      Result.PackageName := 'libpq5';
    end;

    dtSQLite:
    begin
      Result.LibraryName := 'libsqlite3.so.0';
      SetLength(Result.SearchPaths, 2);
      Result.SearchPaths[0] := '/usr/lib/' + Arch + '/';
      Result.SearchPaths[1] := '/usr/local/lib/';
      Result.PackageName := 'libsqlite3-0';
    end;
  end;
end;

function GetLinuxLibraryPath(DBType: TDatabaseType): string;  
var
  Config: TLinuxLibConfig;
  Path: string;
  FullPath: string;
begin
  Result := '';
  Config := GetLibConfig(DBType);

  // Chercher dans tous les emplacements
  for Path in Config.SearchPaths do
  begin
    FullPath := Path + Config.LibraryName;
    if FileExists(FullPath) then
    begin
      Result := FullPath;
      Exit;
    end;
  end;

  // Si non trouv√©, retourner juste le nom (recherche syst√®me)
  Result := Config.LibraryName;
end;

function GetInstallCommand(DBType: TDatabaseType): string;  
var
  Config: TLinuxLibConfig;
begin
  Config := GetLibConfig(DBType);
  Result := 'sudo apt install ' + Config.PackageName;
end;

end.
```

**Utilisation dans votre application :**

```pascal
uses
  LinuxDatabaseLibs;

procedure ConfigurerFirebird;  
var
  LibPath: string;
begin
  {$IFDEF LINUX}
  LibPath := GetLinuxLibraryPath(dtFirebird);

  if not FileExists(LibPath) then
  begin
    ShowMessage('Biblioth√®que Firebird non trouv√©e. Installez avec : ' +
                GetInstallCommand(dtFirebird));
    Exit;
  end;

  IBConnection1.Params.Add('ClientLibrary=' + LibPath);
  WriteLn('Firebird configur√© : ', LibPath);
  {$ENDIF}
end;
```

## Bonnes pratiques Linux

### 1. Utiliser les paquets officiels

‚úÖ **RECOMMAND√â :**
```bash
sudo apt install firebird3.0-client
```

‚ùå **√Ä √âVITER (sauf n√©cessit√©) :**
```bash
# T√©l√©charger et compiler depuis les sources
```

**Pourquoi ?** Les paquets officiels :
- Sont test√©s et stables
- Se mettent √† jour automatiquement
- Respectent les conventions syst√®me
- G√®rent les d√©pendances

### 2. Ne pas utiliser LD_LIBRARY_PATH en production

‚úÖ **RECOMMAND√â :**
```bash
sudo nano /etc/ld.so.conf.d/custom.conf  
sudo ldconfig
```

‚ùå **√Ä √âVITER en production :**
```bash
export LD_LIBRARY_PATH=/custom/path:$LD_LIBRARY_PATH
```

**Pourquoi ?** `LD_LIBRARY_PATH` peut :
- Causer des conflits de versions
- √ätre oubli√© lors du d√©ploiement
- Affecter tous les programmes

### 3. V√©rifier les d√©pendances avant distribution

```bash
# Liste compl√®te des biblioth√®ques n√©cessaires
ldd ./MonApplication

# V√©rifier qu'elles sont toutes disponibles
ldd ./MonApplication | grep "not found"
```

Si cette commande affiche des r√©sultats, des biblioth√®ques manquent.

### 4. Documenter les d√©pendances

Cr√©ez un fichier `INSTALL.md` ou `README.md` :

````markdown
## Installation des d√©pendances (Ubuntu/Debian)

```bash
# Firebird
sudo apt install firebird3.0-client

# MySQL
sudo apt install libmysqlclient21

# PostgreSQL
sudo apt install libpq5

# SQLite
sudo apt install libsqlite3-0
```

## Installation des d√©pendances (Red Hat/Fedora)

```bash
sudo dnf install firebird-libfbclient  
sudo dnf install mysql-libs  
sudo dnf install postgresql-libs  
sudo dnf install sqlite-libs
```
````

### 5. Tester sur diff√©rentes distributions

Les chemins peuvent varier selon la distribution :

| Distribution | Firebird |
|-------------|----------|
| Ubuntu/Debian | `/usr/lib/x86_64-linux-gnu/libfbclient.so.2` |
| Fedora/RHEL | `/usr/lib64/libfbclient.so.2` |
| Arch Linux | `/usr/lib/libfbclient.so` |
| openSUSE | `/usr/lib64/libfbclient.so.2` |

**Solution :** Utiliser la recherche automatique plut√¥t que des chemins cod√©s en dur.

### 6. G√©rer les versions multiples

Si plusieurs versions doivent coexister :

```bash
# Installer une version sp√©cifique
sudo apt install firebird3.0-client=3.0.7.33374-0ubuntu0.20.04.1

# Emp√™cher les mises √† jour automatiques
sudo apt-mark hold firebird3.0-client

# Permettre √† nouveau les mises √† jour
sudo apt-mark unhold firebird3.0-client
```

### 7. Utiliser alternatives pour g√©rer les versions

```bash
# Cr√©er des alternatives pour plusieurs versions
sudo update-alternatives --install /usr/lib/libfbclient.so libfbclient \
    /usr/lib/x86_64-linux-gnu/libfbclient.so.2 20

sudo update-alternatives --install /usr/lib/libfbclient.so libfbclient \
    /usr/lib/x86_64-linux-gnu/libfbclient.so.3 30

# Choisir la version √† utiliser
sudo update-alternatives --config libfbclient

# Afficher la version active
update-alternatives --display libfbclient
```

## D√©ploiement d'applications

### M√©thode 1 : Installation des paquets (recommand√©)

**Script d'installation :**

```bash
#!/bin/bash
# install.sh

echo "Installation des d√©pendances..."

# D√©tecter la distribution
if [ -f /etc/debian_version ]; then
    # Debian/Ubuntu
    sudo apt update
    sudo apt install -y firebird3.0-client libmysqlclient21 libpq5
elif [ -f /etc/redhat-release ]; then
    # Red Hat/Fedora/CentOS
    sudo dnf install -y firebird-libfbclient mysql-libs postgresql-libs
elif [ -f /etc/arch-release ]; then
    # Arch Linux
    sudo pacman -S --noconfirm libfbclient libmysqlclient postgresql-libs
else
    echo "Distribution non support√©e"
    exit 1
fi

echo "Installation termin√©e !"
```

**Rendre le script ex√©cutable :**
```bash
chmod +x install.sh
```

### M√©thode 2 : Biblioth√®ques embarqu√©es

Pour une application autonome, embarquez les biblioth√®ques :

**Structure du d√©ploiement :**
```
MonApplication/
‚îú‚îÄ‚îÄ MonApplication                    # Ex√©cutable
‚îú‚îÄ‚îÄ lib/                             # Biblioth√®ques embarqu√©es
‚îÇ   ‚îú‚îÄ‚îÄ libfbclient.so.2
‚îÇ   ‚îú‚îÄ‚îÄ libmysqlclient.so.21
‚îÇ   ‚îî‚îÄ‚îÄ libpq.so.5
‚îú‚îÄ‚îÄ data/                            # Donn√©es
‚îî‚îÄ‚îÄ run.sh                           # Script de lancement
```

**Script de lancement (run.sh) :**
```bash
#!/bin/bash

# Obtenir le r√©pertoire du script
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Ajouter le r√©pertoire lib au chemin de recherche
export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"

# Lancer l'application
"$DIR/MonApplication" "$@"
```

**Configuration dans FreePascal pour utiliser lib/ :**
```pascal
function GetEmbeddedLibPath(const LibName: string): string;  
var
  AppDir: string;
begin
  AppDir := ExtractFilePath(ParamStr(0));
  Result := AppDir + 'lib/' + LibName;

  if not FileExists(Result) then
    Result := LibName;  // Fallback sur recherche syst√®me
end;

// Utilisation
{$IFDEF LINUX}
IBConnection1.Params.Add('ClientLibrary=' + GetEmbeddedLibPath('libfbclient.so.2'));
{$ENDIF}
```

### M√©thode 3 : AppImage

AppImage permet de distribuer une application Linux compl√®te en un seul fichier :

**Structure AppImage :**
```
AppDir/
‚îú‚îÄ‚îÄ AppRun                           # Script de lancement
‚îú‚îÄ‚îÄ MonApplication.desktop           # Fichier desktop
‚îú‚îÄ‚îÄ MonApplication.png               # Ic√¥ne
‚îú‚îÄ‚îÄ usr/
‚îÇ   ‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MonApplication          # Votre ex√©cutable
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îú‚îÄ‚îÄ libfbclient.so.2
‚îÇ       ‚îî‚îÄ‚îÄ ...
```

**Script AppRun :**
```bash
#!/bin/bash

SELF=$(readlink -f "$0")  
HERE=${SELF%/*}

export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"  
export PATH="${HERE}/usr/bin:${PATH}"

exec "${HERE}/usr/bin/MonApplication" "$@"
```

**Cr√©er l'AppImage :**
```bash
# T√©l√©charger l'outil
wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage  
chmod +x appimagetool-x86_64.AppImage

# Cr√©er l'AppImage
./appimagetool-x86_64.AppImage AppDir MonApplication.AppImage
```

### M√©thode 4 : Paquet DEB

Cr√©er un paquet Debian pour faciliter l'installation :

**Structure du projet :**
```
monapp_1.0-1/
‚îú‚îÄ‚îÄ DEBIAN/
‚îÇ   ‚îú‚îÄ‚îÄ control              # M√©tadonn√©es
‚îÇ   ‚îú‚îÄ‚îÄ postinst            # Script post-installation
‚îÇ   ‚îî‚îÄ‚îÄ prerm               # Script pr√©-d√©sinstallation
‚îî‚îÄ‚îÄ usr/
    ‚îú‚îÄ‚îÄ bin/
    ‚îÇ   ‚îî‚îÄ‚îÄ monapp
    ‚îî‚îÄ‚îÄ share/
        ‚îî‚îÄ‚îÄ monapp/
            ‚îî‚îÄ‚îÄ data/
```

**Fichier control :**
```
Package: monapp  
Version: 1.0-1  
Section: database  
Priority: optional  
Architecture: amd64  
Depends: firebird3.0-client, libmysqlclient21, libpq5  
Maintainer: Votre Nom <email@example.com>  
Description: Mon Application de Base de Donn√©es
 Description longue de l'application
```

**Cr√©er le paquet :**
```bash
dpkg-deb --build monapp_1.0-1
```

**Installer :**
```bash
sudo dpkg -i monapp_1.0-1.deb  
sudo apt-get install -f  # R√©soudre les d√©pendances
```

## Tests et validation

### Script de test des biblioth√®ques

```bash
#!/bin/bash
# test_libs.sh

echo "Test des biblioth√®ques de bases de donn√©es..."  
echo "=============================================="

# Firebird
echo -n "Firebird: "  
if ldconfig -p | grep -q "libfbclient.so"; then
    LIB=$(ldconfig -p | grep "libfbclient.so" | awk '{print $NF}' | head -1)
    echo "‚úì Trouv√© - $LIB"
else
    echo "‚úó Non trouv√©"
fi

# MySQL
echo -n "MySQL: "  
if ldconfig -p | grep -q "libmysqlclient.so"; then
    LIB=$(ldconfig -p | grep "libmysqlclient.so" | awk '{print $NF}' | head -1)
    echo "‚úì Trouv√© - $LIB"
else
    echo "‚úó Non trouv√©"
fi

# PostgreSQL
echo -n "PostgreSQL: "  
if ldconfig -p | grep -q "libpq.so"; then
    LIB=$(ldconfig -p | grep "libpq.so" | awk '{print $NF}' | head -1)
    echo "‚úì Trouv√© - $LIB"
else
    echo "‚úó Non trouv√©"
fi

# SQLite
echo -n "SQLite: "  
if ldconfig -p | grep -q "libsqlite3.so"; then
    LIB=$(ldconfig -p | grep "libsqlite3.so" | awk '{print $NF}' | head -1)
    echo "‚úì Trouv√© - $LIB"
else
    echo "‚úó Non trouv√©"
fi

echo "=============================================="
```

### Programme FreePascal de test

```pascal
program TestLibs;

{$mode objfpc}{$H+}

uses
  SysUtils;

function TestLibrary(const LibName, DisplayName: string): Boolean;  
var
  Handle: TLibHandle;
begin
  Result := False;
  Write(DisplayName, ': ');

  Handle := LoadLibrary(LibName);
  if Handle <> 0 then
  begin
    WriteLn('‚úì OK');
    FreeLibrary(Handle);
    Result := True;
  end
  else
    WriteLn('‚úó ERREUR - ', GetLoadErrorStr);
end;

var
  AllOK: Boolean;
begin
  WriteLn('Test de chargement des biblioth√®ques');
  WriteLn('====================================');

  AllOK := True;

  {$IFDEF LINUX}
  AllOK := TestLibrary('libfbclient.so.2', 'Firebird') and AllOK;
  AllOK := TestLibrary('libmysqlclient.so.21', 'MySQL') and AllOK;
  AllOK := TestLibrary('libpq.so.5', 'PostgreSQL') and AllOK;
  AllOK := TestLibrary('libsqlite3.so.0', 'SQLite') and AllOK;
  {$ENDIF}

  WriteLn('====================================');

  if AllOK then
  begin
    WriteLn('Toutes les biblioth√®ques sont disponibles !');
    Halt(0);
  end
  else
  begin
    WriteLn('Certaines biblioth√®ques sont manquantes.');
    Halt(1);
  end;
end.
```

**Compilation et ex√©cution :**
```bash
fpc TestLibs.pas
./TestLibs
```

## Cas particuliers et situations avanc√©es

### Biblioth√®ques dans des emplacements non standard

Si une biblioth√®que est dans un emplacement inhabituel :

**Option 1 : RPATH (compilation) :**
```bash
# Compiler avec RPATH
fpc -k-rpath -k/opt/custom/lib MonApplication.pas
```

**Option 2 : Wrapper dynamique :**
```pascal
function LoadDynamicLibrary(const LibName: string): TLibHandle;  
var
  CustomPaths: array[0..2] of string;
  I: Integer;
  FullPath: string;
begin
  Result := 0;

  CustomPaths[0] := '/opt/custom/lib/';
  CustomPaths[1] := '/usr/local/custom/';
  CustomPaths[2] := ExtractFilePath(ParamStr(0)) + 'lib/';

  for I := Low(CustomPaths) to High(CustomPaths) do
  begin
    FullPath := CustomPaths[I] + LibName;
    if FileExists(FullPath) then
    begin
      Result := LoadLibrary(FullPath);
      if Result <> 0 then Exit;
    end;
  end;

  // Tentative avec le nom seul (recherche syst√®me)
  Result := LoadLibrary(LibName);
end;
```

### Utilisation de versions multiples simultan√©ment

Parfois, diff√©rentes parties d'une application doivent utiliser diff√©rentes versions :

```pascal
type
  TFirebirdVersion = (fbV2, fbV3, fbV4);

function GetFirebirdLibrary(Version: TFirebirdVersion): string;  
begin
  case Version of
    fbV2: Result := '/usr/lib/x86_64-linux-gnu/libfbclient.so.2';
    fbV3: Result := '/usr/lib/x86_64-linux-gnu/libfbclient.so.3';
    fbV4: Result := '/usr/lib/x86_64-linux-gnu/libfbclient.so.4';
  end;
end;

// Utilisation avec des connexions diff√©rentes
procedure ConfigurerConnexions;  
begin
  // Connexion vers base Firebird 2.5
  IBConnection1.Params.Add('ClientLibrary=' + GetFirebirdLibrary(fbV2));

  // Connexion vers base Firebird 3.0
  IBConnection2.Params.Add('ClientLibrary=' + GetFirebirdLibrary(fbV3));
end;
```

### Environnements conteneuris√©s (Docker)

Dans un conteneur Docker, simplifiez la gestion :

**Dockerfile :**
```dockerfile
FROM ubuntu:22.04

# Installation des d√©pendances
RUN apt-get update && apt-get install -y \
    firebird3.0-client \
    libmysqlclient21 \
    libpq5 \
    libsqlite3-0 \
    && rm -rf /var/lib/apt/lists/*

# Copier l'application
COPY MonApplication /app/  
WORKDIR /app

# Lancer l'application
CMD ["./MonApplication"]
```

Dans ce cas, pas besoin de configuration sp√©ciale, les biblioth√®ques sont au bon endroit.

## Outils de diagnostic

### Script complet de diagnostic

```bash
#!/bin/bash
# diagnose_libs.sh

echo "=== Diagnostic des biblioth√®ques de bases de donn√©es ==="  
echo ""

# Fonction pour tester une biblioth√®que
check_lib() {
    local lib_pattern=$1
    local lib_name=$2

    echo "--- $lib_name ---"

    # Recherche dans ldconfig
    echo "Cache ldconfig:"
    ldconfig -p | grep "$lib_pattern" || echo "  Non trouv√© dans le cache"
    echo ""

    # Recherche dans le syst√®me de fichiers
    echo "Fichiers syst√®me:"
    find /usr/lib /usr/local/lib -name "*${lib_pattern}*" 2>/dev/null || echo "  Aucun fichier trouv√©"
    echo ""

    # Paquet Debian associ√©
    echo "Paquet Debian/Ubuntu:"
    dpkg -l | grep -i "$lib_pattern" 2>/dev/null || echo "  Aucun paquet install√©"
    echo ""
}

# Architecture syst√®me
echo "Architecture:"  
uname -m  
dpkg --print-architecture 2>/dev/null || echo "dpkg non disponible"  
echo ""

# Tests par biblioth√®que
check_lib "libfbclient" "Firebird"  
check_lib "libmysqlclient\|libmariadb" "MySQL/MariaDB"  
check_lib "libpq" "PostgreSQL"  
check_lib "libsqlite3" "SQLite"

# Variables d'environnement
echo "--- Variables d'environnement ---"  
echo "LD_LIBRARY_PATH: ${LD_LIBRARY_PATH:-<non d√©fini>}"  
echo ""

# Configuration ldconfig
echo "--- Configuration ldconfig ---"  
echo "Fichiers de configuration:"  
ls -l /etc/ld.so.conf.d/ 2>/dev/null || echo "R√©pertoire non accessible"  
echo ""

echo "=== Fin du diagnostic ==="
```

**Utilisation :**
```bash
chmod +x diagnose_libs.sh
./diagnose_libs.sh > diagnostic.txt
```

## Tableau r√©capitulatif des chemins

| Base de donn√©es | Biblioth√®que | Chemin typique Ubuntu/Debian | Paquet |
|----------------|--------------|----------------------------|---------|
| **Firebird 2.5** | `libfbclient.so.2` | `/usr/lib/x86_64-linux-gnu/` | `firebird2.5-client` |
| **Firebird 3.0** | `libfbclient.so.3` | `/usr/lib/x86_64-linux-gnu/` | `firebird3.0-client` |
| **MySQL 5.7** | `libmysqlclient.so.20` | `/usr/lib/x86_64-linux-gnu/` | `libmysqlclient20` |
| **MySQL 8.0** | `libmysqlclient.so.21` | `/usr/lib/x86_64-linux-gnu/` | `libmysqlclient21` |
| **MariaDB** | `libmariadb.so.3` | `/usr/lib/x86_64-linux-gnu/` | `libmariadb3` |
| **PostgreSQL 12** | `libpq.so.5` | `/usr/lib/x86_64-linux-gnu/` | `libpq5` |
| **PostgreSQL 14+** | `libpq.so.5` | `/usr/lib/x86_64-linux-gnu/` | `libpq5` |
| **SQLite 3** | `libsqlite3.so.0` | `/usr/lib/x86_64-linux-gnu/` | `libsqlite3-0` |

## Ressources suppl√©mentaires

### Documentation Linux

- **Manual pages :**
  ```bash
  man ldconfig
  man ld.so
  man ldd
  man dlopen
  ```

- **FHS (Filesystem Hierarchy Standard) :**
  https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html

### Outils utiles

```bash
# Installation des outils de d√©veloppement
sudo apt install build-essential

# Installation d'outils de diagnostic
sudo apt install binutils ltrace strace

# Afficher les symboles d'une biblioth√®que
nm -D /usr/lib/x86_64-linux-gnu/libfbclient.so.2

# Afficher les sections d'une biblioth√®que
objdump -x /usr/lib/x86_64-linux-gnu/libfbclient.so.2

# V√©rifier les d√©pendances
ldd /usr/lib/x86_64-linux-gnu/libfbclient.so.2
```

### Documentation des bases de donn√©es

- **Firebird :** https://firebirdsql.org/en/reference-manuals/
- **MySQL :** https://dev.mysql.com/doc/
- **PostgreSQL :** https://www.postgresql.org/docs/
- **SQLite :** https://www.sqlite.org/docs.html

## Conclusion

La gestion des biblioth√®ques partag√©es sous Linux est un aspect fondamental du d√©veloppement multi-plateforme. Les points cl√©s √† retenir :

‚úÖ **Utiliser les chemins standards** : `/usr/lib/x86_64-linux-gnu/` pour Debian/Ubuntu

‚úÖ **Privil√©gier les paquets officiels** : Installation via `apt` ou √©quivalent

‚úÖ **Configurer ldconfig** : Pour les biblioth√®ques dans des emplacements personnalis√©s

‚úÖ **√âviter LD_LIBRARY_PATH** : Sauf pour le d√©veloppement temporaire

‚úÖ **Impl√©menter la d√©tection automatique** : Votre application doit trouver les biblioth√®ques elle-m√™me

‚úÖ **Documenter les d√©pendances** : Cr√©er des scripts d'installation clairs

‚úÖ **Tester sur diff√©rentes distributions** : Les chemins peuvent varier

En suivant ces principes et en utilisant les techniques pr√©sent√©es dans ce document, vous serez capable de cr√©er des applications FreePascal/Lazarus qui fonctionnent de mani√®re fiable sur diverses distributions Linux, tout en g√©rant correctement les connexions aux bases de donn√©es.

‚è≠Ô∏è [ZEOS DBO pour acc√®s universel](/08-bases-donnees-orm-multiplatefomes/04-zeos-dbo-acces-universel.md)
