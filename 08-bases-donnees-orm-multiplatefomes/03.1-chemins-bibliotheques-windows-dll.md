üîù Retour au [Sommaire](/SOMMAIRE.md)

# 8.3.1 Chemins de biblioth√®ques Windows (.dll)

## Introduction

Lorsque vous d√©veloppez une application FreePascal/Lazarus qui utilise des bases de donn√©es sur Windows, vous devez comprendre comment le syst√®me charge les biblioth√®ques dynamiques (fichiers `.dll`). Ces fichiers contiennent le code n√©cessaire pour communiquer avec votre base de donn√©es.

## Qu'est-ce qu'une DLL ?

Une **DLL** (Dynamic Link Library) est un fichier contenant du code et des donn√©es qui peuvent √™tre utilis√©s par plusieurs programmes simultan√©ment. Pour les bases de donn√©es, ces DLLs contiennent les pilotes clients permettant √† votre application de se connecter au serveur de base de donn√©es.

### Exemples de DLLs courantes

- **PostgreSQL** : `libpq.dll`
- **MySQL/MariaDB** : `libmysql.dll` ou `libmariadb.dll`
- **SQLite** : `sqlite3.dll`
- **Firebird** : `fbclient.dll` ou `gds32.dll`

## Comment Windows recherche les DLLs

Windows suit un ordre de recherche pr√©cis pour localiser une DLL :

1. **Le r√©pertoire de l'application** (o√π se trouve votre `.exe`)
2. **Le r√©pertoire syst√®me** (`C:\Windows\System32`)
3. **Le r√©pertoire Windows** (`C:\Windows`)
4. **Le r√©pertoire courant** (working directory)
5. **Les r√©pertoires list√©s dans la variable d'environnement PATH**

### Sch√©ma de recherche

```
Application.exe demande libpq.dll
    ‚Üì
1. Recherche dans C:\MonApp\ (r√©pertoire de l'exe)
    ‚Üì Non trouv√©
2. Recherche dans C:\Windows\System32\
    ‚Üì Non trouv√©
3. Recherche dans C:\Windows\
    ‚Üì Non trouv√©
4. Recherche dans les dossiers du PATH
    ‚Üì Non trouv√©
5. ERREUR : "libpq.dll introuvable"
```

## M√©thodes de configuration

### M√©thode 1 : Placer la DLL √† c√¥t√© de l'ex√©cutable (Recommand√©e)

C'est la m√©thode la plus simple et la plus s√ªre pour distribuer votre application.

**Avantages :**
- Pas de conflit avec d'autres versions de la DLL
- Facilite le d√©ploiement (un seul dossier √† copier)
- Fonctionne sans droits administrateur
- Pas de modification du syst√®me

**Structure de dossier :**
```
MonApplication\
‚îú‚îÄ‚îÄ MonApp.exe
‚îú‚îÄ‚îÄ libpq.dll          ‚Üê DLL PostgreSQL
‚îú‚îÄ‚îÄ libmysql.dll       ‚Üê DLL MySQL
‚îî‚îÄ‚îÄ sqlite3.dll        ‚Üê DLL SQLite
```

### M√©thode 2 : Utiliser un sous-dossier relatif

Pour mieux organiser vos fichiers, vous pouvez cr√©er un sous-dossier pour les DLLs.

**Structure recommand√©e :**
```
MonApplication\
‚îú‚îÄ‚îÄ MonApp.exe
‚îú‚îÄ‚îÄ libs\
‚îÇ   ‚îú‚îÄ‚îÄ libpq.dll
‚îÇ   ‚îú‚îÄ‚îÄ libmysql.dll
‚îÇ   ‚îî‚îÄ‚îÄ sqlite3.dll
‚îî‚îÄ‚îÄ data\
    ‚îî‚îÄ‚îÄ config.ini
```

**Code FreePascal pour charger depuis un sous-dossier :**

```pascal
uses
  SysUtils, Forms;

procedure ConfigurerCheminsDLL;  
var
  CheminLibs: string;
begin
  // Obtenir le chemin du dossier de l'application
  CheminLibs := ExtractFilePath(Application.ExeName) + 'libs';

  // Ajouter ce chemin √† la recherche Windows
  SetDllDirectory(PChar(CheminLibs));
end;

// √Ä appeler au d√©marrage de l'application
begin
  ConfigurerCheminsDLL;
  Application.Initialize;
  // ... reste du code
end.
```

### M√©thode 3 : Modifier la variable PATH

Vous pouvez ajouter un r√©pertoire au PATH de Windows pour que toutes les applications puissent trouver vos DLLs.

**Option A : PATH utilisateur (recommand√©)**

1. Ouvrir les **Param√®tres syst√®me avanc√©s**
2. Cliquer sur **Variables d'environnement**
3. Dans la section **Variables utilisateur**, s√©lectionner **Path**
4. Cliquer sur **Modifier**
5. Ajouter le chemin : `C:\Programmes\PostgreSQL\14\bin`

**Option B : Par programmation (temporaire)**

```pascal
uses
  SysUtils;

procedure AjouterCheminDLL(const NouveauChemin: string);  
var
  PathActuel: string;
begin
  PathActuel := GetEnvironmentVariable('PATH');
  SetEnvironmentVariable('PATH',
    PChar(NouveauChemin + ';' + PathActuel));
end;

// Utilisation
begin
  AjouterCheminDLL('C:\MesDLLs');
  // Maintenant Windows trouvera les DLLs dans ce dossier
end;
```

**‚ö†Ô∏è Attention :** Cette modification est temporaire et ne dure que le temps d'ex√©cution du programme.

### M√©thode 4 : Sp√©cifier le chemin dans le composant de connexion

Certains composants Lazarus permettent de sp√©cifier directement le chemin de la DLL.

**Exemple avec SQLdb et PostgreSQL :**

```pascal
uses
  PQConnection;

procedure ConfigurerConnexionPostgreSQL;  
begin
  PQConnection1.DatabaseName := 'ma_base';
  PQConnection1.HostName := 'localhost';
  PQConnection1.UserName := 'postgres';

  // Sp√©cifier le chemin complet de la DLL
  PQConnection1.Params.Values['ClientLibrary'] :=
    'C:\MonApp\libs\libpq.dll';

  PQConnection1.Connected := True;
end;
```

**Exemple avec ZEOS :**

```pascal
uses
  ZConnection;

procedure ConfigurerConnexionZEOS;  
begin
  ZConnection1.Protocol := 'postgresql-9';
  ZConnection1.Database := 'ma_base';

  // D√©finir la biblioth√®que client
  ZConnection1.LibraryLocation :=
    ExtractFilePath(Application.ExeName) + 'libs\libpq.dll';

  ZConnection1.Connected := True;
end;
```

## V√©rification et diagnostic

### V√©rifier qu'une DLL est pr√©sente

```pascal
uses
  SysUtils, Windows;

function DLLEstDisponible(const NomDLL: string): Boolean;  
var
  Handle: THandle;
begin
  Handle := LoadLibrary(PChar(NomDLL));
  Result := Handle <> 0;
  if Result then
    FreeLibrary(Handle);
end;

// Utilisation
begin
  if DLLEstDisponible('libpq.dll') then
    ShowMessage('PostgreSQL client trouv√© !')
  else
    ShowMessage('Erreur : libpq.dll introuvable');
end;
```

### Afficher le chemin complet d'une DLL charg√©e

```pascal
uses
  SysUtils, Windows;

function ObtenirCheminDLL(const NomDLL: string): string;  
var
  Handle: THandle;
  Buffer: array[0..MAX_PATH] of Char;
begin
  Result := '';
  Handle := GetModuleHandle(PChar(NomDLL));
  if Handle <> 0 then
  begin
    if GetModuleFileName(Handle, Buffer, MAX_PATH) > 0 then
      Result := Buffer;
  end;
end;

// Utilisation
begin
  ShowMessage('PostgreSQL charg√© depuis : ' +
    ObtenirCheminDLL('libpq.dll'));
end;
```

## Gestion des versions de DLL

### Probl√®me des versions multiples

Windows peut avoir plusieurs versions de la m√™me DLL install√©es :
- Dans `System32` : version syst√®me (souvent ancienne)
- Dans `Program Files\PostgreSQL\14\bin` : version r√©cente
- Dans votre application : version sp√©cifique

### Solution : Versionnement explicite

**Bonne pratique :**
```
MonApplication\
‚îú‚îÄ‚îÄ MonApp.exe
‚îî‚îÄ‚îÄ libs\
    ‚îú‚îÄ‚îÄ postgresql-14\
    ‚îÇ   ‚îî‚îÄ‚îÄ libpq.dll      (version 14.x)
    ‚îî‚îÄ‚îÄ mysql-8\
        ‚îî‚îÄ‚îÄ libmysql.dll   (version 8.x)
```

```pascal
const
  VERSION_POSTGRESQL = '14';

function CheminDLLPostgreSQL: string;  
begin
  Result := ExtractFilePath(Application.ExeName) +
    'libs\postgresql-' + VERSION_POSTGRESQL + '\libpq.dll';
end;
```

## Architectures 32-bit vs 64-bit

**R√®gle importante :** Votre application et les DLLs doivent avoir la m√™me architecture.

- Application **32-bit** ‚Üí DLLs **32-bit**
- Application **64-bit** ‚Üí DLLs **64-bit**

### Organisation recommand√©e pour compatibilit√© multi-architecture

```
MonApplication\
‚îú‚îÄ‚îÄ MonApp32.exe           (version 32-bit)
‚îú‚îÄ‚îÄ MonApp64.exe           (version 64-bit)
‚îî‚îÄ‚îÄ libs\
    ‚îú‚îÄ‚îÄ x86\               (DLLs 32-bit)
    ‚îÇ   ‚îú‚îÄ‚îÄ libpq.dll
    ‚îÇ   ‚îî‚îÄ‚îÄ libmysql.dll
    ‚îî‚îÄ‚îÄ x64\               (DLLs 64-bit)
        ‚îú‚îÄ‚îÄ libpq.dll
        ‚îî‚îÄ‚îÄ libmysql.dll
```

**Code pour d√©tecter et charger la bonne version :**

```pascal
uses
  SysUtils;

function EstApplication64Bit: Boolean;  
begin
  {$IFDEF CPU64}
  Result := True;
  {$ELSE}
  Result := False;
  {$ENDIF}
end;

function CheminDLLsParArchitecture: string;  
begin
  Result := ExtractFilePath(Application.ExeName) + 'libs\';
  if EstApplication64Bit then
    Result := Result + 'x64\'
  else
    Result := Result + 'x86\';
end;

// Utilisation au d√©marrage
begin
  SetDllDirectory(PChar(CheminDLLsParArchitecture));
end;
```

## Erreurs courantes et solutions

### Erreur : "Impossible de charger libpq.dll"

**Causes possibles :**
1. La DLL n'est pas pr√©sente dans les chemins de recherche
2. Architecture incompatible (32-bit vs 64-bit)
3. D√©pendances manquantes (la DLL a besoin d'autres DLLs)

**Solution :**
```pascal
uses
  Dialogs, SysUtils;

procedure VerifierPresenceDLL;  
const
  DLLS_REQUISES: array[0..2] of string = (
    'libpq.dll',
    'libeay32.dll',    // D√©pendance OpenSSL
    'ssleay32.dll'     // D√©pendance OpenSSL
  );
var
  i: Integer;
  Manquantes: string;
begin
  Manquantes := '';
  for i := 0 to High(DLLS_REQUISES) do
  begin
    if not DLLEstDisponible(DLLS_REQUISES[i]) then
      Manquantes := Manquantes + DLLS_REQUISES[i] + #13#10;
  end;

  if Manquantes <> '' then
  begin
    ShowMessage('DLLs manquantes :'#13#10 + Manquantes);
    Halt(1);
  end;
end;
```

### Erreur : "Point d'entr√©e introuvable dans la DLL"

**Cause :** Version de la DLL incompatible avec le code.

**Solution :** Utiliser la version correcte de la DLL (v√©rifier la documentation du composant).

## D√©ploiement de l'application

### Checklist de d√©ploiement

Avant de distribuer votre application :

1. ‚úÖ Copier toutes les DLLs n√©cessaires
2. ‚úÖ V√©rifier l'architecture (32-bit ou 64-bit)
3. ‚úÖ Inclure les d√©pendances (OpenSSL, Visual C++ Runtime)
4. ‚úÖ Tester sur une machine "propre" (sans outils de d√©veloppement)
5. ‚úÖ Documenter les DLLs incluses et leurs versions

### Script de pr√©paration

```pascal
// CopierDLLs.pas - Utilitaire pour pr√©parer le d√©ploiement

uses
  SysUtils, Classes;

procedure CopierDLLsNecessaires;  
const
  SOURCE_DLLS = 'C:\Developpement\libs\';
  DEST_DLLS = '.\deploy\libs\';

  FICHIERS: array[0..2] of string = (
    'libpq.dll',
    'libeay32.dll',
    'ssleay32.dll'
  );
var
  i: Integer;
begin
  ForceDirectories(DEST_DLLS);

  for i := 0 to High(FICHIERS) do
  begin
    WriteLn('Copie de ', FICHIERS[i], '...');
    CopyFile(
      PChar(SOURCE_DLLS + FICHIERS[i]),
      PChar(DEST_DLLS + FICHIERS[i]),
      False
    );
  end;

  WriteLn('Copie termin√©e !');
end;

begin
  CopierDLLsNecessaires;
end.
```

## Bonnes pratiques

1. **Toujours inclure les DLLs avec l'application** plut√¥t que de compter sur l'installation syst√®me
2. **Versionner les DLLs** dans votre syst√®me de contr√¥le de version
3. **Documenter les versions** utilis√©es dans un fichier README ou VERSIONS.txt
4. **Tester sur diff√©rentes versions** de Windows (7, 10, 11)
5. **Pr√©voir un m√©canisme de mise √† jour** des DLLs si n√©cessaire

## R√©sum√©

Les DLLs Windows sont essentielles pour la connexion aux bases de donn√©es. Les points cl√©s √† retenir :

- **Privil√©giez le placement √† c√¥t√© de l'ex√©cutable** pour la simplicit√©
- **Respectez l'architecture** (32-bit avec 32-bit, 64-bit avec 64-bit)
- **Incluez toutes les d√©pendances** (OpenSSL, etc.)
- **Testez avant de d√©ployer** sur une machine sans environnement de d√©veloppement
- **Utilisez `SetDllDirectory`** pour pointer vers un dossier sp√©cifique si besoin

Avec ces connaissances, vous √™tes maintenant capable de g√©rer efficacement les biblioth√®ques DLL dans vos applications FreePascal/Lazarus sous Windows.

‚è≠Ô∏è [Chemins de biblioth√®ques Linux (.so)](/08-bases-donnees-orm-multiplatefomes/03.2-chemins-bibliotheques-linux-so.md)
