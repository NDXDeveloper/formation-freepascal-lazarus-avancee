üîù Retour au [Sommaire](/SOMMAIRE.md)

# 24.8.1 Cross-compilation Windows ‚Üí Linux

## Introduction

La cross-compilation consiste √† compiler un programme sur une plateforme (ici Windows) pour qu'il s'ex√©cute sur une autre plateforme (Linux). Cette technique est particuli√®rement utile lorsque vous d√©veloppez sous Windows mais devez d√©ployer votre application sur des serveurs Linux, ou simplement pour tester votre application sur Linux sans changer constamment de syst√®me d'exploitation.

FreePascal excelle dans ce domaine gr√¢ce √† son architecture modulaire et son support natif de multiples plateformes cibles.

## Pr√©requis

Avant de commencer la cross-compilation, assurez-vous d'avoir :

1. **FreePascal install√© sur Windows** (version 3.2.0 ou sup√©rieure recommand√©e)
2. **Lazarus IDE** (optionnel mais recommand√© pour faciliter la configuration)
3. **Un cross-compilateur FPC pour Linux** (nous verrons comment l'obtenir)
4. **Suffisamment d'espace disque** (environ 500 MB pour les biblioth√®ques cross-platform)

## Comprendre les architectures cibles

Linux peut tourner sur diff√©rentes architectures. Les plus courantes sont :

- **x86_64** (ou AMD64) : Architecture 64 bits, la plus r√©pandue sur les serveurs et PC modernes
- **i386** : Architecture 32 bits, de moins en moins utilis√©e mais encore pr√©sente
- **ARM** : Pour les syst√®mes embarqu√©s comme Raspberry Pi

Pour ce tutoriel, nous nous concentrerons sur **x86_64**, qui est l'architecture standard pour Ubuntu moderne.

## Installation du cross-compilateur

### M√©thode 1 : Utiliser fpcupdeluxe (Recommand√© pour d√©butants)

**fpcupdeluxe** est un installeur graphique qui simplifie grandement l'installation des cross-compilateurs.

1. **T√©l√©charger fpcupdeluxe** :
   - Rendez-vous sur : https://github.com/LongDirtyAnimAlf/fpcupdeluxe/releases
   - T√©l√©chargez la version Windows (fichier `.exe`)

2. **Lancer fpcupdeluxe** :
   - Ex√©cutez le fichier t√©l√©charg√© (pas d'installation n√©cessaire)
   - √Ä la premi√®re utilisation, il vous demandera o√π installer FPC et Lazarus

3. **Installer le cross-compilateur Linux** :
   - Cliquez sur l'onglet **"Cross"**
   - Dans la liste des targets, s√©lectionnez **"x86_64-linux"**
   - Cliquez sur **"Install compiler"**
   - Attendez que l'installation se termine (cela peut prendre plusieurs minutes)

4. **Installer les biblioth√®ques syst√®me Linux** :
   - Toujours dans l'onglet "Cross"
   - Cliquez sur **"Install libraries"** pour la m√™me target
   - Cette √©tape t√©l√©charge les biblioth√®ques Linux n√©cessaires (.so)

### M√©thode 2 : Installation manuelle

Si vous pr√©f√©rez une installation manuelle ou si fpcupdeluxe ne fonctionne pas :

1. **T√©l√©charger les binaires cross** :
   - Visitez : https://sourceforge.net/projects/lazarus/files/Lazarus%20Linux%20amd64%20DEB/
   - Cherchez les paquets de cross-compilation pour votre version de FPC

2. **Extraire dans le bon r√©pertoire** :
   - Les fichiers doivent √™tre plac√©s dans le r√©pertoire d'installation de FPC
   - Typiquement : `C:\FPC\3.2.2\bin\x86_64-linux\`

3. **T√©l√©charger les biblioth√®ques Linux** :
   - Vous aurez besoin des fichiers `.so` (shared objects) de Linux
   - Cr√©ez un r√©pertoire : `C:\FPC\cross\lib\x86_64-linux\`
   - Placez-y les biblioth√®ques standard Linux (libc, libpthread, etc.)

## Configuration de Lazarus pour la cross-compilation

### √âtape 1 : V√©rifier l'installation

1. Ouvrez **Lazarus**
2. Allez dans **Outils ‚Üí Options**
3. Dans l'arborescence √† gauche, cliquez sur **Environnement ‚Üí Fichiers**
4. V√©rifiez que le **R√©pertoire du compilateur** pointe vers votre installation FPC

### √âtape 2 : Configurer les options de build

1. Ouvrez votre projet ou cr√©ez un nouveau projet de test
2. Allez dans **Projet ‚Üí Options du projet**
3. Dans **Options de compilation ‚Üí Chemins de recherche** :
   - V√©rifiez que les chemins sont corrects et utilisent des chemins relatifs quand c'est possible

### √âtape 3 : Configurer la cible de compilation

1. Toujours dans **Options du projet**
2. Allez dans **Options de compilation ‚Üí Config et Target**
3. Configurez :
   - **OS cible (-T)** : `linux`
   - **CPU cible (-P)** : `x86_64`
   - **LCL Widget Set** : `gtk2` (ou `qt5` selon vos pr√©f√©rences)

### √âtape 4 : Options de l'√©diteur de liens

1. Dans **Options de compilation ‚Üí √âdition de liens**
2. Cochez **"D√©bogue de l'√©dition de liens"** si vous souhaitez voir les d√©tails
3. Pour une application GUI, assurez-vous que **"√âliminer les symboles"** est d√©coch√© durant le d√©veloppement

## Compilation en ligne de commande

Pour un contr√¥le plus fin, vous pouvez compiler directement en ligne de commande.

### Compilation simple

Ouvrez **PowerShell** ou **CMD** dans le r√©pertoire de votre projet :

```batch
fpc -Tlinux -Px86_64 monprogramme.pas
```

**Explication des param√®tres** :
- `-Tlinux` : Syst√®me d'exploitation cible
- `-Px86_64` : Architecture processeur cible
- `monprogramme.pas` : Votre fichier source

### Compilation avec LCL (Interface graphique)

Pour une application Lazarus utilisant la LCL :

```batch
lazbuild --os=linux --cpu=x86_64 --ws=gtk2 monprojet.lpi
```

**Explication** :
- `--os=linux` : Syst√®me cible
- `--cpu=x86_64` : Architecture cible
- `--ws=gtk2` : Widget set (biblioth√®que d'interface)
- `monprojet.lpi` : Fichier projet Lazarus

### Options avanc√©es de compilation

```batch
fpc -Tlinux -Px86_64 ^
    -O3 ^
    -XX ^
    -CX ^
    -Fl/chemin/vers/libs/linux ^
    monprogramme.pas
```

**Explication des options** :
- `-O3` : Optimisation maximale
- `-XX` : Cr√©er un ex√©cutable smartlink√© (plus petit)
- `-CX` : Cr√©er un ex√©cutable smartlink√©
- `-Fl` : Sp√©cifier le chemin des biblioth√®ques Linux

## Gestion des d√©pendances

### Biblioth√®ques syst√®mes

Votre application Linux aura besoin de certaines biblioth√®ques :

**Pour une application console** :
- `libc.so.6` (biblioth√®que C standard)
- `libpthread.so.0` (threads POSIX)

**Pour une application GUI GTK2** :
- Toutes les biblioth√®ques GTK2 et leurs d√©pendances
- `libgtk-x11-2.0.so.0`
- `libgdk-x11-2.0.so.0`
- `libglib-2.0.so.0`
- Et bien d'autres...

**Pour une application GUI Qt5** :
- Biblioth√®ques Qt5 Core, Gui, Widgets
- Plus volumineuses mais plus modernes

### Sp√©cifier les chemins des biblioth√®ques

Dans **Options du projet ‚Üí Options de compilation ‚Üí Chemins de recherche** :

- **Chemin des biblioth√®ques (-Fl)** : Ajoutez le chemin vers vos biblioth√®ques Linux cross
  - Exemple : `C:\FPC\cross\lib\x86_64-linux`

## R√©solution des probl√®mes courants

### Erreur : "Can't find unit System"

**Cause** : Le compilateur ne trouve pas les unit√©s pour Linux.

**Solution** :
1. V√©rifiez que le cross-compilateur est bien install√©
2. Ajoutez le chemin des unit√©s Linux dans les options de compilation
3. Chemin typique : `C:\FPC\3.2.2\units\x86_64-linux\rtl`

### Erreur : "Can't find linker"

**Cause** : L'√©diteur de liens pour Linux n'est pas trouv√©.

**Solution** :
1. Assurez-vous que `ld` (l'√©diteur de liens) est dans votre installation cross
2. V√©rifiez le chemin dans **Outils ‚Üí Options ‚Üí Environnement ‚Üí Fichiers**

### Erreur : "Undefined symbol: ___gxx_personality_v0"

**Cause** : Probl√®me de linkage avec des biblioth√®ques C++.

**Solution** :
- Ajoutez l'option de compilation : `-k-lstdc++`
- Dans Lazarus : **Options du projet ‚Üí Options de compilation ‚Üí Personnalis√© ‚Üí Options Personnalis√©es**

### L'application compile mais ne d√©marre pas sur Linux

**Causes possibles** :
1. **Biblioth√®ques manquantes** sur le syst√®me Linux cible
2. **Architecture incorrecte** (32 bits vs 64 bits)
3. **Permissions d'ex√©cution** non d√©finies

**Solutions** :
1. Sur Linux, installez les biblioth√®ques n√©cessaires :
   ```bash
   sudo apt-get install libgtk2.0-0  # Pour GTK2
   sudo apt-get install libqt5widgets5  # Pour Qt5
   ```

2. V√©rifiez l'architecture de votre binaire compil√© :
   ```bash
   file votre_application
   ```

3. Donnez les permissions d'ex√©cution :
   ```bash
   chmod +x votre_application
   ```

## Exemple pratique complet

Cr√©ons une application simple qui affiche "Hello Cross-Compilation!".

### 1. Cr√©er le fichier source (hello.pas)

```pascal
program HelloCross;

{$mode objfpc}{$H+}

uses
  {$IFDEF UNIX}
  cthreads,
  {$ENDIF}
  SysUtils;

begin
  WriteLn('Hello Cross-Compilation!');
  WriteLn('Compil√© depuis Windows pour Linux');
  WriteLn('System: ', {$I %FPCTARGETOS%});
  WriteLn('CPU: ', {$I %FPCTARGETCPU%});

  WriteLn('Appuyez sur Entr√©e pour quitter...');
  ReadLn;
end.
```

### 2. Compiler pour Linux

```batch
fpc -Tlinux -Px86_64 hello.pas
```

### 3. Transf√©rer sur Linux

Utilisez l'une de ces m√©thodes :
- **Cl√© USB**
- **R√©seau partag√©** (SMB/NFS)
- **SCP/SFTP** si vous avez un serveur Linux accessible
- **Service cloud** (Dropbox, Google Drive, etc.)

### 4. Ex√©cuter sur Linux

```bash
chmod +x hello
./hello
```

Vous devriez voir :
```
Hello Cross-Compilation!
Compil√© depuis Windows pour Linux
System: linux
CPU: x86_64
Appuyez sur Entr√©e pour quitter...
```

## Automatisation avec des scripts

Pour faciliter le processus, cr√©ez un script batch `build_linux.bat` :

```batch
@echo off
echo ================================
echo  Cross-compilation pour Linux
echo ================================
echo.

set PROJECT=monprojet
set TARGET_OS=linux
set TARGET_CPU=x86_64
set WIDGET=gtk2

echo Compilation de %PROJECT% pour %TARGET_OS%/%TARGET_CPU%...
echo.

lazbuild --os=%TARGET_OS% --cpu=%TARGET_CPU% --ws=%WIDGET% %PROJECT%.lpi

if %errorlevel% equ 0 (
    echo.
    echo ================================
    echo  Compilation r√©ussie!
    echo ================================
    echo Binaire Linux cr√©√© : %PROJECT%
    echo.
    echo Transf√©rez-le sur votre syst√®me Linux et ex√©cutez :
    echo   chmod +x %PROJECT%
    echo   ./%PROJECT%
) else (
    echo.
    echo ================================
    echo  Erreur de compilation!
    echo ================================
    echo V√©rifiez les messages ci-dessus
)

pause
```

## Compilation conditionnelle multi-plateforme

Pour un code qui compile √† la fois pour Windows et Linux :

```pascal
program MultiPlatform;

{$mode objfpc}{$H+}

uses
  {$IFDEF UNIX}
  cthreads,
  {$ENDIF}
  SysUtils;

const
  {$IFDEF WINDOWS}
  CONFIG_PATH = 'C:\ProgramData\MonApp\';
  {$ENDIF}
  {$IFDEF LINUX}
  CONFIG_PATH = '/etc/monapp/';
  {$ENDIF}

procedure InitPlatform;
begin
  {$IFDEF WINDOWS}
  WriteLn('Initialisation pour Windows');
  // Code sp√©cifique Windows
  {$ENDIF}

  {$IFDEF LINUX}
  WriteLn('Initialisation pour Linux');
  // Code sp√©cifique Linux
  {$ENDIF}
end;

begin
  WriteLn('Application multi-plateforme');
  WriteLn('Chemin de configuration : ', CONFIG_PATH);
  InitPlatform;
end.
```

## Bonnes pratiques

### 1. Utilisez des chemins relatifs

```pascal
// Mauvais
const CONFIG_FILE = 'C:\Config\app.ini';

// Bon
const CONFIG_FILE = 'config' + PathDelim + 'app.ini';
```

### 2. Utilisez les constantes syst√®me

```pascal
uses
  SysUtils;

var
  ConfigDir: string;

begin
  // Chemin de configuration portable
  ConfigDir := GetAppConfigDir(False);
  WriteLn('Config dir: ', ConfigDir);

  // Sur Windows : C:\Users\Username\AppData\Local\VotreApp\
  // Sur Linux : /home/username/.config/votreapp/
end.
```

### 3. Testez les fins de ligne

```pascal
const
  {$IFDEF WINDOWS}
  LINE_ENDING = #13#10;  // CRLF
  {$ELSE}
  LINE_ENDING = #10;     // LF
  {$ENDIF}

// Ou plus simplement, utilisez la constante int√©gr√©e :
// LineEnding est d√©fini dans System, pas besoin de uses
WriteLn('Fin de ligne = ', LineEnding);
```

### 4. G√©rez les diff√©rences de casse

Linux est sensible √† la casse pour les noms de fichiers. Soyez coh√©rent :

```pascal
// Utilisez toujours la m√™me casse
uses
  SysUtils, Classes, Forms;  // Pas sysutils, CLASSES, forms
```

### 5. Cr√©ez des profils de compilation

Dans Lazarus, cr√©ez des configurations de build s√©par√©es :
- **Debug Windows**
- **Release Windows**
- **Debug Linux**
- **Release Linux**

Cela permet de basculer rapidement entre les cibles.

## Tester sans Linux physique

Si vous n'avez pas de machine Linux, plusieurs options s'offrent √† vous :

### Option 1 : Machine virtuelle

1. Installez **VirtualBox** (gratuit)
2. Cr√©ez une VM Ubuntu
3. Partagez un dossier entre Windows et la VM
4. Compilez sur Windows, testez dans la VM

### Option 2 : WSL2 (Windows Subsystem for Linux)

Windows 10/11 int√®gre WSL2 :

```powershell
# Dans PowerShell en admin
wsl --install
```

Puis acc√©dez √† vos fichiers Windows depuis WSL :
```bash
cd /mnt/c/Users/VotreNom/MonProjet
./monapp_linux
```

### Option 3 : Docker

Utilisez un conteneur Linux pour tester :

```dockerfile
FROM ubuntu:22.04
COPY ./monapp_linux /app/monapp
RUN chmod +x /app/monapp
CMD ["/app/monapp"]
```

## Conclusion

La cross-compilation Windows ‚Üí Linux avec FreePascal est un processus bien rod√© qui, une fois configur√©, devient tr√®s simple. Les principaux avantages :

‚úÖ **Pas besoin de changer de syst√®me** pour compiler  
‚úÖ **Workflow de d√©veloppement unifi√©**  
‚úÖ **Support natif de FPC**, pas de bidouille  
‚úÖ **M√™me code source** pour les deux plateformes  
‚úÖ **Gain de temps** consid√©rable

Avec l'exp√©rience, vous serez capable de maintenir des applications qui compilent et fonctionnent parfaitement sur Windows, Linux, macOS, et m√™me des syst√®mes embarqu√©s, le tout depuis un seul poste de d√©veloppement Windows.

N'h√©sitez pas √† exp√©rimenter et √† consulter la documentation officielle de FreePascal pour approfondir vos connaissances sur les options de compilation avanc√©es.

‚è≠Ô∏è [Linux ‚Üí Windows](/24-compilateur-outils-avances/08.2-linux-vers-windows.md)
