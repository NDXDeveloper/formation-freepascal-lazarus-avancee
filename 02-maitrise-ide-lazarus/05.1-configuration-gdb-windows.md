ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 2.5.1 Configuration GDB sur Windows

## Introduction : Le dÃ©fi GDB sur Windows

Configurer GDB sur Windows peut sembler intimidant au premier abord. Contrairement Ã  Linux oÃ¹ GDB est natif, Windows nÃ©cessite quelques Ã©tapes supplÃ©mentaires. Mais ne vous inquiÃ©tez pas ! Ce guide vous accompagnera pas Ã  pas pour obtenir un dÃ©bogueur parfaitement fonctionnel.

**Pourquoi c'est plus complexe sur Windows ?**
- Windows n'a pas GDB par dÃ©faut
- Plusieurs versions de GDB existent (MinGW, Cygwin, MSYS2)
- Les chemins Windows peuvent poser problÃ¨me
- L'antivirus peut interfÃ©rer
- Les permissions sont diffÃ©rentes de Linux

## Choisir la bonne version de GDB

### Les diffÃ©rentes distributions

```
Versions GDB pour Windows :
â”œâ”€â”€ MinGW-w64 (RecommandÃ©)
â”‚   â”œâ”€â”€ Le plus compatible avec Lazarus
â”‚   â”œâ”€â”€ Support 32 et 64 bits
â”‚   â””â”€â”€ Maintenu activement
â”œâ”€â”€ MSYS2
â”‚   â”œâ”€â”€ Plus rÃ©cent
â”‚   â”œâ”€â”€ Gestion de paquets pacman
â”‚   â””â”€â”€ Peut Ãªtre plus complexe
â”œâ”€â”€ Cygwin
â”‚   â”œâ”€â”€ Ã‰mulation Unix complÃ¨te
â”‚   â”œâ”€â”€ Plus lourd
â”‚   â””â”€â”€ Pas recommandÃ© pour Lazarus
â””â”€â”€ TDM-GCC
    â”œâ”€â”€ Bundle tout-en-un
    â”œâ”€â”€ Installation simple
    â””â”€â”€ Versions parfois anciennes
```

### Version recommandÃ©e pour Lazarus

**Pour la majoritÃ© des cas : MinGW-w64**

Lazarus inclut gÃ©nÃ©ralement une version de GDB avec son installation. VÃ©rifiez d'abord si vous l'avez dÃ©jÃ  :

```
C:\lazarus\mingw\x86_64-win64\bin\gdb.exe (64-bit)
C:\lazarus\mingw\i686-win32\bin\gdb.exe (32-bit)
```

## Installation de GDB

### MÃ©thode 1 : GDB inclus avec Lazarus (RecommandÃ©)

Si vous avez installÃ© Lazarus avec l'installateur complet, GDB est dÃ©jÃ  prÃ©sent !

**VÃ©rification :**
1. Ouvrez l'Explorateur Windows
2. Naviguez vers votre dossier Lazarus (gÃ©nÃ©ralement `C:\lazarus`)
3. Cherchez le dossier `mingw`
4. VÃ©rifiez la prÃ©sence de `gdb.exe` dans `bin`

### MÃ©thode 2 : Installation sÃ©parÃ©e de MinGW-w64

Si GDB n'est pas prÃ©sent ou si vous voulez une version plus rÃ©cente :

**Ã‰tapes d'installation :**

1. **TÃ©lÃ©charger MinGW-w64**
   - Site : https://www.mingw-w64.org/
   - Choisissez : "MingW-W64-builds"
   - Version : Latest
   - Architecture : x86_64 (pour Windows 64-bit)
   - Threads : posix
   - Exception : seh

2. **Installer MinGW-w64**
   ```
   Emplacement suggÃ©rÃ© : C:\mingw64
   â”œâ”€â”€ bin\
   â”‚   â”œâ”€â”€ gdb.exe
   â”‚   â”œâ”€â”€ gcc.exe
   â”‚   â””â”€â”€ autres outils...
   â”œâ”€â”€ include\
   â””â”€â”€ lib\
   ```

3. **Ajouter au PATH Windows**
   - Clic droit sur "Ce PC" â†’ PropriÃ©tÃ©s
   - ParamÃ¨tres systÃ¨me avancÃ©s
   - Variables d'environnement
   - Dans "Path", ajouter : `C:\mingw64\bin`

### MÃ©thode 3 : Via MSYS2 (Alternative moderne)

Pour ceux qui veulent la derniÃ¨re version :

1. **Installer MSYS2**
   - TÃ©lÃ©charger depuis : https://www.msys2.org/
   - Installer dans : `C:\msys64`

2. **Installer GDB via pacman**
   ```bash
   # Dans le terminal MSYS2
   pacman -S mingw-w64-x86_64-gdb
   ```

3. **GDB sera dans**
   ```
   C:\msys64\mingw64\bin\gdb.exe
   ```

## Configuration dans Lazarus

### AccÃ©der aux options du dÃ©bogueur

**Menu : Outils â†’ Options â†’ DÃ©bogueur**

```
â”Œâ”€ Options du DÃ©bogueur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type de dÃ©bogueur : [GNU debugger (gdb)    â–¼] â”‚
â”‚                                                 â”‚
â”‚ Chemin vers gdb:                               â”‚
â”‚ [C:\lazarus\mingw\x86_64-win64\bin\gdb.exe]   â”‚
â”‚ [Parcourir...]                                 â”‚
â”‚                                                 â”‚
â”‚ â˜‘ DÃ©bogueur dÃ©tectÃ© et fonctionnel âœ“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration de base

#### Onglet "GÃ©nÃ©ral"

```
Options gÃ©nÃ©rales GDB :
â”œâ”€â”€ Timeout de dÃ©marrage : [30] secondes
â”œâ”€â”€ â˜‘ ArrÃªter sur les exceptions
â”œâ”€â”€ â˜‘ RÃ©initialiser aprÃ¨s chaque run
â”œâ”€â”€ â˜ DÃ©sactiver LoadSymbolsForLibraries
â””â”€â”€ Encodage : [UTF-8]
```

**ğŸ’¡ Conseil** : Augmentez le timeout si vous avez un PC lent ou un gros projet.

#### Onglet "Signals"

Configuration des signaux Windows :

```
Gestion des signaux :
â”œâ”€â”€ SIGSEGV : [ArrÃªter] (Violations d'accÃ¨s)
â”œâ”€â”€ SIGFPE : [ArrÃªter] (Erreurs arithmÃ©tiques)
â”œâ”€â”€ SIGILL : [ArrÃªter] (Instructions illÃ©gales)
â””â”€â”€ SIGINT : [Ignorer] (Ctrl+C)
```

#### Onglet "OS Specific"

SpÃ©cifique Ã  Windows :

```
Options Windows :
â”œâ”€â”€ â˜‘ Nouveau mode console
â”œâ”€â”€ â˜ Utiliser les commandes Windows
â”œâ”€â”€ â˜‘ Rediriger la sortie console
â””â”€â”€ Type de shell : [cmd.exe]
```

### Test de la configuration

#### CrÃ©er un projet de test

```pascal
program TestDebug;
{$mode objfpc}{$H+}

uses
  SysUtils;

var
  i: Integer;
  s: string;

procedure TestProcedure;
begin
  WriteLn('Dans TestProcedure');
  s := 'Test rÃ©ussi';
end;

begin
  WriteLn('DÃ©but du programme');

  for i := 1 to 5 do
  begin
    WriteLn('ItÃ©ration ', i);
    if i = 3 then
      TestProcedure;
  end;

  WriteLn('Fin du programme');
  WriteLn('RÃ©sultat : ', s);
  ReadLn; // Pause pour voir le rÃ©sultat
end.
```

#### VÃ©rifier le fonctionnement

1. **Placer un point d'arrÃªt** : Cliquez dans la marge Ã  gauche de `WriteLn('ItÃ©ration ', i);`
2. **Lancer le dÃ©bogage** : F9
3. **Si tout fonctionne** : Le programme s'arrÃªte au point d'arrÃªt
4. **Continuer** : F9 pour reprendre l'exÃ©cution

## ProblÃ¨mes frÃ©quents et solutions

### ProblÃ¨me 1 : "GDB not found"

**SymptÃ´me :**
```
Debugger error
The debugger "C:\path\to\gdb.exe" was not found
```

**Solutions :**
1. VÃ©rifiez que le chemin est correct
2. Assurez-vous que gdb.exe existe Ã  cet emplacement
3. Testez avec le chemin complet sans espaces
4. Essayez avec des guillemets : `"C:\Program Files\gdb\gdb.exe"`

### ProblÃ¨me 2 : "Cannot create process"

**SymptÃ´me :**
```
The GDB command:
"-gdb-set confirm off"
returned the error:
"Cannot create process"
```

**Solutions :**
1. **Antivirus** : Ajoutez gdb.exe aux exclusions
2. **Permissions** : Lancez Lazarus en administrateur
3. **PATH** : VÃ©rifiez que le dossier bin est dans PATH
4. **CompatibilitÃ©** : PropriÃ©tÃ©s de gdb.exe â†’ CompatibilitÃ© â†’ Windows 7

### ProblÃ¨me 3 : Symboles de dÃ©bogage manquants

**SymptÃ´me :**
```
No symbol table is loaded
Use the "file" command
```

**Solution - Configuration du projet :**
```
Projet â†’ Options du projet â†’ Compilation et Ã©dition de liens
â”œâ”€â”€ â˜‘ GÃ©nÃ©rer infos de dÃ©bogage (-g)
â”œâ”€â”€ Type : [Dwarf with sets (-gw -godwarfsets)]
â”œâ”€â”€ â˜‘ Afficher numÃ©ros de ligne (-gl)
â”œâ”€â”€ â˜‘ Utiliser symboles externes (-Xg)
â””â”€â”€ â˜ Strip symbols (-Xs) - DOIT ÃŠTRE DÃ‰COCHÃ‰ !
```

### ProblÃ¨me 4 : CaractÃ¨res spÃ©ciaux et chemins

**SymptÃ´me :** Erreurs avec des chemins contenant des espaces ou accents

**Solutions :**

1. **Ã‰vitez les caractÃ¨res spÃ©ciaux** dans :
   - Le chemin d'installation de Lazarus
   - Le chemin de vos projets
   - Les noms de fichiers

2. **Utilisez des chemins courts** :
   ```
   Mauvais : C:\Mes Documents\DÃ©veloppement Pascal\Mon Super Projet\
   Bon : C:\Dev\Projects\MyProject\
   ```

3. **Format 8.3** (dernier recours) :
   ```cmd
   # Pour obtenir le nom court
   dir /x "C:\Program Files"
   # RÃ©sultat : PROGRA~1
   ```

### ProblÃ¨me 5 : Windows Defender bloque GDB

**SymptÃ´me :** GDB trÃ¨s lent ou bloquÃ©

**Solution complÃ¨te :**

1. **Exclusions Windows Defender**
   - ParamÃ¨tres â†’ Mise Ã  jour et sÃ©curitÃ©
   - SÃ©curitÃ© Windows â†’ Protection contre les virus
   - GÃ©rer les paramÃ¨tres â†’ Exclusions
   - Ajouter :
     ```
     C:\lazarus\
     C:\mingw64\
     %TEMP%\
     Vos dossiers de projets
     ```

2. **Exclusions de processus**
   - Ajouter les processus :
     ```
     gdb.exe
     lazarus.exe
     fpc.exe
     votre_programme.exe
     ```

## Configuration avancÃ©e

### Optimiser les performances

#### DÃ©sactiver les fonctionnalitÃ©s inutiles

```
Options â†’ DÃ©bogueur â†’ GÃ©nÃ©ral :
â”œâ”€â”€ â˜ Charger symboles pour toutes les DLL
â”œâ”€â”€ â˜ Mode verbose
â”œâ”€â”€ â˜‘ Cache des symboles
â””â”€â”€ Taille du cache : [100] MB
```

#### Configuration pour gros projets

```
Ajustements pour projets volumineux :
â”œâ”€â”€ Timeout : [60] secondes
â”œâ”€â”€ Max string length : [10000]
â”œâ”€â”€ Max array length : [1000]
â””â”€â”€ Max depth : [50]
```

### Scripts GDB personnalisÃ©s

CrÃ©ez un fichier `.gdbinit` dans votre dossier projet :

```gdb
# .gdbinit - Configuration personnalisÃ©e GDB
set print pretty on
set print array on
set print array-indexes on
set charset UTF-8
set breakpoint pending on
set confirm off

# Commandes personnalisÃ©es
define showpascalstring
  print (char*)$arg0+1@byte[$arg0[0]]
end
```

### DÃ©bogage 32-bit vs 64-bit

#### Configuration double architecture

```
Configuration multi-architecture :
â”œâ”€â”€ Projet 32-bit â†’ GDB 32-bit
â”‚   â””â”€â”€ C:\lazarus\mingw\i686-win32\bin\gdb.exe
â””â”€â”€ Projet 64-bit â†’ GDB 64-bit
    â””â”€â”€ C:\lazarus\mingw\x86_64-win64\bin\gdb.exe
```

**âš ï¸ Important** : Utilisez toujours le GDB correspondant Ã  votre architecture cible !

### Mode de compatibilitÃ©

Pour les anciens projets ou cas spÃ©ciaux :

```
Options â†’ DÃ©bogueur â†’ CompatibilitÃ© :
â”œâ”€â”€ â˜‘ Mode compatibilitÃ© Delphi
â”œâ”€â”€ â˜ DÃ©sactiver FPC extensions
â”œâ”€â”€ â˜‘ Auto SOLIB add
â””â”€â”€ Version GDB minimale : [7.0]
```

## IntÃ©gration avec l'environnement Windows

### Console Windows

#### Affichage de la console

```
Options du projet â†’ Options de compilation â†’ Config et cible :
â”œâ”€â”€ â˜‘ Application Win32 GUI (-WG)
â”‚   â””â”€â”€ Pas de console par dÃ©faut
â””â”€â”€ â˜ Application Win32 GUI (-WG)
    â””â”€â”€ Console visible pour WriteLn
```

Pour voir les `WriteLn` en mode GUI :
```pascal
{$APPTYPE CONSOLE}  // Force la console
// ou
AllocConsole;       // CrÃ©e une console dynamiquement
```

### DÃ©bogage de services Windows

Configuration spÃ©ciale pour les services :

1. **Attacher au processus**
   - Run â†’ Attach to process
   - SÃ©lectionner votre service
   - NÃ©cessite les privilÃ¨ges admin

2. **Simuler le service**
   ```pascal
   {$IFDEF DEBUG}
     // Mode debug : application normale
     Application.Run;
   {$ELSE}
     // Mode release : service Windows
     ServiceApplication.Run;
   {$ENDIF}
   ```

## Outils complÃ©mentaires

### GDB GUI alternatives

Si l'interface de Lazarus ne suffit pas :

```
Interfaces graphiques pour GDB :
â”œâ”€â”€ GDBgui (Web-based)
â”‚   â””â”€â”€ pip install gdbgui
â”œâ”€â”€ QtCreator
â”‚   â””â”€â”€ Peut dÃ©boguer des exe Pascal
â””â”€â”€ Visual Studio Code
    â””â”€â”€ Avec extension Native Debug
```

### Debugging Tools for Windows

Outils Microsoft complÃ©mentaires :

1. **WinDbg** : DÃ©bogueur systÃ¨me Windows
2. **Application Verifier** : DÃ©tection de bugs
3. **ProcMon** : Surveillance des processus
4. **DebugView** : Capture OutputDebugString

### Logging amÃ©liorÃ©

Pour complÃ©ter le dÃ©bogage :

```pascal
uses
  SysUtils, Windows;

procedure DebugLog(const Msg: string);
begin
  {$IFDEF DEBUG}
  OutputDebugString(PChar(FormatDateTime('hh:nn:ss.zzz ', Now) + Msg));
  {$ENDIF}
end;
```

Visualisez avec DebugView++ (gratuit).

## Bonnes pratiques Windows

### Organisation des fichiers

```
Structure recommandÃ©e :
MonProjet\
â”œâ”€â”€ bin\
â”‚   â”œâ”€â”€ Win32\
â”‚   â”‚   â”œâ”€â”€ Debug\
â”‚   â”‚   â””â”€â”€ Release\
â”‚   â””â”€â”€ Win64\
â”‚       â”œâ”€â”€ Debug\
â”‚       â””â”€â”€ Release\
â”œâ”€â”€ src\
â”œâ”€â”€ lib\
â””â”€â”€ .gdbinit
```

### Configuration par mode de build

#### Mode Debug
```ini
# project.lpi - Mode Debug
-g     # Symboles de debug
-gl    # NumÃ©ros de ligne
-gw3   # Format Dwarf 3
-godwarfsets # Types set
-gh    # Heaptrc
-Ci    # IO checks
-Co    # Overflow checks
-Cr    # Range checks
-Sa    # Assertions
```

#### Mode Release
```ini
# project.lpi - Mode Release
-O3    # Optimisation max
-Xs    # Strip symbols
-XX    # Smart linking
#-g    # PAS de symboles
```

### Automatisation avec batch

CrÃ©ez `debug.bat` pour lancer en mode debug :

```batch
@echo off
set LAZARUS_DIR=C:\lazarus
set PROJECT_NAME=MonProjet

echo Compilation en mode DEBUG...
%LAZARUS_DIR%\lazbuild.exe --build-mode=Debug %PROJECT_NAME%.lpi

if %ERRORLEVEL% == 0 (
    echo Lancement avec GDB...
    %LAZARUS_DIR%\mingw\x86_64-win64\bin\gdb.exe bin\Win64\Debug\%PROJECT_NAME%.exe
) else (
    echo Erreur de compilation!
    pause
)
```

## Checklist de vÃ©rification

Avant de commencer Ã  dÃ©boguer, vÃ©rifiez :

```
â˜ GDB est installÃ© et accessible
â˜ Le chemin vers GDB est configurÃ© dans Lazarus
â˜ Les symboles de debug sont activÃ©s (-g)
â˜ L'optimisation est dÃ©sactivÃ©e en debug (-O-)
â˜ L'antivirus a des exclusions pour GDB
â˜ Les chemins ne contiennent pas d'espaces/accents
â˜ Le projet compile sans erreurs
â˜ Les permissions sont suffisantes
â˜ La bonne architecture est sÃ©lectionnÃ©e (32/64)
â˜ Le mode de build est "Debug"
```

## Tester votre configuration

### Test simple

```pascal
program TestGDB;
{$mode objfpc}{$H+}
begin
  WriteLn('Si vous voyez ceci dans le dÃ©bogueur,');
  WriteLn('GDB fonctionne correctement!');
  ReadLn;
end.
```

1. Mettez un point d'arrÃªt sur le premier `WriteLn`
2. Lancez avec F9
3. Si le programme s'arrÃªte â†’ âœ… SuccÃ¨s !

### Test avancÃ©

```pascal
program TestGDBAdvanced;
{$mode objfpc}{$H+}
uses SysUtils, Classes;

type
  TTestClass = class
  private
    FValue: Integer;
  public
    constructor Create(AValue: Integer);
    property Value: Integer read FValue write FValue;
  end;

constructor TTestClass.Create(AValue: Integer);
begin
  FValue := AValue;  // Point d'arrÃªt ici
end;

var
  Test: TTestClass;
  List: TStringList;
  i: Integer;

begin
  Test := TTestClass.Create(42);
  List := TStringList.Create;
  try
    for i := 1 to 10 do
      List.Add(Format('Item %d', [i]));

    WriteLn('Test.Value = ', Test.Value);
    WriteLn('List.Count = ', List.Count);

    // Testez l'inspection des variables ici
    ReadLn;
  finally
    List.Free;
    Test.Free;
  end;
end.
```

Si vous pouvez :
- Voir la valeur de `FValue` dans le constructeur
- Inspecter le contenu de `List`
- Naviguer dans la pile d'appels

â†’ Votre configuration est parfaite ! ğŸ‰

## Conclusion

La configuration de GDB sur Windows demande un peu de patience, mais une fois en place, vous disposez d'un outil de dÃ©bogage extrÃªmement puissant. Les problÃ¨mes initiaux sont gÃ©nÃ©ralement liÃ©s aux chemins, aux permissions ou Ã  l'antivirus. Une fois ces obstacles franchis, GDB sur Windows est aussi efficace que sur Linux.

**Points clÃ©s Ã  retenir :**
- Utilisez de prÃ©fÃ©rence le GDB fourni avec Lazarus
- Ã‰vitez les espaces et caractÃ¨res spÃ©ciaux dans les chemins
- Configurez les exclusions antivirus
- Utilisez la bonne architecture (32/64 bits)
- Activez toujours les symboles de debug en dÃ©veloppement

Dans la section suivante (2.5.2), nous verrons la configuration sur Ubuntu/Linux, qui est gÃ©nÃ©ralement plus simple mais offre des possibilitÃ©s supplÃ©mentaires.

â­ï¸ [Configuration GDB sur Ubuntu](/02-maitrise-ide-lazarus/05.2-configuration-gdb-ubuntu.md)
