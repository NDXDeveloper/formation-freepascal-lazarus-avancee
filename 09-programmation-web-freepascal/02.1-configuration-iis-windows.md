üîù Retour au [Sommaire](/SOMMAIRE.md)

# 9.2.1 Configuration IIS (Windows)

## Introduction √† IIS

**IIS** (Internet Information Services) est le serveur web professionnel de Microsoft, int√©gr√© √† Windows. C'est une solution puissante, gratuite et parfaitement int√©gr√©e √† l'√©cosyst√®me Windows, ce qui en fait un choix naturel pour d√©ployer des applications FreePascal sur cette plateforme.

### Qu'est-ce qu'IIS ?

IIS est bien plus qu'un simple serveur web :
- **Serveur HTTP/HTTPS** complet avec support SSL/TLS
- **Gestionnaire d'applications** CGI et FastCGI
- **Reverse proxy** et load balancer
- **Interface d'administration** graphique intuitive
- **Int√©gration Windows** (authentification, permissions, logs)

### Versions d'IIS

| Version | Syst√®me d'exploitation | Remarques |
|---------|------------------------|-----------|
| IIS 7.5 | Windows 7 / Server 2008 R2 | Ancienne mais stable |
| IIS 8.0 | Windows 8 / Server 2012 | Support WebSocket |
| IIS 8.5 | Windows 8.1 / Server 2012 R2 | Am√©lioration performances |
| IIS 10.0 | Windows 10 / Server 2016/2019/2022 | **Recommand√©** |

**Note importante** : IIS n'est **pas install√© par d√©faut** sur Windows. Il faut l'activer manuellement.

## Installation d'IIS sur Windows

### V√©rifier si IIS est install√©

1. Ouvrir un navigateur web
2. Aller √† l'adresse : `http://localhost`
3. Si une page IIS s'affiche ‚Üí IIS est d√©j√† install√©
4. Sinon ‚Üí Continuer l'installation

### Installation sur Windows 10/11 (version Desktop)

#### M√©thode 1 : Interface graphique (recommand√©e pour d√©butants)

**√âtape 1 : Ouvrir les fonctionnalit√©s Windows**

1. Appuyer sur `Windows + R`
2. Taper : `optionalfeatures` et valider
3. Ou : Panneau de configuration ‚Üí Programmes ‚Üí Activer ou d√©sactiver des fonctionnalit√©s Windows

**√âtape 2 : Activer IIS**

Dans la fen√™tre "Fonctionnalit√©s de Windows" :

1. Cocher **Internet Information Services**
2. D√©velopper le n≈ìud et cocher :
   - ‚úÖ **Services World Wide Web**
     - ‚úÖ **Fonctionnalit√©s de d√©veloppement d'applications**
       - ‚úÖ **CGI** (essentiel pour applications FreePascal)
       - ‚úÖ **Extensions ISAPI**
       - ‚úÖ **Filtres ISAPI**
     - ‚úÖ **Fonctionnalit√©s HTTP communes**
       - ‚úÖ **Document par d√©faut**
       - ‚úÖ **Exploration de r√©pertoires**
       - ‚úÖ **Erreurs HTTP**
       - ‚úÖ **Contenu statique**
   - ‚úÖ **Outils de gestion du Web**
     - ‚úÖ **Console de gestion IIS**

3. Cliquer sur **OK**
4. Attendre l'installation (peut prendre 2-5 minutes)
5. Red√©marrer l'ordinateur (recommand√©)

**√âtape 3 : V√©rification**

1. Ouvrir un navigateur
2. Aller √† `http://localhost`
3. Vous devriez voir une page "Welcome to IIS"

#### M√©thode 2 : PowerShell (pour utilisateurs avanc√©s)

Ouvrir PowerShell **en tant qu'administrateur** et ex√©cuter :

```powershell
# Installation d'IIS avec CGI
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole
Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServer
Enable-WindowsOptionalFeature -Online -FeatureName IIS-CommonHttpFeatures
Enable-WindowsOptionalFeature -Online -FeatureName IIS-HttpErrors
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ApplicationDevelopment
Enable-WindowsOptionalFeature -Online -FeatureName IIS-CGI
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ISAPIExtensions
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ISAPIFilter
Enable-WindowsOptionalFeature -Online -FeatureName IIS-ManagementConsole
```

### Installation sur Windows Server

Sur Windows Server, IIS s'installe via le **Gestionnaire de serveur** :

1. Ouvrir le **Gestionnaire de serveur**
2. Cliquer sur **G√©rer** ‚Üí **Ajouter des r√¥les et fonctionnalit√©s**
3. Suivre l'assistant :
   - Type d'installation : **Installation bas√©e sur un r√¥le ou une fonctionnalit√©**
   - S√©lectionner le serveur
   - R√¥les de serveurs : Cocher **Serveur Web (IIS)**
4. Dans **Services de r√¥le**, s√©lectionner :
   - ‚úÖ **CGI** (dans D√©veloppement d'applications)
   - ‚úÖ **Console de gestion IIS**
5. Cliquer sur **Installer**

## Gestionnaire IIS (IIS Manager)

### Acc√©der au Gestionnaire IIS

**M√©thode 1** : Recherche Windows
1. Appuyer sur la touche `Windows`
2. Taper : `IIS`
3. Cliquer sur **Gestionnaire des services Internet (IIS)**

**M√©thode 2** : Panneau de configuration
1. Panneau de configuration ‚Üí Outils d'administration
2. Double-cliquer sur **Gestionnaire des services Internet (IIS)**

**M√©thode 3** : Commande directe
1. `Windows + R`
2. Taper : `inetmgr`
3. Valider

### Interface du Gestionnaire IIS

L'interface est divis√©e en trois zones :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Gestionnaire des services Internet (IIS)           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ               ‚îÇ                 ‚îÇ                   ‚îÇ
‚îÇ  Arborescence ‚îÇ  Vue centrale   ‚îÇ  Actions          ‚îÇ
‚îÇ               ‚îÇ                 ‚îÇ                   ‚îÇ
‚îÇ  - Serveur    ‚îÇ  Sites Web      ‚îÇ  - D√©marrer       ‚îÇ
‚îÇ    - Sites    ‚îÇ  Pools d'app.   ‚îÇ  - Arr√™ter        ‚îÇ
‚îÇ    - App Pools‚îÇ  Param√®tres     ‚îÇ  - Red√©marrer     ‚îÇ
‚îÇ               ‚îÇ                 ‚îÇ  - Parcourir      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Arborescence** (gauche) : Navigation dans les sites et applications  
**Vue centrale** : Ic√¥nes des fonctionnalit√©s disponibles  
**Actions** (droite) : Actions contextuelles selon la s√©lection  

## Structure des r√©pertoires IIS

### R√©pertoire par d√©faut

**Emplacement** : `C:\inetpub\wwwroot\`

C'est le r√©pertoire racine du site web par d√©faut. Tout fichier plac√© ici est accessible via `http://localhost/`.

### Structure recommand√©e pour applications FreePascal

```
C:\inetpub\
‚îú‚îÄ‚îÄ wwwroot\                    (site par d√©faut)
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ apps\                       (vos applications)
‚îÇ   ‚îú‚îÄ‚îÄ monapp\
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bin\               (ex√©cutables FreePascal)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.exe
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.ini
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ public\            (fichiers statiques)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css\
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ js\
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ images\
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logs\              (fichiers de log)
‚îÇ   ‚îî‚îÄ‚îÄ autreapp\
‚îî‚îÄ‚îÄ logs\                       (logs IIS)
```

## Configuration d'une application CGI FreePascal

### √âtape 1 : Cr√©er l'application FreePascal

**Fichier : `webapp.lpr`**

```pascal
program WebAppCGI;

{$mode objfpc}{$H+}

uses
  SysUtils;

function GetCGIVar(const VarName: String): String;
begin
  Result := GetEnvironmentVariable(VarName);
end;

var
  Name: String;

begin
  // En-t√™tes HTTP
  WriteLn('Content-Type: text/html; charset=utf-8');
  WriteLn;

  // R√©cup√©rer le param√®tre 'name' de l'URL
  Name := GetCGIVar('QUERY_STRING');
  if Pos('name=', Name) > 0 then
    Name := Copy(Name, Pos('name=', Name) + 5, 100)
  else
    Name := 'Visiteur';

  // G√©n√©rer la page HTML
  WriteLn('<!DOCTYPE html>');
  WriteLn('<html>');
  WriteLn('<head>');
  WriteLn('  <title>Application FreePascal sur IIS</title>');
  WriteLn('  <meta charset="utf-8">');
  WriteLn('</head>');
  WriteLn('<body>');
  WriteLn('  <h1>Bienvenue ', Name, ' !</h1>');
  WriteLn('  <p>Cette application tourne sur IIS avec FreePascal.</p>');
  WriteLn('  <p>URL: ', GetCGIVar('REQUEST_URI'), '</p>');
  WriteLn('  <p>M√©thode: ', GetCGIVar('REQUEST_METHOD'), '</p>');
  WriteLn('  <p>Serveur: ', GetCGIVar('SERVER_SOFTWARE'), '</p>');
  WriteLn('</body>');
  WriteLn('</html>');
end.
```

**Compilation** :

```cmd
fpc -MObjFPC -Scghi webapp.lpr
```

Cela g√©n√®re : `webapp.exe`

### √âtape 2 : D√©ployer l'application

1. Cr√©er le r√©pertoire : `C:\inetpub\apps\monapp\bin\`
2. Copier `webapp.exe` dans ce r√©pertoire

### √âtape 3 : Cr√©er un r√©pertoire virtuel dans IIS

**Via le Gestionnaire IIS** :

1. Ouvrir le **Gestionnaire IIS**
2. Dans l'arborescence, d√©velopper **Sites** ‚Üí **Default Web Site**
3. Clic droit sur **Default Web Site** ‚Üí **Ajouter un r√©pertoire virtuel...**
4. Remplir :
   - **Alias** : `monapp` (nom dans l'URL)
   - **Chemin d'acc√®s physique** : `C:\inetpub\apps\monapp\bin\`
5. Cliquer sur **OK**

**Via PowerShell** :

```powershell
New-WebVirtualDirectory -Site "Default Web Site" `
  -Name "monapp" `
  -PhysicalPath "C:\inetpub\apps\monapp\bin"
```

### √âtape 4 : Configurer le gestionnaire CGI

1. Dans le Gestionnaire IIS, s√©lectionner le r√©pertoire virtuel **monapp**
2. Double-cliquer sur **Mappages de gestionnaires** (Handler Mappings)
3. Dans le panneau **Actions** (√† droite), cliquer sur **Ajouter un mappage de script...**
4. Remplir :
   - **Chemin de la demande** : `*.exe`
   - **Ex√©cutable** : `C:\Windows\System32\inetsrv\cgi.dll`
   - **Nom** : `FreePascal CGI`
5. Cliquer sur **OK**
6. √Ä l'invite "Voulez-vous autoriser cette extension ISAPI ?", cliquer **Oui**

**R√©sultat** : Toutes les requ√™tes vers des `.exe` seront trait√©es comme des programmes CGI.

### √âtape 5 : Configurer les permissions

Les applications CGI ont besoin de droits d'ex√©cution :

1. Dans le Gestionnaire IIS, s√©lectionner **monapp**
2. Double-cliquer sur **Autorisations du gestionnaire** (Handler Permissions)
3. Dans **Actions**, cliquer sur **Modifier les autorisations de fonctionnalit√©**
4. Cocher : **Lecture**, **Script**, **Ex√©cuter**
5. Cliquer sur **OK**

**Ou via PowerShell** :

```powershell
Set-WebConfigurationProperty -Filter "system.webServer/handlers" `
  -Name "accessPolicy" `
  -Value "Read,Script,Execute" `
  -PSPath "IIS:\Sites\Default Web Site\monapp"
```

### √âtape 6 : Tester l'application

1. Ouvrir un navigateur web
2. Aller √† : `http://localhost/monapp/webapp.exe`
3. Ou avec param√®tre : `http://localhost/monapp/webapp.exe?name=Alice`

Vous devriez voir la page HTML g√©n√©r√©e par votre application !

### D√©pannage courant

**Erreur 404 - Not Found**
- V√©rifier que le fichier `webapp.exe` existe bien
- V√©rifier le chemin du r√©pertoire virtuel

**Erreur 500 - Internal Server Error**
- V√©rifier les permissions d'ex√©cution
- V√©rifier que CGI est bien install√© dans IIS
- Regarder les logs IIS (voir section Logs)

**Erreur 403 - Forbidden**
- V√©rifier les permissions NTFS du fichier
- V√©rifier les autorisations du gestionnaire

## Configuration FastCGI sur IIS

FastCGI offre de **bien meilleures performances** que CGI classique. IIS supporte nativement FastCGI depuis la version 7.

### √âtape 1 : Activer FastCGI

**V√©rifier si d√©j√† install√©** :

```powershell
Get-WindowsOptionalFeature -Online -FeatureName IIS-CGI
```

Si non install√© :

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName IIS-CGI
```

### √âtape 2 : Cr√©er l'application FastCGI

**Fichier : `webappfcgi.lpr`**

```pascal
program WebAppFastCGI;

{$mode objfpc}{$H+}

uses
  fphttpapp, httpdefs, httproute;

procedure HandleHome(ARequest: TRequest; AResponse: TResponse);
begin
  AResponse.Content :=
    '<!DOCTYPE html>' +
    '<html><head><title>FastCGI sur IIS</title></head>' +
    '<body>' +
    '<h1>Application FastCGI FreePascal</h1>' +
    '<p>Processus persistant pour performances maximales !</p>' +
    '<p>Requ√™te #' + IntToStr(Random(1000)) + '</p>' +
    '</body></html>';
end;

procedure HandleAPI(ARequest: TRequest; AResponse: TResponse);
begin
  AResponse.ContentType := 'application/json';
  AResponse.Content := '{"status":"ok","message":"FastCGI fonctionne"}';
end;

begin
  HTTPRouter.RegisterRoute('/', @HandleHome);
  HTTPRouter.RegisterRoute('/api', @HandleAPI);

  Application.Title := 'WebApp FastCGI';
  Application.Initialize;
  Application.Run;
end.
```

**Compilation** :

```cmd
fpc -MObjFPC -Scghi webappfcgi.lpr
```

### √âtape 3 : Configuration FastCGI dans IIS

**M√©thode 1 : Via l'interface graphique**

1. Ouvrir le **Gestionnaire IIS**
2. S√©lectionner le **serveur** (n≈ìud racine)
3. Double-cliquer sur **Param√®tres FastCGI**
4. Cliquer sur **Ajouter une application...** (dans Actions)
5. Remplir :
   - **Chemin d'acc√®s complet** : `C:\inetpub\apps\monapp\bin\webappfcgi.exe`
   - **Arguments** : (laisser vide)
   - **Nombre maximal d'instances** : `4` (ajuster selon CPU)
   - **InstanceMaxRequests** : `10000`
   - **ActivityTimeout** : `600` (secondes)
   - **RequestTimeout** : `90` (secondes)
   - **IdleTimeout** : `300` (secondes)
6. Cliquer sur **OK**

**M√©thode 2 : Via web.config**

Cr√©er un fichier `web.config` dans `C:\inetpub\apps\monapp\bin\` :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <add name="FreePascal-FastCGI"
           path="*"
           verb="*"
           modules="FastCgiModule"
           scriptProcessor="C:\inetpub\apps\monapp\bin\webappfcgi.exe"
           resourceType="Unspecified"
           requireAccess="Script" />
    </handlers>

    <fastCgi>
      <application fullPath="C:\inetpub\apps\monapp\bin\webappfcgi.exe"
                   instanceMaxRequests="10000"
                   maxInstances="4">
        <environmentVariables>
          <environmentVariable name="APP_ENV" value="production" />
        </environmentVariables>
      </application>
    </fastCgi>
  </system.webServer>
</configuration>
```

### √âtape 4 : Tester FastCGI

1. Navigateur ‚Üí `http://localhost/monapp/`
2. L'application devrait r√©pondre rapidement
3. Rafra√Æchir plusieurs fois : le num√©ro de requ√™te change (m√™me processus !)

### Avantages FastCGI vs CGI sur IIS

| Aspect | CGI | FastCGI |
|--------|-----|---------|
| D√©marrage processus | √Ä chaque requ√™te | Une fois |
| M√©moire | ~5-10 MB / requ√™te | ~10-20 MB total |
| Performance | 10-50 req/s | 500-2000 req/s |
| Connexions BDD | Nouvelle √† chaque fois | Pool persistant |
| Temps r√©ponse | 50-200 ms | 1-10 ms |

## Configuration avanc√©e d'IIS

### Pools d'applications (Application Pools)

Les pools d'applications isolent les applications pour la s√©curit√© et la stabilit√©.

**Cr√©er un pool d√©di√©** :

1. Gestionnaire IIS ‚Üí **Pools d'applications**
2. Clic droit ‚Üí **Ajouter un pool d'applications...**
3. Remplir :
   - **Nom** : `MonAppPool`
   - **Version du .NET CLR** : Aucun code manag√© (pour FreePascal)
   - **Mode pipeline manag√©** : Int√©gr√©
4. Cliquer sur **OK**

**Configurer le pool** :

1. Clic droit sur **MonAppPool** ‚Üí **Param√®tres avanc√©s...**
2. Param√®tres recommand√©s :
   - **Activer les applications 32 bits** : False (pour apps 64-bit)
   - **Identit√©** : ApplicationPoolIdentity
   - **D√©marrage automatique** : True
   - **Limite de m√©moire priv√©e** : 0 (illimit√©, ou 512000 KB)
   - **Intervalle de recyclage** : 1740 (29 heures)

**Assigner le pool √† votre site** :

1. S√©lectionner votre application dans IIS
2. **Actions** ‚Üí **Param√®tres de base...**
3. Choisir **MonAppPool** dans la liste
4. Cliquer sur **OK**

### Document par d√©faut

Pour que `http://localhost/monapp/` appelle automatiquement votre application :

1. S√©lectionner **monapp** dans IIS
2. Double-cliquer sur **Document par d√©faut**
3. Cliquer sur **Ajouter...** (Actions)
4. Nom : `webappfcgi.exe`
5. Cliquer sur **OK**

Maintenant `http://localhost/monapp/` fonctionne sans sp√©cifier le fichier !

### R√©√©criture d'URL (URL Rewrite)

Pour des URLs propres comme `/users/123` au lieu de `/webapp.exe?id=123`.

**Installation du module** :

1. T√©l√©charger **URL Rewrite Module** depuis le site Microsoft
2. Installer le module
3. Red√©marrer IIS

**Configuration** (`web.config`) :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="FreePascal Routing" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="webappfcgi.exe/{R:1}" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>
```

R√©sultat : `/users/123` ‚Üí redirig√© vers ‚Üí `webappfcgi.exe/users/123`

### Compression

Activer la compression pour r√©duire la bande passante :

1. Gestionnaire IIS ‚Üí S√©lectionner votre site
2. Double-cliquer sur **Compression**
3. Cocher :
   - ‚úÖ **Activer la compression du contenu statique**
   - ‚úÖ **Activer la compression du contenu dynamique**
4. Cliquer sur **Appliquer**

### Limitation de d√©bit (Rate Limiting)

Prot√©ger contre les abus :

1. Installer **Dynamic IP Restrictions** (module IIS)
2. Gestionnaire IIS ‚Üí Votre site
3. Double-cliquer sur **Restrictions d'adresses IP et de domaines**
4. Configurer les limites

## S√©curit√© sur IIS

### Configuration SSL/HTTPS

**√âtape 1 : Obtenir un certificat**

**Option A : Certificat auto-sign√© (d√©veloppement uniquement)**

```powershell
New-SelfSignedCertificate -DnsName "localhost" `
  -CertStoreLocation "cert:\LocalMachine\My"
```

**Option B : Let's Encrypt (production, gratuit)**

1. Installer **win-acme** ou **Certify The Web**
2. Suivre l'assistant pour obtenir un certificat gratuit

**√âtape 2 : Cr√©er une liaison HTTPS**

1. Gestionnaire IIS ‚Üí Sites ‚Üí Default Web Site
2. Actions ‚Üí **Liaisons...**
3. Cliquer sur **Ajouter...**
4. Remplir :
   - **Type** : https
   - **Port** : 443
   - **Certificat SSL** : S√©lectionner votre certificat
5. Cliquer sur **OK**

**√âtape 3 : Forcer HTTPS**

Dans `web.config` :

```xml
<system.webServer>
  <rewrite>
    <rules>
      <rule name="HTTP to HTTPS redirect" stopProcessing="true">
        <match url="(.*)" />
        <conditions>
          <add input="{HTTPS}" pattern="off" />
        </conditions>
        <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
      </rule>
    </rules>
  </rewrite>
</system.webServer>
```

### Permissions NTFS

Vos ex√©cutables FreePascal ont besoin de permissions sp√©cifiques :

**Permissions minimales recommand√©es** :

1. Clic droit sur `C:\inetpub\apps\monapp\bin\`
2. **Propri√©t√©s** ‚Üí Onglet **S√©curit√©**
3. Cliquer sur **Modifier...**
4. Ajouter : **IIS_IUSRS**
5. Permissions :
   - ‚úÖ Lecture et ex√©cution
   - ‚úÖ Afficher le contenu du dossier
   - ‚úÖ Lecture
6. Pour le dossier `logs\`, ajouter aussi :
   - ‚úÖ √âcriture
   - ‚úÖ Modification

**Via PowerShell** :

```powershell
$acl = Get-Acl "C:\inetpub\apps\monapp\bin"
$permission = "IIS_IUSRS","ReadAndExecute","Allow"
$accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
$acl.SetAccessRule($accessRule)
Set-Acl "C:\inetpub\apps\monapp\bin" $acl
```

### Filtrage des requ√™tes

Bloquer les requ√™tes malveillantes :

1. Gestionnaire IIS ‚Üí Votre site
2. Double-cliquer sur **Filtrage des demandes**
3. Onglet **Extensions de noms de fichiers**
4. Refuser les extensions dangereuses (`.bat`, `.cmd`, `.exe` non autoris√©s)

## Logs et diagnostic

### Localisation des logs IIS

**Logs par d√©faut** : `C:\inetpub\logs\LogFiles\W3SVC1\`

Format des noms : `u_exYYMMDD.log` (ex: `u_ex251001.log` pour le 1er oct 2025)

### Activer les logs d√©taill√©s

1. Gestionnaire IIS ‚Üí Sites ‚Üí Votre site
2. Double-cliquer sur **Journalisation**
3. **Format** : W3C
4. Cliquer sur **S√©lectionner les champs...**
5. Cocher :
   - ‚úÖ Date, Heure
   - ‚úÖ IP client
   - ‚úÖ M√©thode
   - ‚úÖ URI
   - ‚úÖ √âtat HTTP
   - ‚úÖ Temps √©coul√©
   - ‚úÖ User-Agent
6. Cliquer sur **OK**

### Lire les logs

**Via l'Explorateur Windows** : Ouvrir avec Notepad++, VS Code

**Via PowerShell** :

```powershell
# Afficher les 20 derni√®res lignes
Get-Content "C:\inetpub\logs\LogFiles\W3SVC1\u_ex$(Get-Date -Format 'yyMMdd').log" -Tail 20
```

**Format des logs** :

```
2025-10-01 14:35:22 192.168.1.100 GET /monapp/webapp.exe name=Alice 200 0 0 15
```

Colonnes : Date, Heure, IP, M√©thode, URI, Query, Code HTTP, Sous-code, Win32, Temps (ms)

### Logs d'erreurs Windows

**Observateur d'√©v√©nements** :

1. `Windows + R` ‚Üí `eventvwr`
2. **Journaux Windows** ‚Üí **Application**
3. Filtrer par source : **IIS**

**Via PowerShell** :

```powershell
Get-EventLog -LogName Application -Source "*IIS*" -Newest 20
```

### Mode Failed Request Tracing

Pour diagnostiquer les erreurs complexes :

1. Gestionnaire IIS ‚Üí Sites ‚Üí Votre site
2. Double-cliquer sur **Suivi des demandes ayant √©chou√©**
3. Actions ‚Üí **Modifier les param√®tres du site...**
4. Cocher **Activer**
5. Sp√©cifier un r√©pertoire (ex: `C:\inetpub\logs\FailedReqLogFiles`)

Configurer une r√®gle :

1. Actions ‚Üí **Ajouter...**
2. Choisir **Tout le contenu**
3. Codes d'√©tat : `400-999` (toutes les erreurs)
4. Terminer l'assistant

Les traces d√©taill√©es seront dans des fichiers XML.

## Gestion et maintenance

### D√©marrer/Arr√™ter IIS

**Via l'interface** :

1. Gestionnaire IIS ‚Üí S√©lectionner le serveur
2. Actions ‚Üí **D√©marrer**, **Arr√™ter**, ou **Red√©marrer**

**Via PowerShell** :

```powershell
# Arr√™ter
Stop-Service W3SVC

# D√©marrer
Start-Service W3SVC

# Red√©marrer
Restart-Service W3SVC
```

**Via ligne de commande** :

```cmd
iisreset /stop
iisreset /start
iisreset /restart
```

### Recycler un pool d'applications

Recycler lib√®re la m√©moire sans arr√™ter IIS :

**Via l'interface** :

1. Gestionnaire IIS ‚Üí Pools d'applications
2. Clic droit sur votre pool ‚Üí **Recycler...**

**Via PowerShell** :

```powershell
Restart-WebAppPool -Name "MonAppPool"
```

### Sauvegarde de la configuration

**Exporter la configuration** :

```powershell
# Cr√©er une sauvegarde
Backup-WebConfiguration -Name "MonAppBackup"

# Restaurer
Restore-WebConfiguration -Name "MonAppBackup"
```

**Emplacement** : `C:\Windows\System32\inetsrv\backup\`

## Mise en production

### Checklist de d√©ploiement

‚úÖ **Application compil√©e en Release**

```cmd
fpc -O3 -MObjFPC -Scghi webapp.lpr
```

‚úÖ **Configuration web.config compl√®te**  
‚úÖ **Permissions NTFS correctes**  
‚úÖ **Pool d'applications d√©di√©**  
‚úÖ **SSL/HTTPS configur√©**  
‚úÖ **Compression activ√©e**  
‚úÖ **Logs configur√©s**  
‚úÖ **Monitoring en place**

### Optimisations pour production

**web.config optimis√©** :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <!-- FastCGI Configuration -->
    <handlers>
      <add name="FastCGI-FreePascal"
           path="*"
           verb="*"
           modules="FastCgiModule"
           scriptProcessor="C:\inetpub\apps\monapp\bin\webapp.exe"
           resourceType="Unspecified"
           requireAccess="Script" />
    </handlers>

    <fastCgi>
      <application fullPath="C:\inetpub\apps\monapp\bin\webapp.exe"
                   instanceMaxRequests="50000"
                   maxInstances="8"
                   idleTimeout="600"
                   activityTimeout="30"
                   requestTimeout="90"
                   monitorChangesTo="C:\inetpub\apps\monapp\bin\webapp.exe"
                   flushNamedPipe="false">
        <environmentVariables>
          <environmentVariable name="APP_ENV" value="production" />
          <environmentVariable name="APP_LOG_LEVEL" value="error" />
        </environmentVariables>
      </application>
    </fastCgi>

    <!-- URL Rewrite pour URLs propres -->
    <rewrite>
      <rules>
        <!-- Forcer HTTPS -->
        <rule name="Force HTTPS" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" />
          </conditions>
          <action type="Redirect"
                  url="https://{HTTP_HOST}/{R:1}"
                  redirectType="Permanent" />
        </rule>

        <!-- Router vers l'application -->
        <rule name="Application Router" stopProcessing="true">
          <match url="^(.*)$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="webapp.exe/{R:1}" />
        </rule>
      </rules>
    </rewrite>

    <!-- Compression -->
    <urlCompression doStaticCompression="true"
                    doDynamicCompression="true"
                    dynamicCompressionBeforeCache="false" />

    <httpCompression>
      <dynamicTypes>
        <add mimeType="text/html" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
      </dynamicTypes>
      <staticTypes>
        <add mimeType="text/css" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
      </staticTypes>
    </httpCompression>

    <!-- Headers de s√©curit√© -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" />
        <remove name="X-Powered-By" />
      </customHeaders>
    </httpProtocol>

    <!-- Limites de s√©curit√© -->
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="10485760" /> <!-- 10 MB -->
        <fileExtensions>
          <add fileExtension=".exe" allowed="false" />
          <add fileExtension=".bat" allowed="false" />
          <add fileExtension=".cmd" allowed="false" />
        </fileExtensions>
      </requestFiltering>
    </security>

    <!-- Cache statique -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00" />
    </staticContent>

    <!-- Erreurs personnalis√©es -->
    <httpErrors errorMode="Custom" existingResponse="Replace">
      <remove statusCode="404" />
      <error statusCode="404"
             path="/errors/404.html"
             responseMode="File" />
      <remove statusCode="500" />
      <error statusCode="500"
             path="/errors/500.html"
             responseMode="File" />
    </httpErrors>
  </system.webServer>

  <!-- D√©sactiver le debug -->
  <system.web>
    <compilation debug="false" />
    <customErrors mode="On" />
  </system.web>
</configuration>
```

### Configuration du pool d'applications pour production

**Via PowerShell (script de d√©ploiement)** :

```powershell
# Cr√©er ou configurer le pool
Import-Module WebAdministration

$poolName = "MonAppProductionPool"
$appPath = "C:\inetpub\apps\monapp"

# Cr√©er le pool s'il n'existe pas
if (-not (Test-Path "IIS:\AppPools\$poolName")) {
    New-WebAppPool -Name $poolName
}

# Configuration optimale pour production
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "managedRuntimeVersion" -Value ""
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "enable32BitAppOnWin64" -Value $false
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "processModel.identityType" -Value "ApplicationPoolIdentity"
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "processModel.idleTimeout" -Value "00:20:00"
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "processModel.maxProcesses" -Value 1
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "recycling.periodicRestart.time" -Value "1.05:00:00"
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "recycling.periodicRestart.memory" -Value 0
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "recycling.periodicRestart.privateMemory" -Value 512000
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "cpu.limit" -Value 0
Set-ItemProperty "IIS:\AppPools\$poolName" -Name "startMode" -Value "AlwaysRunning"

Write-Host "Pool d'applications configur√© : $poolName"

# Assigner le pool au site
Set-ItemProperty "IIS:\Sites\Default Web Site\monapp" -Name "applicationPool" -Value $poolName

Write-Host "Application assign√©e au pool"
```

**Explication des param√®tres** :

| Param√®tre | Valeur | Raison |
|-----------|--------|--------|
| `managedRuntimeVersion` | "" | Aucun .NET (FreePascal natif) |
| `enable32BitAppOnWin64` | False | Application 64-bit |
| `identityType` | ApplicationPoolIdentity | S√©curit√© isol√©e |
| `idleTimeout` | 20 min | √âviter arr√™ts fr√©quents |
| `maxProcesses` | 1 | Un seul processus (FastCGI) |
| `periodicRestart.time` | 25h5min | Recyclage quotidien d√©cal√© |
| `privateMemory` | 512 MB | Recyclage si fuite m√©moire |
| `startMode` | AlwaysRunning | Toujours actif (pas de cold start) |

### Script de d√©ploiement automatis√©

**deploy.ps1** :

```powershell
#Requires -RunAsAdministrator

param(
    [string]$AppName = "monapp",
    [string]$SourcePath = ".\bin\Release",
    [string]$TargetPath = "C:\inetpub\apps\monapp",
    [string]$PoolName = "MonAppPool"
)

Write-Host "=== D√©ploiement de $AppName ===" -ForegroundColor Green

# 1. Arr√™ter le pool d'applications
Write-Host "Arr√™t du pool d'applications..." -ForegroundColor Yellow
Stop-WebAppPool -Name $PoolName -ErrorAction SilentlyContinue
Start-Sleep -Seconds 3

# 2. Cr√©er une sauvegarde
$backupName = "backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
Write-Host "Cr√©ation de la sauvegarde : $backupName" -ForegroundColor Yellow

if (Test-Path "$TargetPath\bin") {
    Copy-Item -Path "$TargetPath\bin" -Destination "$TargetPath\$backupName" -Recurse
}

# 3. Copier les nouveaux fichiers
Write-Host "Copie des fichiers..." -ForegroundColor Yellow
if (-not (Test-Path "$TargetPath\bin")) {
    New-Item -Path "$TargetPath\bin" -ItemType Directory | Out-Null
}

Copy-Item -Path "$SourcePath\*" -Destination "$TargetPath\bin\" -Recurse -Force

# 4. V√©rifier les permissions
Write-Host "Configuration des permissions..." -ForegroundColor Yellow
$acl = Get-Acl "$TargetPath\bin"
$permission = "IIS_IUSRS", "ReadAndExecute", "Allow"
$accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
$acl.SetAccessRule($accessRule)
Set-Acl "$TargetPath\bin" $acl

# Permissions en √©criture pour les logs
if (Test-Path "$TargetPath\logs") {
    $acl = Get-Acl "$TargetPath\logs"
    $permission = "IIS_IUSRS", "Modify", "Allow"
    $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
    $acl.SetAccessRule($accessRule)
    Set-Acl "$TargetPath\logs" $acl
}

# 5. Red√©marrer le pool
Write-Host "Red√©marrage du pool d'applications..." -ForegroundColor Yellow
Start-WebAppPool -Name $PoolName

# Attendre que le pool d√©marre
$timeout = 30
$elapsed = 0
do {
    Start-Sleep -Seconds 1
    $elapsed++
    $state = (Get-WebAppPoolState -Name $PoolName).Value
} while ($state -ne "Started" -and $elapsed -lt $timeout)

if ($state -eq "Started") {
    Write-Host "D√©ploiement r√©ussi !" -ForegroundColor Green

    # Test de sant√©
    Write-Host "Test de l'application..." -ForegroundColor Yellow
    try {
        $response = Invoke-WebRequest -Uri "http://localhost/$AppName/" -UseBasicParsing
        if ($response.StatusCode -eq 200) {
            Write-Host "Application op√©rationnelle (HTTP 200)" -ForegroundColor Green
        }
    } catch {
        Write-Host "Avertissement : Test √©chou√© - $($_.Exception.Message)" -ForegroundColor Red
    }
} else {
    Write-Host "ERREUR : Le pool n'a pas d√©marr√© dans les temps" -ForegroundColor Red
    exit 1
}

Write-Host "`n=== D√©ploiement termin√© ===" -ForegroundColor Green
```

**Utilisation** :

```powershell
.\deploy.ps1 -AppName "monapp" -PoolName "MonAppPool"
```

## Monitoring et surveillance

### Surveillance des performances

**Cr√©er un compteur de performances** :

```powershell
# Surveiller l'utilisation CPU du pool
Get-Counter "\Process(w3wp*)\% Processor Time" -Continuous

# Surveiller la m√©moire
Get-Counter "\Process(w3wp*)\Working Set - Private" -Continuous

# Surveiller les requ√™tes
Get-Counter "\Web Service(_Total)\Current Connections" -Continuous
```

### Script de monitoring

**monitor.ps1** :

```powershell
param(
    [string]$PoolName = "MonAppPool",
    [int]$CheckIntervalSeconds = 60
)

Write-Host "=== Monitoring de $PoolName ===" -ForegroundColor Cyan
Write-Host "V√©rification toutes les $CheckIntervalSeconds secondes" -ForegroundColor Gray

while ($true) {
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

    # √âtat du pool
    $poolState = (Get-WebAppPoolState -Name $PoolName).Value
    $color = if ($poolState -eq "Started") { "Green" } else { "Red" }
    Write-Host "[$timestamp] √âtat du pool: $poolState" -ForegroundColor $color

    # Processus w3wp
    $w3wpProcesses = Get-Process -Name "w3wp" -ErrorAction SilentlyContinue

    if ($w3wpProcesses) {
        foreach ($proc in $w3wpProcesses) {
            $cpu = [math]::Round($proc.CPU, 2)
            $memMB = [math]::Round($proc.WorkingSet64 / 1MB, 2)
            $threads = $proc.Threads.Count

            Write-Host "  PID: $($proc.Id) | CPU: ${cpu}s | M√©moire: ${memMB} MB | Threads: $threads" -ForegroundColor Gray

            # Alerte si m√©moire excessive
            if ($memMB -gt 500) {
                Write-Host "  ALERTE: Consommation m√©moire √©lev√©e!" -ForegroundColor Yellow
            }
        }
    }

    # V√©rifier les logs r√©cents
    $logPath = "C:\inetpub\logs\LogFiles\W3SVC1"
    $latestLog = Get-ChildItem $logPath -Filter "u_ex*.log" |
                 Sort-Object LastWriteTime -Descending |
                 Select-Object -First 1

    if ($latestLog) {
        $errors = Get-Content $latestLog.FullName -Tail 100 |
                  Where-Object { $_ -match " (4[0-9]{2}|5[0-9]{2}) " }

        if ($errors.Count -gt 0) {
            Write-Host "  Erreurs r√©centes: $($errors.Count)" -ForegroundColor Yellow
        }
    }

    Write-Host ""
    Start-Sleep -Seconds $CheckIntervalSeconds
}
```

**Utilisation** :

```powershell
.\monitor.ps1 -PoolName "MonAppPool" -CheckIntervalSeconds 30
```

### Health Check avec FreePascal

**Ajouter un endpoint de sant√© dans votre application** :

```pascal
procedure HandleHealthCheck(ARequest: TRequest; AResponse: TResponse);
var
  JSONObj: TJSONObject;
  MemInfo: TMemoryManagerState;
  MemStats: TMemoryManagerStats;
begin
  JSONObj := TJSONObject.Create;
  try
    JSONObj.Add('status', 'ok');
    JSONObj.Add('timestamp', FormatDateTime('yyyy-mm-dd"T"hh:nn:ss', Now));
    JSONObj.Add('uptime_seconds', Round((Now - ApplicationStartTime) * 86400));

    // Statistiques m√©moire
    GetMemoryManagerState(MemInfo);
    GetMemoryManagerStatistics(MemStats);
    JSONObj.Add('memory_allocated_mb',
                Round(MemStats.AllocatedMemory / (1024 * 1024)));

    // V√©rifier la connexion BDD (si applicable)
    try
      if DBConnection.Connected then
        JSONObj.Add('database', 'connected')
      else
        JSONObj.Add('database', 'disconnected');
    except
      JSONObj.Add('database', 'error');
    end;

    AResponse.ContentType := 'application/json';
    AResponse.Content := JSONObj.AsJSON;
  finally
    JSONObj.Free;
  end;
end;

// Dans l'initialisation
HTTPRouter.RegisterRoute('/health', @HandleHealthCheck);
```

**Script PowerShell pour v√©rifier** :

```powershell
# healthcheck.ps1
$url = "http://localhost/monapp/health"

try {
    $response = Invoke-RestMethod -Uri $url -TimeoutSec 5

    if ($response.status -eq "ok") {
        Write-Host "‚úì Application saine" -ForegroundColor Green
        Write-Host "  Uptime: $($response.uptime_seconds) secondes" -ForegroundColor Gray
        Write-Host "  M√©moire: $($response.memory_allocated_mb) MB" -ForegroundColor Gray
        exit 0
    } else {
        Write-Host "‚úó Application en √©tat d√©grad√©" -ForegroundColor Yellow
        exit 1
    }
} catch {
    Write-Host "‚úó Application non disponible: $($_.Exception.Message)" -ForegroundColor Red
    exit 2
}
```

**Automatiser avec le Planificateur de t√¢ches** :

```powershell
# Cr√©er une t√¢che planifi√©e qui v√©rifie toutes les 5 minutes
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" `
    -Argument "-File C:\Scripts\healthcheck.ps1"

$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) `
    -RepetitionInterval (New-TimeSpan -Minutes 5) `
    -RepetitionDuration ([TimeSpan]::MaxValue)

Register-ScheduledTask -TaskName "MonApp_HealthCheck" `
    -Action $action `
    -Trigger $trigger `
    -Description "V√©rifie la sant√© de l'application toutes les 5 minutes"
```

## Gestion des erreurs en production

### Pages d'erreur personnalis√©es

**Cr√©er les pages d'erreur** :

**404.html** :

```html
<!DOCTYPE html>
<html>
<head>
    <title>Page non trouv√©e - 404</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #f5f5f5;
        }
        h1 { color: #e74c3c; font-size: 72px; margin: 0; }
        p { color: #555; font-size: 18px; }
        a { color: #3498db; text-decoration: none; }
    </style>
</head>
<body>
    <h1>404</h1>
    <p>La page que vous cherchez n'existe pas.</p>
    <p><a href="/">Retour √† l'accueil</a></p>
</body>
</html>
```

**500.html** :

```html
<!DOCTYPE html>
<html>
<head>
    <title>Erreur serveur - 500</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #f5f5f5;
        }
        h1 { color: #e74c3c; font-size: 72px; margin: 0; }
        p { color: #555; font-size: 18px; }
    </style>
</head>
<body>
    <h1>500</h1>
    <p>Une erreur est survenue sur le serveur.</p>
    <p>Nos √©quipes ont √©t√© notifi√©es et travaillent √† r√©soudre le probl√®me.</p>
</body>
</html>
```

**Placer les fichiers** :

```
C:\inetpub\apps\monapp\errors\
‚îú‚îÄ‚îÄ 404.html
‚îú‚îÄ‚îÄ 500.html
‚îî‚îÄ‚îÄ maintenance.html
```

### Mode maintenance

**maintenance.html** :

```html
<!DOCTYPE html>
<html>
<head>
    <title>Maintenance en cours</title>
    <meta charset="utf-8">
    <meta http-equiv="refresh" content="60">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        h1 { font-size: 48px; }
        .spinner {
            margin: 20px auto;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>üîß Maintenance en cours</h1>
    <div class="spinner"></div>
    <p>Nous effectuons une mise √† jour pour am√©liorer votre exp√©rience.</p>
    <p>L'application sera de nouveau disponible dans quelques minutes.</p>
    <p><small>Cette page se recharge automatiquement</small></p>
</body>
</html>
```

**Activer le mode maintenance** :

```powershell
# maintenance-on.ps1
$appPath = "C:\inetpub\apps\monapp"

# Sauvegarder le web.config actuel
Copy-Item "$appPath\bin\web.config" "$appPath\bin\web.config.backup"

# Cr√©er un web.config de maintenance
$maintenanceConfig = @"
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="Maintenance Mode" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{URL}" pattern="^/maintenance\.html$" negate="true" />
          </conditions>
          <action type="Rewrite" url="/errors/maintenance.html" />
        </rule>
      </rules>
    </rewrite>
    <httpErrors errorMode="Custom" existingResponse="Replace">
      <remove statusCode="503" />
      <error statusCode="503" path="/errors/maintenance.html" responseMode="File" />
    </httpErrors>
  </system.webServer>
</configuration>
"@

Set-Content -Path "$appPath\bin\web.config" -Value $maintenanceConfig
Write-Host "Mode maintenance activ√©" -ForegroundColor Yellow
```

**D√©sactiver le mode maintenance** :

```powershell
# maintenance-off.ps1
$appPath = "C:\inetpub\apps\monapp"

# Restaurer le web.config
if (Test-Path "$appPath\bin\web.config.backup") {
    Copy-Item "$appPath\bin\web.config.backup" "$appPath\bin\web.config" -Force
    Remove-Item "$appPath\bin\web.config.backup"
    Write-Host "Mode maintenance d√©sactiv√©" -ForegroundColor Green
} else {
    Write-Host "Pas de sauvegarde trouv√©e" -ForegroundColor Red
}
```

## Backup et restauration

### Script de backup automatique

**backup.ps1** :

```powershell
param(
    [string]$AppPath = "C:\inetpub\apps\monapp",
    [string]$BackupPath = "C:\Backups\monapp",
    [int]$RetentionDays = 7
)

$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$backupName = "backup_$timestamp"
$backupFullPath = Join-Path $BackupPath $backupName

Write-Host "=== Backup de l'application ===" -ForegroundColor Cyan

# Cr√©er le r√©pertoire de backup
if (-not (Test-Path $BackupPath)) {
    New-Item -Path $BackupPath -ItemType Directory | Out-Null
}

# Backup des fichiers
Write-Host "Copie des fichiers..." -ForegroundColor Yellow
Copy-Item -Path $AppPath -Destination $backupFullPath -Recurse

# Compression
Write-Host "Compression..." -ForegroundColor Yellow
Compress-Archive -Path $backupFullPath -DestinationPath "$backupFullPath.zip"
Remove-Item -Path $backupFullPath -Recurse -Force

# Backup de la configuration IIS
Write-Host "Sauvegarde de la configuration IIS..." -ForegroundColor Yellow
Backup-WebConfiguration -Name "backup_$timestamp"

$backupSize = (Get-Item "$backupFullPath.zip").Length / 1MB
Write-Host "Backup cr√©√©: $backupName.zip ($([math]::Round($backupSize, 2)) MB)" -ForegroundColor Green

# Nettoyage des anciens backups
Write-Host "Nettoyage des anciens backups..." -ForegroundColor Yellow
$oldBackups = Get-ChildItem -Path $BackupPath -Filter "backup_*.zip" |
              Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-$RetentionDays) }

foreach ($backup in $oldBackups) {
    Remove-Item $backup.FullName
    Write-Host "  Supprim√©: $($backup.Name)" -ForegroundColor Gray
}

Write-Host "Backup termin√© avec succ√®s" -ForegroundColor Green
```

**Planifier les backups** :

```powershell
# Backup quotidien √† 2h du matin
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" `
    -Argument "-File C:\Scripts\backup.ps1"

$trigger = New-ScheduledTaskTrigger -Daily -At 2am

Register-ScheduledTask -TaskName "MonApp_DailyBackup" `
    -Action $action `
    -Trigger $trigger `
    -RunLevel Highest `
    -Description "Backup quotidien de l'application"
```

## D√©pannage avanc√©

### Probl√®mes courants et solutions

#### Erreur : "Handler "FastCGI-FreePascal" has a bad module "FastCgiModule""

**Cause** : Le module FastCGI n'est pas install√©.

**Solution** :

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName IIS-CGI
iisreset
```

#### Erreur : "HTTP Error 500.0 - Internal Server Error"

**Diagnostic** :

```powershell
# Activer les erreurs d√©taill√©es temporairement
Set-WebConfigurationProperty -PSPath "IIS:\Sites\Default Web Site\monapp" `
    -Filter "system.webServer/httpErrors" `
    -Name "errorMode" `
    -Value "Detailed"
```

**V√©rifications** :

1. L'ex√©cutable existe-t-il ?
2. Les permissions sont-elles correctes ?
3. Les d√©pendances (DLL) sont-elles pr√©sentes ?

**Test manuel** :

```cmd
cd C:\inetpub\apps\monapp\bin
webapp.exe
```

Si l'application d√©marre en standalone, le probl√®me vient d'IIS.

#### Processus FastCGI qui ne d√©marre pas

**V√©rifier les logs** :

```powershell
# Logs d'application Windows
Get-EventLog -LogName Application -Source "IIS*" -Newest 20 |
    Select-Object TimeGenerated, EntryType, Message | Format-List
```

**Augmenter le timeout** dans `web.config` :

```xml
<fastCgi>
  <application fullPath="..."
               activityTimeout="600"
               requestTimeout="180" />
</fastCgi>
```

#### Fuites m√©moire

**Monitoring** :

```powershell
# Surveiller l'utilisation m√©moire
while ($true) {
    $w3wp = Get-Process -Name w3wp -ErrorAction SilentlyContinue
    if ($w3wp) {
        $memMB = [math]::Round($w3wp.WorkingSet64 / 1MB, 2)
        Write-Host "$(Get-Date -Format 'HH:mm:ss') - M√©moire: $memMB MB"
    }
    Start-Sleep -Seconds 10
}
```

**Solution** : Configurer le recyclage automatique :

```powershell
Set-ItemProperty "IIS:\AppPools\MonAppPool" `
    -Name "recycling.periodicRestart.privateMemory" `
    -Value 512000  # 500 MB
```

## Conclusion

La configuration d'IIS pour des applications FreePascal en production n√©cessite :

‚úÖ **Installation correcte** d'IIS avec CGI/FastCGI  
‚úÖ **Configuration optimis√©e** du `web.config`  
‚úÖ **Pool d'applications** d√©di√© et bien configur√©  
‚úÖ **Permissions NTFS** appropri√©es  
‚úÖ **Monitoring** actif avec health checks  
‚úÖ **Logs** configur√©s pour le diagnostic  
‚úÖ **Backups** automatis√©s  
‚úÖ **Scripts** de d√©ploiement et maintenance

Avec cette configuration, votre application FreePascal fonctionnera de mani√®re stable, performante et s√©curis√©e sur IIS Windows.

Dans la section suivante, nous verrons la **configuration Apache sur Windows et Ubuntu**, offrant une alternative multi-plateforme √† IIS.

‚è≠Ô∏è [Configuration Apache/Nginx (Ubuntu)](/09-programmation-web-freepascal/02.2-configuration-apache-nginx-ubuntu.md)
