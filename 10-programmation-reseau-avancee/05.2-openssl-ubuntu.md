üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.5.2 OpenSSL sur Ubuntu

## Introduction

Sur Ubuntu et les distributions Linux en g√©n√©ral, OpenSSL est g√©n√©ralement d√©j√† install√© par d√©faut, car de nombreux programmes syst√®me en d√©pendent. Cependant, pour d√©velopper des applications avec FreePascal/Lazarus, nous devons nous assurer que les bonnes versions et les fichiers de d√©veloppement sont pr√©sents.

Dans cette section, nous allons apprendre √† :
- V√©rifier l'installation d'OpenSSL
- Installer ou mettre √† jour OpenSSL
- Configurer OpenSSL pour FreePascal/Lazarus
- R√©soudre les probl√®mes courants
- G√©n√©rer des certificats

## Avantages d'OpenSSL sur Linux

**Compar√© √† Windows :**
- ‚úÖ Souvent d√©j√† install√© par d√©faut
- ‚úÖ Gestion via le gestionnaire de paquets (apt)
- ‚úÖ Mises √† jour automatiques de s√©curit√©
- ‚úÖ Int√©gration native avec le syst√®me
- ‚úÖ Pas de DLLs √† distribuer (biblioth√®ques syst√®me)

## V√©rification de l'installation

### Commandes de base

Ouvrez un terminal et v√©rifiez la version install√©e :

```bash
# Version d'OpenSSL install√©e
openssl version

# Version d√©taill√©e avec informations de compilation
openssl version -a

# V√©rifier les biblioth√®ques install√©es
ldconfig -p | grep ssl
```

**R√©sultat attendu :**

```bash
$ openssl version
OpenSSL 3.0.2 15 Mar 2022 (Library: OpenSSL 3.0.2 15 Mar 2022)

$ ldconfig -p | grep ssl
libssl.so.3 (libc6,x86-64) => /lib/x86_64-linux-gnu/libssl.so.3
libssl.so.1.1 (libc6,x86-64) => /lib/x86_64-linux-gnu/libssl.so.1.1
```

### Fichiers de biblioth√®ques

Les fichiers OpenSSL se trouvent g√©n√©ralement dans :

```bash
# Biblioth√®ques partag√©es (.so)
/lib/x86_64-linux-gnu/libssl.so.3
/lib/x86_64-linux-gnu/libcrypto.so.3

# Ou
/usr/lib/x86_64-linux-gnu/libssl.so.3
/usr/lib/x86_64-linux-gnu/libcrypto.so.3

# Fichiers d'en-t√™te (headers)
/usr/include/openssl/

# Ex√©cutable openssl
/usr/bin/openssl

# Certificats racine
/etc/ssl/certs/
```

### V√©rifier les versions disponibles

```bash
# Version d'OpenSSL
openssl version

# Version de la biblioth√®que libssl
dpkg -l | grep libssl

# Informations d√©taill√©es sur le paquet
apt show libssl3
```

## Installation d'OpenSSL

### OpenSSL est d√©j√† install√© ?

Sur Ubuntu moderne (20.04+), OpenSSL est g√©n√©ralement d√©j√† pr√©sent. V√©rifiez :

```bash
which openssl
# R√©sultat : /usr/bin/openssl
```

Si la commande ne retourne rien, OpenSSL n'est pas install√©.

### Installation via apt

#### Installation basique

```bash
# Mise √† jour de la liste des paquets
sudo apt update

# Installation d'OpenSSL (si absent)
sudo apt install openssl

# V√©rification
openssl version
```

#### Installation des biblioth√®ques de d√©veloppement

Pour compiler des programmes qui utilisent OpenSSL :

```bash
# Installation des headers et biblioth√®ques de d√©veloppement
sudo apt install libssl-dev

# V√©rification
ls /usr/include/openssl/
```

**Contenu de libssl-dev :**
- Fichiers d'en-t√™te (.h) dans `/usr/include/openssl/`
- Biblioth√®ques statiques (.a) si n√©cessaires
- Liens symboliques pour la compilation

#### Installation compl√®te (recommand√©e pour le d√©veloppement)

```bash
# Installation compl√®te
sudo apt install openssl libssl-dev ca-certificates

# Explication :
# - openssl         : Outil en ligne de commande
# - libssl-dev      : Fichiers de d√©veloppement
# - ca-certificates : Certificats racine de confiance
```

### Versions d'OpenSSL selon Ubuntu

| Version Ubuntu | OpenSSL par d√©faut |
|----------------|-------------------|
| Ubuntu 18.04 LTS | OpenSSL 1.1.1 |
| Ubuntu 20.04 LTS | OpenSSL 1.1.1 |
| Ubuntu 22.04 LTS | OpenSSL 3.0.2 |
| Ubuntu 23.04+ | OpenSSL 3.0+ |

### Installation d'une version sp√©cifique

Si vous avez besoin d'une version pr√©cise :

```bash
# Voir les versions disponibles
apt-cache policy libssl-dev

# Installer une version sp√©cifique (exemple)
sudo apt install libssl3=3.0.2-0ubuntu1.10

# Emp√™cher la mise √† jour automatique
sudo apt-mark hold libssl3
```

### Compilation depuis les sources (avanc√©)

Pour la derni√®re version ou des besoins sp√©cifiques :

```bash
# Installation des d√©pendances de compilation
sudo apt install build-essential wget

# T√©l√©chargement
cd /tmp
wget https://www.openssl.org/source/openssl-3.2.0.tar.gz
tar -xzf openssl-3.2.0.tar.gz
cd openssl-3.2.0

# Configuration
./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl

# Compilation
make

# Tests (optionnel mais recommand√©)
make test

# Installation
sudo make install

# Mise √† jour des liens
sudo ldconfig

# V√©rification
/usr/local/ssl/bin/openssl version
```

## Configuration pour FreePascal/Lazarus

### Fichiers de biblioth√®que

FreePascal cherche automatiquement les biblioth√®ques dans les chemins standard :

```
/lib/x86_64-linux-gnu/
/usr/lib/x86_64-linux-gnu/
/usr/local/lib/
```

### V√©rification des liens symboliques

```bash
# V√©rifier les liens
ls -l /usr/lib/x86_64-linux-gnu/libssl*

# R√©sultat typique :
lrwxrwxrwx libssl.so -> libssl.so.3
lrwxrwxrwx libssl.so.3 -> libssl.so.3.0.2
-rw-r--r-- libssl.so.3.0.2
```

Ces liens permettent √† FreePascal de trouver la bonne version.

### Configuration dans votre code

#### D√©finir les noms de biblioth√®ques

```pascal
{$mode objfpc}{$H+}

const
  {$IFDEF UNIX}
    {$IFDEF LINUX}
    // OpenSSL 3.0+
    DLLSSLName = 'libssl.so.3';
    DLLCryptoName = 'libcrypto.so.3';

    // Ou pour OpenSSL 1.1.1
    // DLLSSLName = 'libssl.so.1.1';
    // DLLCryptoName = 'libcrypto.so.1.1';

    // Ou de mani√®re g√©n√©rique (recommand√©)
    // DLLSSLName = 'ssl';
    // DLLCryptoName = 'crypto';
    {$ENDIF}
  {$ENDIF}
```

#### Programme de test simple

```pascal
program TestSSLUbuntu;

{$mode objfpc}{$H+}

uses
  SysUtils, Classes,
  httpsend,    // Synapse HTTP
  ssl_openssl; // Support SSL

var
  HTTP: THTTPSend;
begin
  WriteLn('=== Test OpenSSL sur Ubuntu ===');
  WriteLn;

  // Afficher la version d'OpenSSL d√©tect√©e
  WriteLn('Version OpenSSL: ', SSLImplementation.OpenSSLVersion);
  WriteLn;

  HTTP := THTTPSend.Create;
  try
    WriteLn('Test de connexion HTTPS √† google.com...');

    if HTTP.HTTPMethod('GET', 'https://www.google.com') then
    begin
      WriteLn('‚úì Connexion r√©ussie !');
      WriteLn('  Code HTTP: ', HTTP.ResultCode);
      WriteLn('  Taille: ', HTTP.Document.Size, ' octets');
    end
    else
      WriteLn('‚úó Connexion √©chou√©e');

  finally
    HTTP.Free;
  end;

  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

**Compilation et ex√©cution :**

```bash
# Compilation
fpc TestSSLUbuntu.pas

# Ex√©cution
./TestSSLUbuntu
```

### Utilisation avec Indy

```pascal
program TestIndySSL;

{$mode objfpc}{$H+}

uses
  SysUtils, Classes,
  IdHTTP,
  IdSSLOpenSSL;

var
  HTTP: TIdHTTP;
  SSLHandler: TIdSSLIOHandlerSocketOpenSSL;
  Response: string;

begin
  WriteLn('=== Test Indy SSL sur Ubuntu ===');
  WriteLn;

  HTTP := TIdHTTP.Create(nil);
  SSLHandler := TIdSSLIOHandlerSocketOpenSSL.Create(nil);

  try
    // Configuration SSL
    SSLHandler.SSLOptions.Method := sslvTLSv1_2;
    SSLHandler.SSLOptions.Mode := sslmClient;

    // Chemins des biblioth√®ques (g√©n√©ralement automatique sur Linux)
    SSLHandler.SSLOptions.SSLVersions := [sslvTLSv1_2, sslvTLSv1_3];

    HTTP.IOHandler := SSLHandler;

    WriteLn('Connexion √† https://httpbin.org/get...');

    try
      Response := HTTP.Get('https://httpbin.org/get');
      WriteLn('‚úì Succ√®s !');
      WriteLn('Taille de la r√©ponse: ', Length(Response), ' caract√®res');
      WriteLn('Premiers caract√®res: ', Copy(Response, 1, 100), '...');
    except
      on E: Exception do
      begin
        WriteLn('‚úó Erreur: ', E.Message);
        WriteLn('Classe: ', E.ClassName);
      end;
    end;

  finally
    SSLHandler.Free;
    HTTP.Free;
  end;

  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

## Certificats racine

### Emplacement des certificats

Ubuntu maintient les certificats racine de confiance dans :

```bash
/etc/ssl/certs/          # R√©pertoire principal
/etc/ssl/certs/ca-certificates.crt  # Bundle de tous les certificats
```

### Mise √† jour des certificats

```bash
# Mise √† jour des certificats
sudo apt update
sudo apt install --reinstall ca-certificates

# Ou mise √† jour manuelle
sudo update-ca-certificates

# V√©rifier le nombre de certificats
ls /etc/ssl/certs/ | wc -l
```

### Ajout d'un certificat personnalis√©

Pour ajouter un certificat de confiance (par exemple pour un serveur interne) :

```bash
# 1. Copier le certificat
sudo cp mon-certificat.crt /usr/local/share/ca-certificates/

# 2. Mettre √† jour le bundle
sudo update-ca-certificates

# R√©sultat :
# Updating certificates in /etc/ssl/certs...
# 1 added, 0 removed; done.
```

### Configuration dans votre application

```pascal
uses
  httpsend, ssl_openssl;

var
  HTTP: THTTPSend;
begin
  HTTP := THTTPSend.Create;
  try
    // Sp√©cifier le bundle de certificats
    HTTP.Sock.SSL.CertCAFile := '/etc/ssl/certs/ca-certificates.crt';

    // Ou un certificat sp√©cifique
    // HTTP.Sock.SSL.CertCAFile := '/chemin/vers/certificat.crt';

    if HTTP.HTTPMethod('GET', 'https://example.com') then
      WriteLn('Succ√®s !');

  finally
    HTTP.Free;
  end;
end.
```

## G√©n√©ration de certificats

### Certificat auto-sign√© pour d√©veloppement

```bash
# G√©n√©rer une cl√© priv√©e et un certificat
openssl req -x509 -newkey rsa:4096 \
  -keyout key.pem \
  -out cert.pem \
  -days 365 \
  -nodes \
  -subj "/C=FR/ST=Ile-de-France/L=Paris/O=MonEntreprise/CN=localhost"

# V√©rifier le certificat g√©n√©r√©
openssl x509 -in cert.pem -text -noout

# Permissions appropri√©es pour la cl√© priv√©e
chmod 600 key.pem
chmod 644 cert.pem
```

**Explication des options :**
- `-x509` : G√©n√©rer un certificat auto-sign√©
- `-newkey rsa:4096` : Nouvelle cl√© RSA de 4096 bits
- `-keyout key.pem` : Fichier de sortie pour la cl√©
- `-out cert.pem` : Fichier de sortie pour le certificat
- `-days 365` : Validit√© d'un an
- `-nodes` : Pas de chiffrement de la cl√© (pas de passphrase)
- `-subj` : Informations du certificat

### Certificat avec Subject Alternative Names (SAN)

Pour supporter plusieurs domaines :

```bash
# 1. Cr√©er un fichier de configuration
cat > san.cnf <<EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = FR
ST = Ile-de-France
L = Paris
O = MonEntreprise
CN = localhost

[v3_req]
keyUsage = keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = myapp.local
IP.1 = 127.0.0.1
IP.2 = 192.168.1.100
EOF

# 2. G√©n√©rer le certificat avec SAN
openssl req -x509 -newkey rsa:4096 \
  -keyout key.pem \
  -out cert.pem \
  -days 365 \
  -nodes \
  -config san.cnf \
  -extensions v3_req

# 3. V√©rifier les SAN
openssl x509 -in cert.pem -text -noout | grep -A 1 "Subject Alternative Name"
```

### G√©n√©rer une demande de certificat (CSR)

Pour obtenir un certificat sign√© par une autorit√© de certification :

```bash
# 1. G√©n√©rer une cl√© priv√©e
openssl genrsa -out private.key 4096

# 2. G√©n√©rer le CSR
openssl req -new -key private.key -out request.csr \
  -subj "/C=FR/ST=Ile-de-France/L=Paris/O=MonEntreprise/CN=www.example.com"

# 3. V√©rifier le CSR
openssl req -in request.csr -text -noout

# 4. Envoyer request.csr √† votre autorit√© de certification
```

### Convertir entre formats

```bash
# PEM vers DER
openssl x509 -in cert.pem -outform DER -out cert.der

# DER vers PEM
openssl x509 -in cert.der -inform DER -out cert.pem

# PEM vers PKCS#12 (avec cl√© priv√©e)
openssl pkcs12 -export -out certificate.p12 \
  -inkey key.pem -in cert.pem

# PKCS#12 vers PEM
openssl pkcs12 -in certificate.p12 -out cert.pem -nodes
```

## Configuration d'un serveur HTTPS

### Serveur HTTPS simple avec Synapse

```pascal
program SimpleHTTPSServer;

{$mode objfpc}{$H+}

uses
  SysUtils, Classes, blcksock, synsock, ssl_openssl;

type
  THTTPSServer = class
  private
    FPort: string;
    FSocket: TTCPBlockSocket;
    FCertFile: string;
    FKeyFile: string;
  public
    constructor Create(const APort, ACertFile, AKeyFile: string);
    destructor Destroy; override;
    procedure Run;
  end;

constructor THTTPSServer.Create(const APort, ACertFile, AKeyFile: string);
begin
  FPort := APort;
  FCertFile := ACertFile;
  FKeyFile := AKeyFile;
  FSocket := TTCPBlockSocket.Create;
end;

destructor THTTPSServer.Destroy;
begin
  FSocket.Free;
  inherited;
end;

procedure THTTPSServer.Run;
var
  ClientSocket: TSocket;
  SSL: TSSLBlockSocket;
  Request, Response: string;
begin
  FSocket.CreateSocket;
  FSocket.SetLinger(True, 10);
  FSocket.Bind('0.0.0.0', FPort);
  FSocket.Listen;

  WriteLn('Serveur HTTPS d√©marr√© sur le port ', FPort);
  WriteLn('Utilisez: https://localhost:', FPort);
  WriteLn('Appuyez sur Ctrl+C pour arr√™ter');
  WriteLn;

  while True do
  begin
    if FSocket.CanRead(1000) then
    begin
      ClientSocket := FSocket.Accept;
      if ClientSocket <> INVALID_SOCKET then
      begin
        SSL := TSSLBlockSocket.Create;
        try
          SSL.Socket := ClientSocket;
          SSL.SSL.CertificateFile := FCertFile;
          SSL.SSL.PrivateKeyFile := FKeyFile;

          if SSL.SSLAcceptConnection then
          begin
            WriteLn('Client connect√© via SSL/TLS');

            // Lecture de la requ√™te
            Request := SSL.RecvString(5000);
            WriteLn('Requ√™te: ', Copy(Request, 1, 50), '...');

            // R√©ponse simple
            Response :=
              'HTTP/1.1 200 OK'#13#10 +
              'Content-Type: text/html'#13#10 +
              'Connection: close'#13#10 +
              #13#10 +
              '<html><body><h1>Serveur HTTPS avec Synapse</h1>' +
              '<p>Connexion s√©curis√©e √©tablie !</p></body></html>';

            SSL.SendString(Response);
          end
          else
            WriteLn('Erreur SSL handshake');

        finally
          SSL.Free;
        end;
      end;
    end;
  end;
end;

var
  Server: THTTPSServer;

begin
  if ParamCount < 2 then
  begin
    WriteLn('Usage: SimpleHTTPSServer <cert.pem> <key.pem>');
    WriteLn('Exemple: SimpleHTTPSServer cert.pem key.pem');
    Halt(1);
  end;

  Server := THTTPSServer.Create('8443', ParamStr(1), ParamStr(2));
  try
    Server.Run;
  finally
    Server.Free;
  end;
end.
```

**Utilisation :**

```bash
# Compilation
fpc SimpleHTTPSServer.pas

# G√©n√©rer les certificats si n√©cessaire
openssl req -x509 -newkey rsa:2048 \
  -keyout key.pem -out cert.pem \
  -days 365 -nodes \
  -subj "/CN=localhost"

# Lancer le serveur
./SimpleHTTPSServer cert.pem key.pem

# Tester (dans un autre terminal)
curl -k https://localhost:8443
```

## Tests et d√©bogage

### Test de connexion SSL

```bash
# Test de connexion √† un serveur HTTPS
openssl s_client -connect google.com:443

# Afficher le certificat
openssl s_client -connect google.com:443 -showcerts

# Tester avec une version SSL/TLS sp√©cifique
openssl s_client -connect google.com:443 -tls1_2

# Test de votre serveur local
openssl s_client -connect localhost:8443 -showcerts
```

### V√©rifier un certificat

```bash
# Afficher le contenu d'un certificat
openssl x509 -in cert.pem -text -noout

# V√©rifier les dates de validit√©
openssl x509 -in cert.pem -noout -dates

# V√©rifier le Subject et Issuer
openssl x509 -in cert.pem -noout -subject -issuer

# V√©rifier la cl√© publique
openssl x509 -in cert.pem -noout -pubkey

# V√©rifier que la cl√© priv√©e correspond au certificat
openssl x509 -noout -modulus -in cert.pem | openssl md5
openssl rsa -noout -modulus -in key.pem | openssl md5
# Les deux MD5 doivent √™tre identiques
```

### Programme de diagnostic

```pascal
program DiagnosticSSL;

{$mode objfpc}{$H+}

uses
  SysUtils, ssl_openssl_lib;

procedure TestOpenSSLLibrary;
begin
  WriteLn('=== Diagnostic OpenSSL ===');
  WriteLn;

  WriteLn('Tentative de chargement de la biblioth√®que OpenSSL...');

  if InitSSLInterface then
  begin
    WriteLn('‚úì Biblioth√®que OpenSSL charg√©e avec succ√®s');
    WriteLn;

    WriteLn('Version: ', SSLLibraryVersion);
    WriteLn('Fichier libssl: ', SSLLibFile);
    WriteLn('Fichier libcrypto: ', SSLUtilFile);
    WriteLn;

    WriteLn('Algorithmes disponibles:');
    WriteLn('  - TLS 1.2: Support√©');
    WriteLn('  - TLS 1.3: ', IfThen(Pos('3.', SSLLibraryVersion) > 0, 'Support√©', 'Non support√©'));
  end
  else
  begin
    WriteLn('‚úó Impossible de charger OpenSSL');
    WriteLn('V√©rifiez que libssl est install√©:');
    WriteLn('  sudo apt install libssl-dev');
  end;

  WriteLn;
end;

begin
  TestOpenSSLLibrary;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

## R√©solution de probl√®mes

### Erreur : "libssl.so.3: cannot open shared object file"

**Cause** : Biblioth√®que OpenSSL non trouv√©e

**Solutions :**

```bash
# 1. Installer OpenSSL
sudo apt install libssl3

# 2. V√©rifier si la biblioth√®que existe
ls -l /usr/lib/x86_64-linux-gnu/libssl.so.*

# 3. Mettre √† jour le cache des biblioth√®ques
sudo ldconfig

# 4. V√©rifier les chemins de recherche
ldconfig -p | grep ssl
```

### Erreur : "version `OPENSSL_3.0.0' not found"

**Cause** : Conflit de versions

**Solutions :**

```bash
# 1. V√©rifier la version install√©e
openssl version

# 2. Mettre √† jour OpenSSL
sudo apt update
sudo apt upgrade openssl libssl3

# 3. Si probl√®me persiste, recompiler l'application
fpc -B MonProgramme.pas
```

### Erreur : "SSL_CTX_use_certificate_file"

**Cause** : Certificat introuvable ou invalide

**Solutions :**

```bash
# V√©rifier que le fichier existe
ls -l cert.pem

# V√©rifier les permissions
chmod 644 cert.pem
chmod 600 key.pem

# V√©rifier la validit√© du certificat
openssl x509 -in cert.pem -text -noout

# V√©rifier le format (doit √™tre PEM)
head -1 cert.pem
# Doit afficher: -----BEGIN CERTIFICATE-----
```

### Erreur : "certificate verify failed"

**Cause** : Certificat non valid√© par une autorit√© de confiance

**Solutions :**

```pascal
// Pour le d√©veloppement uniquement :
// D√©sactiver la v√©rification (NON recommand√© en production)
HTTP.Sock.SSL.SSLCheck := False;

// Ou sp√©cifier le bundle de certificats
HTTP.Sock.SSL.CertCAFile := '/etc/ssl/certs/ca-certificates.crt';

// Ou ajouter votre CA personnalis√©
sudo cp mon-ca.crt /usr/local/share/ca-certificates/
sudo update-ca-certificates
```

## Variables d'environnement

### Configuration OpenSSL via l'environnement

```bash
# Chemin des certificats
export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
export SSL_CERT_DIR=/etc/ssl/certs/

# Configuration OpenSSL
export OPENSSL_CONF=/etc/ssl/openssl.cnf

# Niveau de d√©bogage (0-3)
export OPENSSL_DEBUG=1
```

Dans votre code FreePascal :

```pascal
uses
  Unix;

begin
  // D√©finir les variables d'environnement
  fpSetEnv('SSL_CERT_FILE', '/etc/ssl/certs/ca-certificates.crt');
  fpSetEnv('SSL_CERT_DIR', '/etc/ssl/certs/');

  // Votre code SSL...
end.
```

## Bonnes pratiques Ubuntu

### Checklist de s√©curit√©

‚úÖ **Installation**
- Utiliser les paquets officiels Ubuntu
- Activer les mises √† jour automatiques de s√©curit√©
- Installer `libssl-dev` pour le d√©veloppement

‚úÖ **Certificats**
- Utiliser le bundle syst√®me `/etc/ssl/certs/ca-certificates.crt`
- Mettre √† jour r√©guli√®rement : `sudo update-ca-certificates`
- Permissions strictes sur les cl√©s priv√©es (`chmod 600`)

‚úÖ **Configuration**
- Activer uniquement TLS 1.2 et 1.3
- Utiliser des cipher suites modernes
- Valider tous les certificats en production

‚úÖ **D√©ploiement**
- Documenter la version d'OpenSSL requise
- Tester sur une machine propre
- Utiliser des chemins absolus pour les certificats

### Script d'installation automatique

Cr√©ez `install-openssl-dev.sh` :

```bash
#!/bin/bash

echo "=== Installation OpenSSL pour FreePascal/Lazarus ==="
echo

# Mise √† jour des paquets
echo "Mise √† jour de la liste des paquets..."
sudo apt update

# Installation
echo "Installation d'OpenSSL et des outils de d√©veloppement..."
sudo apt install -y \
  openssl \
  libssl-dev \
  ca-certificates \
  build-essential

# V√©rification
echo
echo "=== V√©rification ==="
echo "Version d'OpenSSL:"
openssl version

echo
echo "Biblioth√®ques install√©es:"
ldconfig -p | grep ssl | head -5

echo
echo "Certificats racine:"
ls /etc/ssl/certs/ca-certificates.crt

echo
echo "‚úì Installation termin√©e !"
echo
echo "Pour tester, compilez et ex√©cutez un programme FreePascal avec SSL"
```

**Utilisation :**

```bash
chmod +x install-openssl-dev.sh
./install-openssl-dev.sh
```

## Mise √† jour d'OpenSSL

### Mises √† jour de s√©curit√©

Ubuntu g√®re automatiquement les mises √† jour de s√©curit√© :

```bash
# Activer les mises √† jour automatiques
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades

# V√©rifier les mises √† jour disponibles
sudo apt update
apt list --upgradable | grep ssl

# Appliquer les mises √† jour
sudo apt upgrade libssl3
```

### Migration vers une nouvelle version

Si vous devez migrer (par exemple de 1.1.1 vers 3.0) :

```bash
# 1. Sauvegarder la configuration actuelle
sudo cp -r /etc/ssl /etc/ssl.backup

# 2. Mettre √† jour
sudo apt update
sudo apt full-upgrade

# 3. V√©rifier la nouvelle version
openssl version

# 4. Recompiler vos applications
cd /chemin/vers/projet
lazbuild --build-all MonProjet.lpi

# 5. Tester
./MonProjet
```

## R√©sum√©

### Points cl√©s √† retenir

‚úÖ **OpenSSL sur Ubuntu** est g√©n√©ralement d√©j√† install√©  
‚úÖ **Biblioth√®ques** : `libssl.so.3` et `libcrypto.so.3` (OpenSSL 3.x)  
‚úÖ **Installation** : `sudo apt install libssl-dev` pour le d√©veloppement  
‚úÖ **Certificats** : `/etc/ssl/certs/ca-certificates.crt`  
‚úÖ **G√©n√©ration** : `openssl req -x509 -newkey rsa:4096...`  
‚úÖ **Tests** : `openssl s_client -connect host:443`

### Commandes essentielles

```bash
# V√©rifier l'installation
openssl version
ldconfig -p | grep ssl

# Installer pour le d√©veloppement
sudo apt install libssl-dev

# Mettre √† jour les certificats
sudo update-ca-certificates

# G√©n√©rer un certificat de test
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# Tester une connexion SSL
openssl s_client -connect google.com:443
```

### Diff√©rences principales Windows vs Ubuntu

| Aspect | Ubuntu | Windows |
|--------|--------|---------|
| **Biblioth√®ques** | `.so` (libssl.so.3) | `.dll` (libssl-3.dll) |
| **Installation** | `apt install libssl-dev` | T√©l√©chargement manuel |
| **Emplacement** | `/usr/lib/x86_64-linux-gnu/` | Dossier application ou System32 |
| **Certificats** | `/etc/ssl/certs/` | Windows Certificate Store |
| **Mise √† jour** | `apt upgrade` | Manuelle |
| **Distribution** | Inclus dans le syst√®me | √Ä fournir avec l'application |

### Ressources

#### Documentation officielle
- **Site OpenSSL** : https://www.openssl.org/
- **Documentation OpenSSL** : https://www.openssl.org/docs/
- **Ubuntu OpenSSL Guide** : https://help.ubuntu.com/community/OpenSSL
- **Ubuntu Security** : https://ubuntu.com/security

#### Biblioth√®ques FreePascal/Lazarus
- **Synapse** : http://www.ararat.cz/synapse/
  - Biblioth√®que r√©seau compl√®te avec support SSL/TLS
  - Installation facile via Online Package Manager
  - Documentation et exemples disponibles

- **Indy (Internet Direct)** : https://www.indyproject.org/
  - Framework r√©seau complet
  - Support SSL/TLS via OpenSSL
  - Compatible FreePascal/Lazarus

- **lNet** : https://github.com/almindor/lnet
  - Biblioth√®que r√©seau l√©g√®re
  - Support SSL optionnel
  - Alternative √† Synapse et Indy

#### Communaut√© et support
- **Forum Lazarus** : https://forum.lazarus.freepascal.org/
  - Section "Networking and Web Programming"
  - Nombreux exemples SSL/TLS
  - Aide de la communaut√©

- **Wiki FreePascal** : https://wiki.freepascal.org/
  - Tutoriels r√©seau et SSL
  - Exemples de code
  - Guides d'installation

- **Stack Overflow** : https://stackoverflow.com/
  - Tags : `freepascal`, `lazarus`, `openssl`
  - Questions/r√©ponses techniques

#### S√©curit√© et bonnes pratiques
- **SSL Labs** : https://www.ssllabs.com/
  - Tester la configuration SSL d'un serveur
  - V√©rifier la s√©curit√© des certificats
  - Guide des meilleures pratiques

- **Mozilla SSL Configuration Generator** : https://ssl-config.mozilla.org/
  - Configurations SSL recommand√©es
  - Param√®tres s√©curis√©s par d√©faut

- **OWASP TLS Cheat Sheet** : https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html
  - Guide de s√©curit√© TLS/SSL
  - Recommandations actualis√©es

#### Outils utiles
- **OpenSSL Cookbook** : https://www.feistyduck.com/books/openssl-cookbook/
  - Guide pratique OpenSSL
  - Exemples de commandes
  - R√©solution de probl√®mes

- **Testssl.sh** : https://testssl.sh/
  - Script de test SSL/TLS
  - Installation : `sudo apt install testssl.sh`
  - Analyse compl√®te de configuration

### Aide-m√©moire rapide

#### Installation compl√®te en une commande

```bash
sudo apt update && sudo apt install -y openssl libssl-dev ca-certificates build-essential
```

#### Cr√©er un environnement de test SSL complet

```bash
#!/bin/bash
# Script de configuration SSL pour d√©veloppement

# Cr√©er un r√©pertoire de travail
mkdir -p ~/ssl-test && cd ~/ssl-test

# G√©n√©rer certificat et cl√©
openssl req -x509 -newkey rsa:2048 \
  -keyout server.key \
  -out server.crt \
  -days 365 \
  -nodes \
  -subj "/C=FR/ST=IDF/L=Paris/O=Dev/CN=localhost"

# Permissions
chmod 600 server.key
chmod 644 server.crt

# V√©rifier
openssl x509 -in server.crt -text -noout | grep -E "(Subject:|Not Before|Not After)"

echo "‚úì Certificats cr√©√©s dans ~/ssl-test/"
```

#### Programme de test minimal

Cr√©ez `test_ssl_minimal.pas` :

```pascal
program TestSSLMinimal;

{$mode objfpc}{$H+}

uses
  SysUtils, httpsend, ssl_openssl;

var
  HTTP: THTTPSend;
begin
  HTTP := THTTPSend.Create;
  try
    if HTTP.HTTPMethod('GET', 'https://www.google.com') then
      WriteLn('‚úì SSL fonctionne correctement')
    else
      WriteLn('‚úó Erreur SSL');
  finally
    HTTP.Free;
  end;
end.
```

Compilation et test :

```bash
fpc test_ssl_minimal.pas && ./test_ssl_minimal
```

### FAQ (Foire Aux Questions)

**Q1 : Quelle version d'OpenSSL dois-je utiliser ?**
R : Utilisez la version fournie par Ubuntu (3.x pour Ubuntu 22.04+). C'est la plus stable et s√©curis√©e pour votre syst√®me.

**Q2 : Puis-je avoir plusieurs versions d'OpenSSL en m√™me temps ?**
R : Oui, Ubuntu peut avoir 1.1.1 et 3.x simultan√©ment. Les applications choisissent automatiquement la bonne version via les liens symboliques.

**Q3 : Comment savoir quelle version utilise mon application ?**
R : Utilisez le programme de diagnostic fourni dans la section "Tests et d√©bogage" ou ajoutez `WriteLn(SSLLibraryVersion)` dans votre code.

**Q4 : Dois-je distribuer OpenSSL avec mon application ?**
R : Non sur Ubuntu ! OpenSSL fait partie du syst√®me. Documentez simplement la version minimale requise.

**Q5 : Comment g√©rer les certificats auto-sign√©s en d√©veloppement ?**
R : D√©sactivez temporairement la v√©rification avec `HTTP.Sock.SSL.SSLCheck := False`, mais **JAMAIS en production**.

**Q6 : OpenSSL 3.x est-il compatible avec mon ancien code 1.1.1 ?**
R : G√©n√©ralement oui, l'API est r√©trocompatible. Recompilez votre application et testez.

**Q7 : Comment d√©boguer les erreurs SSL ?**
R : Utilisez `openssl s_client` en ligne de commande pour isoler le probl√®me avant de d√©boguer votre code FreePascal.

**Q8 : Puis-je utiliser Let's Encrypt avec FreePascal ?**
R : Oui ! Les certificats Let's Encrypt sont des certificats standard. Installez-les via certbot et utilisez-les comme n'importe quel certificat.

**Q9 : Comment forcer TLS 1.3 uniquement ?**
R : Avec Synapse : `HTTP.Sock.SSL.SSLType := LT_TLSv1_3;` (n√©cessite OpenSSL 3.x)

**Q10 : O√π trouver de l'aide si j'ai un probl√®me ?**
R : Forum Lazarus, Stack Overflow (tag freepascal), ou la documentation Synapse/Indy.

### Checklist de d√©ploiement

Avant de d√©ployer votre application SSL/TLS sur Ubuntu :

- [ ] **Version d'OpenSSL document√©e** dans README ou INSTALL
- [ ] **D√©pendances list√©es** : `openssl`, `libssl3`, `ca-certificates`
- [ ] **Application test√©e** sur Ubuntu propre (VM ou conteneur)
- [ ] **Certificats de production** configur√©s et valides
- [ ] **Validation des certificats activ√©e** (pas de `SSLCheck := False`)
- [ ] **Versions TLS minimales** : TLS 1.2 ou 1.3 uniquement
- [ ] **Chemins des certificats** en absolu, pas relatif
- [ ] **Permissions des fichiers** : cl√©s priv√©es en 600, certificats en 644
- [ ] **Logs d'erreurs SSL** configur√©s pour d√©bogage
- [ ] **Plan de mise √† jour** pour renouvellement des certificats
- [ ] **Tests de charge** effectu√©s avec connexions SSL
- [ ] **Documentation utilisateur** incluant configuration SSL

### Prochaines √©tapes

Maintenant que vous ma√Ætrisez OpenSSL sur Ubuntu, vous pouvez :

1. **D√©velopper des clients HTTPS** s√©curis√©s
2. **Cr√©er des serveurs web HTTPS** avec Synapse ou Indy
3. **Impl√©menter des API REST** avec authentification SSL
4. **Configurer des connexions base de donn√©es** chiffr√©es (PostgreSQL, MySQL)
5. **D√©velopper des applications IoT** avec MQTT over SSL
6. **Cr√©er des microservices** communiquant en HTTPS

### Pour aller plus loin

Explorez les sections suivantes du tutoriel :

- **10.5.1 OpenSSL sur Windows** : Configuration sur l'autre plateforme
- **10.6 Clients et serveurs WebSocket** : WebSocket s√©curis√© (WSS)
- **17. S√©curit√© et Cryptographie** : Utilisation avanc√©e d'OpenSSL
- **22. DevOps et D√©ploiement** : Automatisation avec Docker et CI/CD

### Contribution et retours

Ce tutoriel est un document vivant. N'h√©sitez pas √† :
- Signaler les erreurs ou impr√©cisions
- Proposer des am√©liorations
- Partager vos cas d'usage
- Contribuer des exemples additionnels

---

## Conclusion

OpenSSL sur Ubuntu offre une solution robuste, bien int√©gr√©e et facile √† maintenir pour s√©curiser vos applications FreePascal/Lazarus. Gr√¢ce √† la gestion par paquets d'Ubuntu, vous b√©n√©ficiez automatiquement des mises √† jour de s√©curit√© sans intervention manuelle.

Les points essentiels √† retenir :
- OpenSSL est d√©j√† pr√©sent sur Ubuntu
- L'installation de `libssl-dev` suffit pour le d√©veloppement
- Les certificats syst√®me sont g√©r√©s automatiquement
- La biblioth√®que Synapse simplifie grandement l'utilisation d'OpenSSL
- Les bonnes pratiques de s√©curit√© sont indispensables en production

Avec ces connaissances, vous √™tes maintenant capable de d√©velopper des applications r√©seau s√©curis√©es et professionnelles sur Ubuntu avec FreePascal/Lazarus.

Bon d√©veloppement ! üöÄ


‚è≠Ô∏è [Clients et serveurs WebSocket](/10-programmation-reseau-avancee/06-clients-serveurs-websocket.md)
